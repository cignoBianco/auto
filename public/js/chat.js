
window.imbaChatLangJson = {"name":"IMBA chat","description":"","contact_bot_name":"\u0420\u043e\u0431\u043e\u0442 \u0443\u0432\u0435\u0434\u043e\u043c\u043b\u0435\u043d\u0438\u0439","autores_support_online":"\u0417\u0434\u0440\u0430\u0432\u0441\u0442\u0432\u0443\u0439\u0442\u0435! \u041c\u0435\u043d\u0435\u0434\u0436\u0435\u0440 \u043e\u0442\u0432\u0435\u0442\u0438\u0442 \u0432\u0430\u043c \u0432 \u0442\u0435\u0447\u0435\u043d\u0438\u0435 5 \u043c\u0438\u043d\u0443\u0442. \u0415\u0441\u043b\u0438 \u043e\u0442\u0432\u0435\u0442 \u043d\u0435 \u043f\u043e\u0441\u0442\u0443\u043f\u0438\u043b, \u043f\u0440\u043e\u0441\u0438\u043c \u0432\u0430\u0441 \u0432\u044b\u0440\u0430\u0437\u0438\u0442\u044c \u0441\u0432\u043e\u0451 \u0432\u043e\u0437\u043c\u0443\u0449\u0435\u043d\u0438\u0435 \u043f\u043e \u0442\u0435\u043b\u0435\u0444\u043e\u043d\u0443 8-800-700-41-91","autores_support_offline":"\u0417\u0434\u0440\u0430\u0432\u0441\u0442\u0432\u0443\u0439\u0442\u0435! \u0412 \u043d\u0430\u0441\u0442\u043e\u044f\u0449\u0435\u0435 \u0432\u0440\u0435\u043c\u044f \u043c\u044b \u043d\u0435 \u043c\u043e\u0436\u0435\u043c \u043e\u0442\u0432\u0435\u0442\u0438\u0442\u044c \u043d\u0430 \u0432\u0430\u0448 \u0432\u043e\u043f\u0440\u043e\u0441, \u043e\u0436\u0438\u0434\u0430\u0439\u0442\u0435 \u043e\u0442\u0432\u0435\u0442 \u0441 05.00 \u0434\u043e 6.00 (\u041c\u0421\u041a) \u0432 \u0440\u0430\u0431\u043e\u0447\u0438\u0435 \u0434\u043d\u0438 \u0438\u043b\u0438 \u0441 08.00 \u0434\u043e 09.00 (\u041c\u0421\u041a) \u0432 \u0432\u044b\u0445\u043e\u0434\u043d\u044b\u0435 \u0434\u043d\u0438. \u0422\u0430\u043a\u0436\u0435, \u0432\u044b \u043c\u043e\u0436\u0435\u0442\u0435 \u043e\u0441\u0442\u0430\u0432\u0438\u0442\u044c \u043d\u043e\u043c\u0435\u0440 \u0442\u0435\u043b\u0435\u0444\u043e\u043d\u0430 \u0438 \u0443\u043a\u0430\u0437\u0430\u0442\u044c \u0443\u0434\u043e\u0431\u043d\u043e\u0435 \u0432\u0440\u0435\u043c\u044f \u0434\u043b\u044f \u0437\u0432\u043e\u043d\u043a\u0430 \u043e\u0442 \u0441\u043b\u0443\u0436\u0431\u044b \u043f\u043e\u0434\u0434\u0435\u0440\u0436\u043a\u0438. \u0411\u043b\u0430\u0433\u043e\u0434\u0430\u0440\u0438\u043c \u0437\u0430 \u0432\u0430\u0448\u0435 \u043e\u0431\u0440\u0430\u0449\u0435\u043d\u0438\u0435.","autores_helper_online":"\u0417\u0434\u0440\u0430\u0432\u0441\u0442\u0432\u0443\u0439\u0442\u0435! \u041c\u0435\u043d\u0435\u0434\u0436\u0435\u0440 \u043e\u0442\u0432\u0435\u0442\u0438\u0442 \u0432\u0430\u043c \u0432 \u0442\u0435\u0447\u0435\u043d\u0438\u0435 5 \u043c\u0438\u043d\u0443\u0442. \u0415\u0441\u043b\u0438 \u043e\u0442\u0432\u0435\u0442 \u043d\u0435 \u043f\u043e\u0441\u0442\u0443\u043f\u0438\u043b, \u043f\u0440\u043e\u0441\u0438\u043c \u0432\u0430\u0441 \u0432\u044b\u0440\u0430\u0437\u0438\u0442\u044c \u0441\u0432\u043e\u0451 \u0432\u043e\u0437\u043c\u0443\u0449\u0435\u043d\u0438\u0435 \u043f\u043e \u0442\u0435\u043b\u0435\u0444\u043e\u043d\u0443 8-800-700-41-91","autores_helper_offline":"\u0417\u0434\u0440\u0430\u0432\u0441\u0442\u0432\u0443\u0439\u0442\u0435! \u0412 \u043d\u0430\u0441\u0442\u043e\u044f\u0449\u0435\u0435 \u0432\u0440\u0435\u043c\u044f \u043c\u044b \u043d\u0435 \u043c\u043e\u0436\u0435\u043c \u043e\u0442\u0432\u0435\u0442\u0438\u0442\u044c \u043d\u0430 \u0432\u0430\u0448 \u0432\u043e\u043f\u0440\u043e\u0441, \u043e\u0436\u0438\u0434\u0430\u0439\u0442\u0435 \u043e\u0442\u0432\u0435\u0442 \u0441 05.00 \u0434\u043e 6.00 (\u041c\u0421\u041a) \u0432 \u0440\u0430\u0431\u043e\u0447\u0438\u0435 \u0434\u043d\u0438 \u0438\u043b\u0438 \u0441 08.00 \u0434\u043e 09.00 (\u041c\u0421\u041a) \u0432 \u0432\u044b\u0445\u043e\u0434\u043d\u044b\u0435 \u0434\u043d\u0438. \u0422\u0430\u043a\u0436\u0435, \u0432\u044b \u043c\u043e\u0436\u0435\u0442\u0435 \u043e\u0441\u0442\u0430\u0432\u0438\u0442\u044c \u043d\u043e\u043c\u0435\u0440 \u0442\u0435\u043b\u0435\u0444\u043e\u043d\u0430 \u0438 \u0443\u043a\u0430\u0437\u0430\u0442\u044c \u0443\u0434\u043e\u0431\u043d\u043e\u0435 \u0432\u0440\u0435\u043c\u044f \u0434\u043b\u044f \u0437\u0432\u043e\u043d\u043a\u0430 \u043e\u0442 \u0441\u043b\u0443\u0436\u0431\u044b \u043f\u043e\u0434\u0434\u0435\u0440\u0436\u043a\u0438. \u0411\u043b\u0430\u0433\u043e\u0434\u0430\u0440\u0438\u043c \u0437\u0430 \u0432\u0430\u0448\u0435 \u043e\u0431\u0440\u0430\u0449\u0435\u043d\u0438\u0435.","timeout_notification":"@all \u041f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c %1s (%2s) \u043e\u0436\u0438\u0434\u0430\u0435\u0442 \u043e\u0442\u0432\u0435\u0442\u0430 \u0441\u043b\u0438\u0448\u043a\u043e\u043c \u0434\u043e\u043b\u0433\u043e. \u041a\u043e\u043c\u043d\u0430\u0442\u0430 %3s <https:\/\/chat.gisauto.ru\/imbasupport\/v1\/login|\u0412\u043e\u0439\u0442\u0438 \u0432 \u0430\u0434\u043c\u0438\u043d\u043a\u0443>\n \u0422\u0435\u043a\u0441\u0442 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f: ```%4s```","chat_user_deleted":"\u041f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u0443\u0434\u0430\u043b\u0451\u043d","chat_development":"\u0427\u0430\u0442 \u043d\u0430 \u0440\u0435\u043a\u043e\u043d\u0441\u0442\u0440\u0443\u043a\u0446\u0438\u0438, \u0440\u0430\u0431\u043e\u0442\u0430 \u0447\u0430\u0442\u0430 \u0441\u043a\u043e\u0440\u043e \u0431\u0443\u0434\u0435\u0442 \u0432\u043e\u0437\u043e\u0431\u043d\u043e\u0432\u043b\u0435\u043d\u0430","attach_content":"\u0412\u044b\u0431\u0435\u0440\u0438\u0442\u0435 \u0432\u043b\u043e\u0436\u0435\u043d\u0438\u0435","attach_pictures":"\u041e\u0442\u043f\u0440\u0430\u0432\u0438\u0442\u044c \u0444\u0430\u0439\u043b\u044b","attach_location":"\u041e\u0442\u043f\u0440\u0430\u0432\u0438\u0442\u044c \u043c\u0435\u0441\u0442\u043e\u043f\u043e\u043b\u043e\u0436\u0435\u043d\u0438\u0435","user_typing_message":"\u041f\u0438\u0448\u0435\u0442 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435...","user_no_info":"\u041d\u0435\u0442 \u0438\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u0438","user_read":"\u041f\u0440\u043e\u0447\u0438\u0442\u0430\u043d\u043e","user_dialog_not_selected":"\u0414\u0438\u0430\u043b\u043e\u0433 \u043d\u0435 \u0432\u044b\u0431\u0440\u0430\u043d","user_find_by_name":"\u041f\u043e\u0438\u0441\u043a \u043f\u043e \u0438\u043c\u0435\u043d\u0438 \u0441\u043e\u0431\u0435\u0441\u0435\u0434\u043d\u0438\u043a\u0430","user_delete_dialog":"\u0423\u0434\u0430\u043b\u0438\u0442\u044c \u043f\u0435\u0440\u0435\u043f\u0438\u0441\u043a\u0443","user_delete_dialog_confirm":"\u0423\u0434\u0430\u043b\u0438\u0442\u044c \u0434\u0438\u0430\u043b\u043e\u0433?","user_last_seen":"\u0411\u044b\u043b \u0432 \u0441\u0435\u0442\u0438:","user_chat_name":"\u041d\u0430\u0437\u0432\u0430\u043d\u0438\u0435 \u0431\u0435\u0441\u0435\u0434\u044b","user_you":"\u0412\u044b","user_you_created":"\u0412\u044b \u0441\u043e\u0437\u0434\u0430\u043b\u0438 \u0434\u0438\u0430\u043b\u043e\u0433","user_messages_here":"\u0412\u0430\u0448\u0438 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f \u0431\u0443\u0434\u0443\u0442 \u043e\u0442\u043e\u0431\u0440\u0430\u0436\u0430\u0442\u044c\u0441\u044f \u0437\u0434\u0435\u0441\u044c","user_contacts_here":"\u0412\u0430\u0448\u0438 \u043a\u043e\u043d\u0442\u0430\u043a\u0442\u044b \u0431\u0443\u0434\u0443\u0442 \u043e\u0442\u043e\u0431\u0440\u0430\u0436\u0430\u0442\u044c\u0441\u044f \u0437\u0434\u0435\u0441\u044c","user_your_message":"\u0412\u0430\u0448\u0435 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435...","user_online":"\u041e\u043d\u043b\u0430\u0439\u043d","user_participants":"\u0423\u0447\u0430\u0441\u0442\u043d\u0438\u043a\u0438","user_error":"\u041e\u0448\u0438\u0431\u043a\u0430","user_removed":"\u041f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u0443\u0434\u0430\u043b\u0451\u043d","user_blocked":"\u041f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u0437\u0430\u0431\u043b\u043e\u043a\u0438\u0440\u043e\u0432\u0430\u043d","user_unblock":"\u0420\u0430\u0437\u0431\u043b\u043e\u043a\u0438\u0440\u0443\u0439\u0442\u0435 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f, \u0447\u0442\u043e\u0431\u044b \u043d\u0430\u043f\u0438\u0441\u0430\u0442\u044c \u0435\u043c\u0443 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435","block_user":"\u0417\u0430\u0431\u043b\u043e\u043a\u0438\u0440\u043e\u0432\u0430\u0442\u044c","unblock_user":"\u0420\u0430\u0437\u0431\u043b\u043e\u043a\u0438\u0440\u043e\u0432\u0430\u0442\u044c","rec_cancel":"\u041e\u0442\u043c\u0435\u043d\u0438\u0442\u044c","rec_stop":"\u041e\u0441\u0442\u0430\u043d\u043e\u0432\u0438\u0442\u044c","rec_recording":"\u0418\u0434\u0451\u0442 \u0437\u0430\u043f\u0438\u0441\u044c...","file":"\u0424\u0430\u0439\u043b","file_not_supported":"\u0414\u0430\u043d\u043d\u044b\u0439 \u0442\u0438\u043f \u0444\u0430\u0439\u043b\u0430 \u043d\u0435 \u043f\u043e\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442\u0441\u044f","file_size":"\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u0431\u043e\u043b\u044c\u0448\u043e\u0439 \u0440\u0430\u0437\u043c\u0435\u0440 \u0444\u0430\u0439\u043b\u0430","geo_my_position":"\u041c\u043e\u0451 \u043c\u0435\u0441\u0442\u043e\u043f\u043e\u043b\u043e\u0436\u0435\u043d\u0438\u0435","geo_latitude":"\u0428\u0438\u0440\u043e\u0442\u0430","geo_longitude":"\u0414\u043e\u043b\u0433\u043e\u0442\u0430","geo_map":"\u041f\u043e\u043a\u0430\u0437\u0430\u0442\u044c \u043d\u0430 \u043a\u0430\u0440\u0442\u0435","geo_no_permission":"\u041d\u0435\u0442 \u0440\u0430\u0437\u0440\u0435\u0448\u0435\u043d\u0438\u044f \u043d\u0430 \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u043c\u0435\u0441\u0442\u043e\u043f\u043e\u043b\u043e\u0436\u0435\u043d\u0438\u044f","geo_denied":"\u0420\u0430\u0437\u0440\u0435\u0448\u0435\u043d\u0438\u0435 \u043d\u0430 \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u0433\u0435\u043e\u0434\u0430\u043d\u043d\u044b\u0445 \u043e\u0442\u043a\u043b\u043e\u043d\u0435\u043d\u043e","geo_disabled":"\u0412\u0435\u0440\u043e\u044f\u0442\u043d\u043e \u0443 \u0432\u0430\u0441 \u043d\u0435 \u0432\u043a\u043b\u044e\u0447\u0435\u043d\u043e \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0435\u043d\u0438\u0435 \u043c\u0435\u0441\u0442\u043e\u043f\u043e\u043b\u043e\u0436\u0435\u043d\u0438\u044f","geo_failed":"\u041e\u0448\u0438\u0431\u043a\u0430 \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0435\u043d\u0438\u044f \u043c\u0435\u0441\u0442\u043e\u043f\u043e\u043b\u043e\u0436\u0435\u043d\u0438\u044f","jan":"\u042f\u043d\u0432\u0430\u0440\u044c","feb":"\u0424\u0435\u0432\u0440\u0430\u043b\u044c","mar":"\u041c\u0430\u0440\u0442","apr":"\u0410\u043f\u0440\u0435\u043b\u044c","may":"\u041c\u0430\u0439","jun":"\u0418\u044e\u043d\u044c","jul":"\u0418\u044e\u043b\u044c","aug":"\u0410\u0432\u0433\u0443\u0441\u0442","sep":"\u0421\u0435\u043d\u0442\u044f\u0431\u0440\u044c","oct":"\u041e\u043a\u0442\u044f\u0431\u0440\u044c","nov":"\u041d\u043e\u044f\u0431\u0440\u044c","dec":"\u0414\u0435\u043a\u0430\u0431\u0440\u044c","yes":"\u0414\u0430","cancel":"\u041e\u0442\u043c\u0435\u043d\u0430","yesterday":"\u0412\u0447\u0435\u0440\u0430","was_today":"\u0411\u044b\u043b \u0432 \u0441\u0435\u0442\u0438 \u0441\u0435\u0433\u043e\u0434\u043d\u044f","was_yesterday":"\u0411\u044b\u043b \u0432 \u0441\u0435\u0442\u0438 \u0432\u0447\u0435\u0440\u0430","was_date":"\u0411\u044b\u043b \u0432 \u0441\u0435\u0442\u0438 %1s \u0432 %2s","long_ago":"\u0434\u0430\u0432\u043d\u043e","send_image":"\u0418\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u0435","send_file":"\u0424\u0430\u0439\u043b","send_geopoint":"\u0413\u0435\u043e\u043f\u043e\u0437\u0438\u0446\u0438\u044f","send_video":"\u0412\u0438\u0434\u0435\u043e\u0444\u0430\u0439\u043b","send_link":"\u0421\u0441\u044b\u043b\u043a\u0430","send_voice_msg":"\u0413\u043e\u043b\u043e\u0441\u043e\u0432\u043e\u0435 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435","send_video_msg":"\u0412\u0438\u0434\u0435\u043e\u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435","conf_user_left":"\u041f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u043f\u043e\u043a\u0438\u043d\u0443\u043b \u0431\u0435\u0441\u0435\u0434\u0443","conf_user_joined":"\u041f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u043f\u0440\u0438\u0441\u043e\u0435\u0434\u0438\u043d\u0438\u043b\u0441\u044f \u043a \u0431\u0435\u0441\u0435\u0434\u0435","conf_you_created":"\u0412\u044b \u0441\u043e\u0437\u0434\u0430\u043b\u0438 \u0431\u0435\u0441\u0435\u0434\u0443","conf_created_dialog":"","conf_wanted_to_write":"%1s \u0445\u043e\u0442\u0435\u043b \u043d\u0430\u043f\u0438\u0441\u0430\u0442\u044c \u0432\u0430\u043c","conf_admin_changed":"\u0421\u043c\u0435\u043d\u0438\u043b\u0441\u044f \u0430\u0434\u043c\u0438\u043d\u0438\u0441\u0442\u0440\u0430\u0442\u043e\u0440","conf_renamed":"\u041f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c %1s \u0441\u043c\u0435\u043d\u0438\u043b \u043d\u0430\u0437\u0432\u0430\u043d\u0438\u0435 \u0431\u0435\u0441\u0435\u0434\u044b \u043d\u0430 %2s","conf_avatar":"\u0438 \u043f\u043e\u043c\u0435\u043d\u044f\u043b \u0430\u0432\u0430\u0442\u0430\u0440","conf_invited":"\u041f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c %1s \u043f\u0440\u0438\u0433\u043b\u0430\u0441\u0438\u043b \u0432 \u0431\u0435\u0441\u0435\u0434\u0443 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0435\u0439: (%2s)","conf_admin_rights":"\u041f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c %1s \u043f\u0435\u0440\u0435\u0434\u0430\u043b \u043f\u0440\u0430\u0432\u0430 \u0430\u0434\u043c\u0438\u043d\u0438\u0441\u0442\u0440\u0430\u0442\u043e\u0440\u0430 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044e %2s","call_started":"\u0417\u0432\u043e\u043d\u043e\u043a \u043d\u0430\u0447\u0430\u043b\u0441\u044f","call_ended":"\u0417\u0432\u043e\u043d\u043e\u043a \u0437\u0430\u043a\u043e\u043d\u0447\u0438\u043b\u0441\u044f","call_missed":"\u0417\u0432\u043e\u043d\u043e\u043a \u043f\u0440\u043e\u043f\u0443\u0449\u0435\u043d","call_busy":"\u0417\u0430\u043d\u044f\u0442\u043e","call_leave":"\u0421\u043e\u0431\u0435\u0441\u0435\u0434\u043d\u0438\u043a \u043e\u0442\u043a\u043b\u044e\u0447\u0438\u043b\u0441\u044f","no_dialogs_in_chat":"\u041d\u0435\u0442 \u0434\u0438\u0430\u043b\u043e\u0433\u043e\u0432 \u0432 \u0447\u0430\u0442\u0435","chat_right_column_stub_title":"\u0412\u0430\u0448\u0438 \u0440\u0430\u0437\u0433\u043e\u0432\u043e\u0440\u044b \u0431\u0443\u0434\u0443\u0442 \u043f\u043e\u043a\u0430\u0437\u0430\u043d\u044b \u0437\u0434\u0435\u0441\u044c","chat_right_column_stub_text":"\u041a\u0430\u043a \u0442\u043e\u043b\u044c\u043a\u043e \u0443 \u0432\u0430\u0441 \u0431\u0443\u0434\u0435\u0442 \u0445\u043e\u0442\u044f \u0431\u044b \u043e\u0434\u0438\u043d \u043a\u043e\u043d\u0442\u0430\u043a\u0442","new_chat_request":"\u041d\u043e\u0432\u043e\u0435 \u043f\u0440\u0438\u0433\u043b\u0430\u0448\u0435\u043d\u0438\u0435 \u0432 \u0447\u0430\u0442!","request_accept":"\u041f\u0440\u0438\u043d\u044f\u0442\u044c","request_refuse":"\u041e\u0442\u043a\u043b\u043e\u043d\u0438\u0442\u044c","you_have_rejected":"\u0412\u044b \u043e\u0442\u043a\u043b\u043e\u043d\u0438\u043b\u0438 \u043f\u0440\u0438\u0433\u043b\u0430\u0448\u0435\u043d\u0438\u0435","you_have_been_rejected":"\u0412\u0430\u0448\u0435 \u043f\u0440\u0438\u0433\u043b\u0430\u0448\u0435\u043d\u0438\u0435 \u0431\u044b\u043b\u043e \u043e\u0442\u043a\u043b\u043e\u043d\u0435\u043d\u043e","request_change":"\u041d\u043e \u0432\u044b \u0435\u0449\u0435 \u043c\u043e\u0436\u0435\u0442\u0435 \u043f\u0435\u0440\u0435\u0434\u0443\u043c\u0430\u0442\u044c","delete_chat":"\u0423\u0434\u0430\u043b\u0438\u0442\u044c","tp_offline_alert":"\u0412\u0440\u0435\u043c\u044f \u0440\u0430\u0431\u043e\u0442\u044b \u0441\u043f\u0435\u0446\u0438\u0430\u043b\u0438\u0441\u0442\u0430 \u0432 \u0431\u0443\u0434\u043d\u0438\u0435 \u0434\u043d\u0438 \u0441 5.00 \u0434\u043e 17.00 \u043f\u043e \u041c\u0441\u043a. \u041e\u0441\u0442\u0430\u0432\u044c\u0442\u0435 \u043e\u0431\u0440\u0430\u0449\u0435\u043d\u0438\u0435 \u0438 \u0443\u043a\u0430\u0436\u0438\u0442\u0435 \u0443\u0434\u043e\u0431\u043d\u044b\u0439 \u0441\u043f\u043e\u0441\u043e\u0431 \u0441\u0432\u044f\u0437\u0438, \u0435\u0441\u043b\u0438 \u0432\u044b \u043d\u0435 \u0430\u0432\u0442\u043e\u0440\u0438\u0437\u043e\u0432\u0430\u043d\u044b. \u0421\u043f\u0430\u0441\u0438\u0431\u043e.","user_offline_alert":"\u0421\u043e\u0431\u0435\u0441\u0435\u0434\u043d\u0438\u043a offline, \u043d\u043e \u043f\u043e\u043b\u0443\u0447\u0438\u0442 \u043f\u0438\u0441\u044c\u043c\u043e \u0441\u0440\u0430\u0437\u0443, \u043a\u0430\u043a \u0432\u044b \u043d\u0430\u043f\u0438\u0448\u0435\u0442\u0435 \u0435\u043c\u0443 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435","app_offline_alert":"\u0412\u0430\u0448\u0435 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435 \u0431\u0443\u0434\u0435\u0442 \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u043e \u0441\u0440\u0430\u0437\u0443, \u043a\u0430\u043a \u043f\u043e\u044f\u0432\u0438\u0442\u0441\u044f \u0434\u043e\u0441\u0442\u0443\u043f \u0432 \u0418\u043d\u0442\u0435\u0440\u043d\u0435\u0442","HELLO_FROM_SUPPORT":"\u0417\u0434\u0440\u0430\u0432\u0441\u0442\u0432\u0443\u0439\u0442\u0435! \u0412\u0430\u0441 \u043f\u0440\u0438\u0432\u0435\u0442\u0441\u0442\u0432\u0443\u0435\u0442 \u0442\u0435\u0445\u043d\u0438\u0447\u0435\u0441\u043a\u0430\u044f \u043f\u043e\u0434\u0434\u0435\u0440\u0436\u043a\u0430 GisAuto.ru. \u0415\u0441\u043b\u0438 \u0443 \u0432\u0430\u0441 \u0435\u0441\u0442\u044c \u0437\u0430\u0442\u0440\u0443\u0434\u043d\u0435\u043d\u0438\u044f \u0432 \u0440\u0430\u0431\u043e\u0442\u0435 \u0441 \u043d\u0430\u0448\u0438\u043c \u043f\u043e\u0440\u0442\u0430\u043b\u043e\u043c \u0438\u043b\u0438 \u0432\u044b \u043d\u0430\u0448\u043b\u0438 \u043e\u0448\u0438\u0431\u043a\u0443 - \u043d\u0430\u043f\u0438\u0448\u0438\u0442\u0435 \u043d\u0430\u043c \u043f\u0440\u044f\u043c\u043e \u0441\u044e\u0434\u0430, \u043c\u044b \u043e\u0431\u044f\u0437\u0430\u0442\u0435\u043b\u044c\u043d\u043e \u0432\u0430\u043c \u043f\u043e\u043c\u043e\u0436\u0435\u043c","ROOM_TYPE_GISAVTO_HELPER":" ","TITLE_FROM_SUPPORT":"\u041f\u043e\u0434\u0434\u0435\u0440\u0436\u043a\u0430","TITLE_FROM_GISAVTO_HELPER":"\u0421\u0435\u0440\u0432\u0438\u0441-\u043c\u0435\u043d\u0435\u0434\u0436\u0435\u0440","chat_request_not_accepted":"\u0417\u0430\u043f\u0440\u043e\u0441 \u043d\u0435 \u043f\u0440\u0438\u043d\u044f\u0442","chat_right_column_incoming_reject":"\u041e\u0442\u043a\u0430\u0437\u0430\u0442\u044c","chat_right_column_outgoing_reject":"\u041e\u0442\u043a\u0430\u0437\u0430\u0442\u044c","today":"\u0421\u0435\u0433\u043e\u0434\u043d\u044f","No_data":"--","read":"\u041f\u0440\u043e\u0447\u0438\u0442\u0430\u043d\u043e"};
window.imbaChatSettings = {"language":"ru","user_id":0,"token":"","imba_id":0,"debug":false,"file_dir":"https:\/\/gisauto.ru\/api\/v1\/files\/","no_password":false,"api_url":"https:\/\/chat.gisauto.ru\/imbachat","resizable":false,"draggable":false,"long_ago_timeout":14,"upload_whitelist":["doc","docx","csv","xls","xlsx","rtf","txt","ppt","pptx","pdf","djvu","fb2","png","jpg","gif","psd","ps","mp3","ogg","wav","rar","tar","gz","zip","mp4","3gp","avi","flv","mkv","m4a"],"upload_blacklist":["php","exe","js","html","css","py","sh"],"uploadMaxFilesize":4990000,"standalone_mode":true,"theme":"default","position":"left","useFaviconBadge":false,"updateTitle":null,"useEmojioneArea":false,"enable_status_field":false,"show_user_offline_alert":true,"cppcomet":{"dev_id":"1","node":"chat.gisauto.ru\/comet"},"imba_widget_version":"7730719c6b77faa70a39ba67559a3589","imba_tpl_version":"7730719c6b77faa70a39ba67559a3589","file_service_url":"https:\/\/gisauto.ru\/api\/v1\/files","file_service_authorization":false,"bot_avatar_url":"https:\/\/gisauto.ru\/logo-gisauto_ru.png","support_avatar_url":"https:\/\/gisauto.ru\/logo-gisauto_ru.png","concierge_avatar_url":"https:\/\/gisauto.ru\/logo-gisauto_ru.png"};
;
if(!window.ImbaLog)
{
window.ImbaLog = function(){
let thisObj = this;
this._logLevel = 0;
this.logLevel = function(level = undefined){
if(level === undefined)
{
return thisObj._logLevel;
}
thisObj._logLevel = level
try{
window.localStorage['ImbaLog_level'] = level/1
}catch (exception) {
}
}
try{
let level = window.localStorage['ImbaLog_level']
this.logLevel(level/1)
}catch (exception) {
}
this.error = function(){
if(thisObj._logLevel > 0) console.error.apply(console, arguments)
}
this.warn = function(){
if(thisObj._logLevel > 1) console.warn.apply(console, arguments)
}
this.info = function(){
if(thisObj._logLevel > 2) console.info.apply(console, arguments)
}
this.log = function(){
if(thisObj._logLevel > 3) console.log.apply(console, arguments)
}
this.debug = function(){
if(thisObj._logLevel > 4) console.debug.apply(console, arguments)
}
}
}
if(!window.imbaLog)
{
window.imbaLog = new window.ImbaLog();
}
/**
*/
window.WebDB = function (opt) {
var indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB
var baseName = opt.base_name || "WebDB"
opt.store_name = opt.store_name
var bdVersion = 1
this.myDB = undefined
this.noCache = opt.noCache
this.onupgradeneeded = opt.onupgradeneeded
this.opt = opt;
if (!opt.store_name) {
opt.store_name = opt.base_name || "WebDBstore"
}
this.connectDB = function () {
var thisObj = this
return new Promise(function (resolve, reject) {
var request = indexedDB.open(baseName, bdVersion);
request.onerror = function (err) {
window.imbaLog.error("connectDB", err);
reject(err)
}
request.onsuccess = function (event) {
resolve(event.target.result);
}
request.onupgradeneeded = function (e) {
if (thisObj.onupgradeneeded) {
thisObj.onupgradeneeded(e, thisObj);
}
else {
let objectStore = e.currentTarget.result.createObjectStore(thisObj.opt.store_name, { keyPath: "path", autoIncrement: true });
if(thisObj.opt.index)
{
for(let i in thisObj.opt.index)
{
objectStore.createIndex(thisObj.opt.index[i].name, thisObj.opt.index[i].name, { unique: thisObj.opt.index[i].unique });
}
}
}
thisObj.connectDB().then(resolve, reject)
}
request.onblocked = function (event) {
window.imbaLog.debug('Waiting to connect because blocked', event);
};
})
}
this.getMinValue = function (field = "path") {
var thisObj = this
return new Promise((resolve, reject) => {
if (thisObj.noCache) {
reject()
return;
}
thisObj.connectDB().then(function (db) {
if (!db) {
debugger;
}
let transaction = db.transaction([thisObj.opt.store_name], "readonly");
let store = transaction.objectStore(thisObj.opt.store_name);
let index = store.index(field);
let request = index.openCursor(/*query*/null, /*direction 'prev' */'next');
request.onerror = function (err) {
window.imbaLog.error("request.onerror", err);
db.close();
reject(err)
}
request.onsuccess = function () {
db.close();
if (!request.result) {
resolve(undefined)
return;
}
resolve(request.result ? request.result : -1)
}
}, reject);
})
}
this.getMinValues = function (field = "path", limit = 10000, offset = 0) {
var thisObj = this
return new Promise((resolve, reject) => {
if (thisObj.noCache) {
reject()
return;
}
thisObj.connectDB().then(function (db) {
if (!db) {
debugger;
}
let transaction = db.transaction([thisObj.opt.store_name], "readonly");
let store = transaction.objectStore(thisObj.opt.store_name);
let index = store.index(field);
let request = index.openCursor(/*query*/null, /*direction 'prev' */'prev');
request.onerror = function (err) {
window.imbaLog.error("request.onerror", err);
db.close();
reject(err)
}
var res = [];
var counter = 0;
request.onsuccess = function (event) {
var cursor = event.target.result;
if (!cursor) {
db.close();
resolve(res)
return;
}
if (offset > 0) {
cursor.advance(offset);
offset = 0;
return;
}
if (cursor) {
var value = request.result.value.data;
res.unshift(value)
if (res.length >= limit) {
db.close();
resolve(res)
return;
}
counter++;
if (counter < limit) {
cursor.continue();
return
}
} else {
db.close();
resolve(res)
return;
}
}
}, reject);
})
}
this.getValue = function (key) {
var thisObj = this
return new Promise((resolve, reject) => {
if (thisObj.noCache) {
reject()
return;
}
thisObj.connectDB().then(function (db) {
if (!db) {
debugger;
}
var request = db.transaction([thisObj.opt.store_name], "readonly").objectStore(thisObj.opt.store_name).get(key);
request.onerror = function (err) {
window.imbaLog.error("getFile", err);
db.close();
reject(err)
}
request.onsuccess = function () {
db.close();
if (!request.result) {
reject()
return;
}
resolve(request.result ? request.result : -1)
}
}, reject);
})
}
this.setValue = function (key, value) {
var thisObj = this
return new Promise(function (resolve, reject) {
if (thisObj.noCache) {
reject()
return;
}
thisObj.connectDB().then(function (db) {
if (!db) {
debugger;
}
var transaction = db.transaction([thisObj.opt.store_name], "readwrite");
transaction.oncomplete = function (event) {
db.close();
resolve()
};
transaction.onerror = function (event) {
window.imbaLog.error("setFile Error", event);
db.close();
reject()
};
var objectStore = transaction.objectStore(thisObj.opt.store_name);
if (thisObj.opt.onPut) {
thisObj.opt.onPut(objectStore, arguments);
}
else {
if (value === undefined) {
objectStore.put(key);
}
else {
objectStore.put({ path: key, data: value });
}
}
}, reject);
})
}
this.dropDB = function () {
var thisObj = this
return new Promise(function (resolve, reject) {
if (thisObj.noCache) {
reject()
return;
}
var DBDeleteRequest = window.indexedDB.deleteDatabase(baseName);
DBDeleteRequest.onerror = function (event) {
reject();
};
DBDeleteRequest.onblocked = function (event) {
window.imbaLog.debug("waiting deleting database (onblocked).", event);
};
DBDeleteRequest.onupgradeneeded = function (event) {
reject();
};
DBDeleteRequest.onsuccess = function (event) { resolve() }
return DBDeleteRequest
})
}
this.deleteValue = function (key) {
var thisObj = this
return new Promise(function (resolve, reject) {
if (thisObj.noCache) {
reject()
return;
}
thisObj.connectDB().then(function (db) {
if (!db) {
debugger;
}
var transaction = db.transaction([thisObj.opt.store_name], "readwrite");
transaction.oncomplete = function (event) {
db.close();
resolve()
};
transaction.onerror = function (event) {
window.imbaLog.error("setFile Error", event);
db.close();
reject()
};
var objectStore = transaction.objectStore(thisObj.opt.store_name);
objectStore.delete(key);
}, reject);
})
}
}

//----------- getWidgetData ---


!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):t.dayjs=n()}(this,function(){"use strict";var t="millisecond",n="second",e="minute",r="hour",i="day",s="week",u="month",o="quarter",a="year",h=/^(\d{4})-?(\d{1,2})-?(\d{0,2})[^0-9]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?.?(\d{1,3})?$/,f=/\[([^\]]+)]|Y{2,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,c=function(t,n,e){var r=String(t);return!r||r.length>=n?t:""+Array(n+1-r.length).join(e)+t},d={s:c,z:function(t){var n=-t.utcOffset(),e=Math.abs(n),r=Math.floor(e/60),i=e%60;return(n<=0?"+":"-")+c(r,2,"0")+":"+c(i,2,"0")},m:function(t,n){var e=12*(n.year()-t.year())+(n.month()-t.month()),r=t.clone().add(e,u),i=n-r<0,s=t.clone().add(e+(i?-1:1),u);return Number(-(e+(n-r)/(i?r-s:s-r))||0)},a:function(t){return t<0?Math.ceil(t)||0:Math.floor(t)},p:function(h){return{M:u,y:a,w:s,d:i,h:r,m:e,s:n,ms:t,Q:o}[h]||String(h||"").toLowerCase().replace(/s$/,"")},u:function(t){return void 0===t}},$={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_")},l="en",m={};m[l]=$;var y=function(t){return t instanceof v},M=function(t,n,e){var r;if(!t)return null;if("string"==typeof t)m[t]&&(r=t),n&&(m[t]=n,r=t);else{var i=t.name;m[i]=t,r=i}return e||(l=r),r},g=function(t,n,e){if(y(t))return t.clone();var r=n?"string"==typeof n?{format:n,pl:e}:n:{};return r.date=t,new v(r)},D=d;D.l=M,D.i=y,D.w=function(t,n){return g(t,{locale:n.$L,utc:n.$u})};var v=function(){function c(t){this.$L=this.$L||M(t.locale,null,!0)||l,this.parse(t)}var d=c.prototype;return d.parse=function(t){this.$d=function(t){var n=t.date,e=t.utc;if(null===n)return new Date(NaN);if(D.u(n))return new Date;if(n instanceof Date)return new Date(n);if("string"==typeof n&&!/Z$/i.test(n)){var r=n.match(h);if(r)return e?new Date(Date.UTC(r[1],r[2]-1,r[3]||1,r[4]||0,r[5]||0,r[6]||0,r[7]||0)):new Date(r[1],r[2]-1,r[3]||1,r[4]||0,r[5]||0,r[6]||0,r[7]||0)}return new Date(n)}(t),this.init()},d.init=function(){var t=this.$d;this.$y=t.getFullYear(),this.$M=t.getMonth(),this.$D=t.getDate(),this.$W=t.getDay(),this.$H=t.getHours(),this.$m=t.getMinutes(),this.$s=t.getSeconds(),this.$ms=t.getMilliseconds()},d.$utils=function(){return D},d.isValid=function(){return!("Invalid Date"===this.$d.toString())},d.isSame=function(t,n){var e=g(t);return this.startOf(n)<=e&&e<=this.endOf(n)},d.isAfter=function(t,n){return g(t)<this.startOf(n)},d.isBefore=function(t,n){return this.endOf(n)<g(t)},d.$g=function(t,n,e){return D.u(t)?this[n]:this.set(e,t)},d.year=function(t){return this.$g(t,"$y",a)},d.month=function(t){return this.$g(t,"$M",u)},d.day=function(t){return this.$g(t,"$W",i)},d.date=function(t){return this.$g(t,"$D","date")},d.hour=function(t){return this.$g(t,"$H",r)},d.minute=function(t){return this.$g(t,"$m",e)},d.second=function(t){return this.$g(t,"$s",n)},d.millisecond=function(n){return this.$g(n,"$ms",t)},d.unix=function(){return Math.floor(this.valueOf()/1e3)},d.valueOf=function(){return this.$d.getTime()},d.startOf=function(t,o){var h=this,f=!!D.u(o)||o,c=D.p(t),d=function(t,n){var e=D.w(h.$u?Date.UTC(h.$y,n,t):new Date(h.$y,n,t),h);return f?e:e.endOf(i)},$=function(t,n){return D.w(h.toDate()[t].apply(h.toDate(),(f?[0,0,0,0]:[23,59,59,999]).slice(n)),h)},l=this.$W,m=this.$M,y=this.$D,M="set"+(this.$u?"UTC":"");switch(c){case a:return f?d(1,0):d(31,11);case u:return f?d(1,m):d(0,m+1);case s:var g=this.$locale().weekStart||0,v=(l<g?l+7:l)-g;return d(f?y-v:y+(6-v),m);case i:case"date":return $(M+"Hours",0);case r:return $(M+"Minutes",1);case e:return $(M+"Seconds",2);case n:return $(M+"Milliseconds",3);default:return this.clone()}},d.endOf=function(t){return this.startOf(t,!1)},d.$set=function(s,o){var h,f=D.p(s),c="set"+(this.$u?"UTC":""),d=(h={},h[i]=c+"Date",h.date=c+"Date",h[u]=c+"Month",h[a]=c+"FullYear",h[r]=c+"Hours",h[e]=c+"Minutes",h[n]=c+"Seconds",h[t]=c+"Milliseconds",h)[f],$=f===i?this.$D+(o-this.$W):o;if(f===u||f===a){var l=this.clone().set("date",1);l.$d[d]($),l.init(),this.$d=l.set("date",Math.min(this.$D,l.daysInMonth())).toDate()}else d&&this.$d[d]($);return this.init(),this},d.set=function(t,n){return this.clone().$set(t,n)},d.get=function(t){return this[D.p(t)]()},d.add=function(t,o){var h,f=this;t=Number(t);var c=D.p(o),d=function(n){var e=g(f);return D.w(e.date(e.date()+Math.round(n*t)),f)};if(c===u)return this.set(u,this.$M+t);if(c===a)return this.set(a,this.$y+t);if(c===i)return d(1);if(c===s)return d(7);var $=(h={},h[e]=6e4,h[r]=36e5,h[n]=1e3,h)[c]||1,l=this.valueOf()+t*$;return D.w(l,this)},d.subtract=function(t,n){return this.add(-1*t,n)},d.format=function(t){var n=this;if(!this.isValid())return"Invalid Date";var e=t||"YYYY-MM-DDTHH:mm:ssZ",r=D.z(this),i=this.$locale(),s=this.$H,u=this.$m,o=this.$M,a=i.weekdays,h=i.months,c=function(t,r,i,s){return t&&(t[r]||t(n,e))||i[r].substr(0,s)},d=function(t){return D.s(s%12||12,t,"0")},$=i.meridiem||function(t,n,e){var r=t<12?"AM":"PM";return e?r.toLowerCase():r},l={YY:String(this.$y).slice(-2),YYYY:this.$y,M:o+1,MM:D.s(o+1,2,"0"),MMM:c(i.monthsShort,o,h,3),MMMM:h[o]||h(this,e),D:this.$D,DD:D.s(this.$D,2,"0"),d:String(this.$W),dd:c(i.weekdaysMin,this.$W,a,2),ddd:c(i.weekdaysShort,this.$W,a,3),dddd:a[this.$W],H:String(s),HH:D.s(s,2,"0"),h:d(1),hh:d(2),a:$(s,u,!0),A:$(s,u,!1),m:String(u),mm:D.s(u,2,"0"),s:String(this.$s),ss:D.s(this.$s,2,"0"),SSS:D.s(this.$ms,3,"0"),Z:r};return e.replace(f,function(t,n){return n||l[t]||r.replace(":","")})},d.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},d.diff=function(t,h,f){var c,d=D.p(h),$=g(t),l=6e4*($.utcOffset()-this.utcOffset()),m=this-$,y=D.m(this,$);return y=(c={},c[a]=y/12,c[u]=y,c[o]=y/3,c[s]=(m-l)/6048e5,c[i]=(m-l)/864e5,c[r]=m/36e5,c[e]=m/6e4,c[n]=m/1e3,c)[d]||m,f?y:D.a(y)},d.daysInMonth=function(){return this.endOf(u).$D},d.$locale=function(){return m[this.$L]},d.locale=function(t,n){if(!t)return this.$L;var e=this.clone();return e.$L=M(t,n,!0),e},d.clone=function(){return D.w(this.toDate(),this)},d.toDate=function(){return new Date(this.$d)},d.toJSON=function(){return this.toISOString()},d.toISOString=function(){return this.$d.toISOString()},d.toString=function(){return this.$d.toUTCString()},c}();return g.prototype=v.prototype,g.extend=function(t,n){return t(n,v,g),g},g.locale=M,g.isDayjs=y,g.unix=function(t){return g(1e3*t)},g.en=m[l],g.Ls=m,g});

/**
*
* @link http://comet-server.com
* _/﹋\_*/
if( !window._tabSignal)
{
var _tabSignal = function(opt)
{
this.slotArray = new Array();
this.debug = false;
this.sigId = 0;
this.tabUUID = undefined;
this.getTabUUID = function()
{
if(!this.tabUUID)
{
this.tabUUID = "";
for(var i = 0; i< 16; i++)
{
this.tabUUID += "qwertyuiopasdfghjklzxcvbnm1234567890QWERTYUIOPASDFGHJKLZXCVBNM"[Math.floor(Math.random()*62)];
}
}
return this.tabUUID;
};
this.eventKey = this.getTabUUID();
if(opt && opt.eventKey)
{
this.eventKey = opt.eventKey
}
this.setEventKey = function(key)
{
this.eventKey = key
}
this.getEventKey = function()
{
return this.eventKey
}
/**
* </code>
*/
this.connect = function(slot_name, signal_name, slot_function)
{
if(slot_function === undefined)
{
slot_function = signal_name;
signal_name = slot_name;
slot_name = "sig" + (this.sigId++)
}
if (this.slotArray[signal_name] === undefined)
{
this.slotArray[signal_name] = {}
}
this.slotArray[signal_name][slot_name] = slot_function;
if(this.debug) console.log("[js-api] На прослушивание сигнала " + signal_name + " добавлен слот " + slot_name + "", this.slotArray);
return slot_name;
};
this.on = this.connect
this.once = function(signal_name, slot_function)
{
let thisObj = this;
return this.connect(signal_name, function(param,signal_name, SignalNotFromThisTab, slot_name)
{
thisObj.disconnect(slot_name, signal_name)
slot_function(param,signal_name, SignalNotFromThisTab, slot_name)
})
}
this.setEventKey = function(key){
this.eventKey = key;
}
this.getEventKey = function(){
return this.eventKey;
}
/**
*/
this.disconnectAllFromSignal = function(signal_name)
{
this.slotArray[signal_name] = undefined
return true
};
/**
*/
this.disconnect = function(slot_name, signal_name)
{
if (this.slotArray[signal_name] !== undefined)
{
if (this.slotArray[signal_name][slot_name] !== undefined)
{
this.slotArray[signal_name][slot_name] = undefined;
return true
}
}
else
{
this.slotArray[slot_name] = undefined;
}
return false
};
/**
*/
this.emit = function(signal_name, param, SignalNotFromThisTab)
{
if (this.slotArray[signal_name] === undefined)
{
if(this.debug) console.log("[js-api] На сигнал " + signal_name + " нет подписчиков")
}
else
{
if(this.debug) console.log("[js-api] Сигнал " + signal_name + " подписаны слоты");
var obj = this.slotArray[signal_name];
for (var slot in obj)
{
if( obj.hasOwnProperty(slot) && obj[slot] !== undefined)
{
obj[slot](param,signal_name, SignalNotFromThisTab === true)
}
}
}
};
this.filter = function(signal_name, param, SignalNotFromThisTab)
{
if (this.slotArray[signal_name] === undefined)
{
return;
}
var obj = this.slotArray[signal_name];
for (var slot in obj)
{
if( obj.hasOwnProperty(slot) && obj[slot] !== undefined)
{
let r = obj[slot](param,signal_name, SignalNotFromThisTab === true, slot)
if(r !== undefined)
{
return r;
}
}
}
}
/*
*/
this.emitAll = function (signal_name, param)
{
this.emit(signal_name, param);
try{
if(window['localStorage'] !==undefined )
{
var curent_custom_id = Math.random()+"_"+Math.random()+"_"+Math.random()+"_"+Math.random()+"_"+Math.random();
window['localStorage'][this.eventKey]= JSON.stringify({name:signal_name, custom_id:curent_custom_id, param:param});
}
return true
}catch (e){
return false
}
};
/**
*/
this.setState = function(name, value, minTime)
{
if(!this._states)
{
this._states = {}
}
var time = new Date();
try{
if(minTime)
{
var value = window.localStorage["tabSignal_"+this.eventKey+name];
if(value)
{
var val = JSON.parse(value);
if(val.time + minTime > time.getTime() && val.tabUUID != this.getTabUUID() )
{
return false
}
}
}
window.localStorage["tabSignal_"+this.eventKey+name] = JSON.stringify({time: time.getTime(), value: value, tabUUID: this.getTabUUID()});
return true
}catch (e)
{
if(minTime)
{
var value = this._states["tabSignal_"+this.eventKey+name];
if(value)
{
var val = JSON.parse(value);
if(val.time + minTime > time.getTime() && val.tabUUID != this.getTabUUID() )
{
return false
}
}
}
this._states["tabSignal_"+this.eventKey+name] = JSON.stringify({time: time.getTime(), value: value, tabUUID: this.getTabUUID()});
return true
}
};
/**
*/
this.intervalUpdateState = function(name, value, minTime)
{
var thisObj = this;
if(thisObj.setState(name, value, minTime))
{
return setInterval(function(){
thisObj.setState(name, value, minTime)
}, minTime/3, name, value, minTime)
}
return undefined
};
/**
*/
this.getState = function(name, maxTime)
{
if(!this._states)
{
this._states = {}
}
try{
var time = new Date();
var value = window.localStorage["tabSignal_"+this.eventKey+name];
if(value)
{
var val = JSON.parse(value);
if(!maxTime)
{
return val.value
}
if(val.time + maxTime > time.getTime())
{
return val.value
}
return undefined
}
}catch (e){
var time = new Date();
var value = this._states["tabSignal_"+this.eventKey+name];
if(value)
{
var val = JSON.parse(value);
if(!maxTime)
{
return val.value
}
if(val.time + maxTime > time.getTime())
{
return val.value
}
return undefined
}
}
return undefined
};
this.send_emit = this.emit/*All*/; // Для совместимости с прошлой версией.
var thisTabSignalObj = this;
this.init = true;
if( window.addEventListener )
{
window.addEventListener('storage', function(e)
{
if(e.key && e.key == thisTabSignalObj.eventKey)
{// !testThis
try{
var data = JSON.parse(e.newValue);
if(data !== undefined && data.name !== undefined )
{
if(thisTabSignalObj.debug > 1) console.log( data );
thisTabSignalObj.emit( data.name, data.param, true )
}
}
catch (failed)
{
}
}
}, false);
}
else if( document.attachEvent )
{
document.attachEvent('onstorage', function(e)
{
if(e.key && e.key == thisTabSignalObj.eventKey)
{// !testThis
try{
var data = JSON.parse(e.newValue);
if(data !== undefined && data.name !== undefined )
{
if(thisTabSignalObj.debug > 1) console.log( data );
thisTabSignalObj.emit( data.name, data.param, true )
}
}
catch (failed)
{
}
}
});
}
}
}
if( !window.tabSignal)
{
window.tabSignal = new _tabSignal({eventKey:'tabSignal_storage_emit'});
}
window.comet_server_signal = function(){ return window.tabSignal}
if(!window.cometServerApi)
{
var _cometServerApi = function(opt)
{
if(opt)
{
if(this.options === undefined)
{
this.options = {};
}
for(var key in opt)
{
this.options[key] = opt[key];
}
}
/**
*/
this.version = "4.15";
/**
*/
this.options = {};
this.tabSignal = new _tabSignal();
/**
*/
this.options.nodeArray = ["app.comet-server.ru"];
this.options.node = undefined;
/**
*/
this.options.roundrobin = false;
/**
*/
this.is_master = undefined;
/**
*/
this.instance_id = undefined;
/**
*/
/**
*/
this.in_try_conect = false;
/**
*/
this.subscription_array = new Array();
/**
*/
this.custom_id = (Math.random()*10)+""+Math.random();
this.custom_id = this.custom_id.replace(/[^0-9A-z]/,"").replace(/^(.{10}).*$/,"$1");
/**
*/
this.time_to_reconect_on_error = [];
/**
*/
this.time_to_reconect_on_close = [];
/**
*/
this.in_abort = false;
/**
*/
this.restart_time_id = false;
/**
*/
this.start_timer = 1200;
/**
*/
this.reg_exp = new RegExp(/^([^.]+)\.([^.]+)$/);
/**
*/
this.protocol = "";
if(document.location)
{
this.protocol = window.location.protocol.replace(/[^s]/img, "")
}
/**
*/
this.web_socket_error = [];
/**
*/
this.isSendStatisticsData = [];
/**
*/
this.web_socket_success = false;
/**
*/
this.web_socket_error_timeOut = 30000;
/**
*/
this.xhr_error = 0;
/**
*/
this.xhr_error_timeOut_id = 30000;
/**
*/
this.authorized_status;
/**
*/
this.socket;
this.socketArray = [];
/**
*/
this.use_WebSocket;
/**
*/
this.request;
/**
*/
this.status;
/**
*/
this.send_msg_queue = [];
/**
*/
this.send_msg_subscription = false;
/**
*/
this.LogLevel = 0;
/**
*/
this.msgsUUIDs = {};
try{
if(window['localStorage']['comet_LogLevel'])
{
this.LogLevel = window['localStorage']['comet_LogLevel']/1
}
}catch (e){}
this.getLogLevel = function()
{
return this.LogLevel;
};
this.setLogLevel = function(level)
{
this.LogLevel = level;
try{
window['localStorage']['comet_LogLevel'] = level;
}catch (e){}
};
/**
*/
this.getCustomString = function()
{
var custom = (Math.random()*10)+""+Math.random();
return custom.replace(/[^0-9A-z]/,"").replace(/^(.{10}).*$/,"$1");
};
/**
*/
this.getTabUUID = function()
{
return this.tabSignal.getTabUUID()
};
/**
* http://www.webtoolkit.info/
**/
this.Base64 = {
_keyStr : "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",
encode : function (input) {
var output = "";
var chr1, chr2, chr3, enc1, enc2, enc3, enc4;
var i = 0;
input = input.replace(/\r\n/g,"\n");
var utftext = "";
for (var n = 0; n < input.length; n++)
{
var c = input.charCodeAt(n);
if (c < 128) {
utftext += String.fromCharCode(c);
}
else if((c > 127) && (c < 2048)) {
utftext += String.fromCharCode((c >> 6) | 192);
utftext += String.fromCharCode((c & 63) | 128);
}
else {
utftext += String.fromCharCode((c >> 12) | 224);
utftext += String.fromCharCode(((c >> 6) & 63) | 128);
utftext += String.fromCharCode((c & 63) | 128);
}
}
while (i < utftext.length) {
chr1 = utftext.charCodeAt(i++);
chr2 = utftext.charCodeAt(i++);
chr3 = utftext.charCodeAt(i++);
enc1 = chr1 >> 2;
enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);
enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);
enc4 = chr3 & 63;
if (isNaN(chr2)) {
enc3 = enc4 = 64;
} else if (isNaN(chr3)) {
enc4 = 64;
}
output = output +
this._keyStr.charAt(enc1) + this._keyStr.charAt(enc2) +
this._keyStr.charAt(enc3) + this._keyStr.charAt(enc4);
}
return output;
},
decode : function (input) {
var output = "";
var chr1, chr2, chr3;
var enc1, enc2, enc3, enc4;
var i = 0;
input = input.replace(/[^A-Za-z0-9\+\/\=]/g, "");
while (i < input.length) {
enc1 = this._keyStr.indexOf(input.charAt(i++));
enc2 = this._keyStr.indexOf(input.charAt(i++));
enc3 = this._keyStr.indexOf(input.charAt(i++));
enc4 = this._keyStr.indexOf(input.charAt(i++));
chr1 = (enc1 << 2) | (enc2 >> 4);
chr2 = ((enc2 & 15) << 4) | (enc3 >> 2);
chr3 = ((enc3 & 3) << 6) | enc4;
output = output + String.fromCharCode(chr1);
if (enc3 != 64) {
output = output + String.fromCharCode(chr2);
}
if (enc4 != 64) {
output = output + String.fromCharCode(chr3);
}
}
var string = "";
var i = 0;
var c = c1 = c2 = 0;
while ( i < output.length ) {
c = output.charCodeAt(i);
if (c < 128) {
string += String.fromCharCode(c);
i++;
}
else if((c > 191) && (c < 224)) {
c2 = output.charCodeAt(i+1);
string += String.fromCharCode(((c & 31) << 6) | (c2 & 63));
i += 2;
}
else {
c2 = output.charCodeAt(i+1);
c3 = output.charCodeAt(i+2);
string += String.fromCharCode(((c & 15) << 12) | ((c2 & 63) << 6) | (c3 & 63));
i += 3;
}
}
return string;
}
};
this.stripslashes = function(str)
{
return (str + '')
.replace(/\\(.?)/g, function(s, n1) {
switch (n1) {
case '\\':
return '\\';
case '0':
return '\u0000';
case '':
return '';
default:
return n1;
}
});
};
/**
*/
this.subscription_callBack = function(name, callBack, specialMarker)
{
var thisObj = this;
var sigId = name+"&&";
if(specialMarker === undefined)
{
sigId += thisObj.tabSignal.connect(name, function(param)
{
if(param.server_info.marker !== thisObj.custom_id && param.server_info.marker !== undefined)
{
return 0;
}
callBack(param);
});
}
else
{
sigId += thisObj.tabSignal.connect(specialMarker, name, function(param)
{
if(param.server_info.marker !== specialMarker)
{
return 0;
}
thisObj.tabSignal.disconnect(specialMarker, name);
callBack(param);
});
}
return sigId;
};
/**
*/
this.subscription_once = function(specialMarker, callBack)
{
var thisObj = this;
var sigId = specialMarker+"&&";
sigId += thisObj.tabSignal.connect(specialMarker, specialMarker, function(param)
{
thisObj.tabSignal.disconnect(specialMarker, specialMarker);
callBack(param);
});
return sigId;
};
/**
*/
this.subscription_slot_array = [];
/**
*/
this.unsubscriptionAll = function()
{
for(var i = 0; i < this.subscription_slot_array.length; i++)
{
var val = this.subscription_slot_array[i];
var sigName = val.replace(/^(.*)&&.*$/, "$1");
var slotName = val.replace(/^.*&&(.*)$/, "$1");
this.tabSignal.disconnect(slotName, sigName);
}
this.subscription_slot_array = [];
return true;
};
/**
*/
this.unsubscription = function(sigId)
{
if(sigId === undefined)
{
console.warn("cometApi.unsubscription вызван без аргументов.");
console.warn("Чтобы отписаться от всех подписок разом вызовете cometApi.unsubscriptionAll() ");
return false;
}
else if(!sigId)
{
return false;
}
if(sigId.indexOf('&&')!=-1){
var sigName = sigId.replace(/^(.*)&&.*$/, "$1");
var slotName = sigId.replace(/^.*&&(.*)$/, "$1");
return this.tabSignal.disconnect(slotName, sigName);
}
return this.tabSignal.disconnect(sigId);
};
var localArr_uuid = {}
this.addUUID = function(uuid)
{
var d = new Date();
try{
localArr_uuid[uuid] = d.getTime();
}catch (e){}
};
this.testUUID = function(uuid)
{
try{
return localArr_uuid[uuid]
}catch (e){}
};
this.clearUUID = function()
{
var d = new Date();
var time = d.getTime();
try{
localArr_uuid = {}
}catch (e){}
};
/**
*/
this.subscription = function(name, callback)
{
if(name === undefined )
{
return false;
}
var thisObj = this;
var nameArray = name.split("\n");
if(nameArray.length > 1)
{
for(var i = 0; i < nameArray.length; i++)
{
this.subscription(nameArray[i], callback);
}
return;
}
if(callback === undefined)
{
callback = function(){};
}
var sigId = null;
if(typeof name === "function" )
{
sigId = "comet_server_msg&&" + this.tabSignal.connect("comet_server_msg", name);
this.subscription_slot_array.push(sigId);
return sigId;
}
if( name === "msg" || /^msg\./.test(name) )
{
sigId = thisObj.subscription_callBack(name, callback);
this.subscription_slot_array.push(sigId);
return sigId;
}
if(/^answer_to_web_/.test(name))
{
sigId = thisObj.subscription_callBack(name, callback);
this.subscription_slot_array.push(sigId);
return sigId;
}
else if(/^#/.test(name))
{
name = name.replace("#", "_answer_to_");
sigId = thisObj.subscription_callBack(name, callback);
this.subscription_slot_array.push(sigId);
return sigId;
}
if( name === "" )
{ // Подписка на все сообщения разом
name = "comet_server_msg";
}
if(name.length < 2 )
{
console.error("Error pipe is to short", name);
return false;
}
if(!/^[A-z0-9_.\-]+$/.test(name))
{
console.error("Invalid pipe name", name)
}
sigId = thisObj.subscription_callBack(name, callback);
this.subscription_slot_array.push(sigId);
if( name === "comet_server_msg" )
{
return sigId;
}
if(this.reg_exp.test(name))
{
var res = this.reg_exp.exec(name);
name = res[1];
}
for(var i = 0; i < this.subscription_array.length; i++)
{
if(this.subscription_array[i] === name )
{
return sigId;
}
}
this.subscription_array[this.subscription_array.length] = name;
if(this.isMaster() === undefined)
{
this.add_msg_to_queue("subscription\n"+this.subscription_array.join("\n"))
}
else if(this.isMaster())
{
if(this.LogLevel) console.log("[js-api] add subscription:"+name);
if(this.UseWebSocket())
{
if(this.lastSubscriptionTimeoutId)
{
clearTimeout(this.lastSubscriptionTimeoutId);
}
this.lastSubscriptionTimeoutId = setTimeout(function()
{
thisObj.lastSubscriptionTimeoutId = false;
thisObj.send_msg("subscription\n"+thisObj.subscription_array.join("\n"))
}, 50);
}
else
{
this.restart()
}
}
else
{
thisObj.tabSignal.emit/*All*/('comet_msg_slave_add_subscription_and_restart',this.subscription_array.join("\n"))
}
return sigId;
};
this.isMaster = function()
{
return this.is_master;
};
/**
*/
this.send_curent_subscription = function()
{
if(this.subscription_array.length === 0)
{
return;
}
this.send_msg("subscription\n"+this.subscription_array.join("\n"))
};
/**
*/
this.getUUID = function()
{
if(this.options["uuid"])
{
return this.options["uuid"];
}
var a = "qwertyuiopasdfghjklzxcvbnm1234567890QWERTYUIOPASDFGHJKLZXCVBNM_-";
try{
if(window['localStorage']['comet_server_uuid'] !== undefined )
{
this.options["uuid"] = window['localStorage']['comet_server_uuid']
}
else
{
this.options["uuid"] = "";
for(var i = 0; i< 32; i++)
{
this.options["uuid"] += a[Math.floor(Math.random()*a.length)];
}
window['localStorage']['comet_server_uuid']= this.options["uuid"];
}
}catch (e)
{
this.options["uuid"] = "";
for(var i = 0; i< 32; i++)
{
this.options["uuid"] += a[Math.floor(Math.random()*a.length)];
}
}
return this.options["uuid"];
};
/**
*/
this.getUrl = function(nodename)
{
if(nodename === undefined)
{
nodename = this.options.nodeArray[0]
}
if(this.UseWebSocket() === true)
{
return 'ws'+this.protocol+'://'+nodename+'/ws/sesion='+this.options.user_key+'&myid='+this.options.user_id+'&devid='+this.options.dev_id+"&v="+this.version+"&uuid="+this.getUUID()+"&api=js";
}
return 'http'+this.protocol+'://'+nodename+'/sesion='+this.options.user_key+'&myid='+this.options.user_id+'&devid='+this.options.dev_id+"&v="+this.version+"&uuid="+this.getUUID()+"&api=js";
};
this.getUserId = function()
{
return this.options.user_id
};
this.getUserKey = function()
{
return this.options.user_key
};
this.getRealUserKey = function()
{
return this.tabSignal.getState("real_user_key")
};
this.setRealUserKey = function(real_user_key)
{
return this.tabSignal.setState("real_user_key", real_user_key)
};
this.getDevId = function()
{
return this.options.dev_id
};
this.UseWebSocket = function(use)
{
if(use === true)
{
this.use_WebSocket = use;
}
else if(use === false)
{
this.use_WebSocket = use;
}
else if(this.use_WebSocket === undefined)
{
this.use_WebSocket = (window.WebSocket !== undefined)
}
return this.use_WebSocket;
};
/**
*/
this.UseWss = function(use)
{
if(use)
{
this.protocol = "s"
}
else if(use === undefined && window.location && window.location.protocol)
{
this.protocol = window.location.protocol.replace(/[^s]/img, "");
}
else
{
this.protocol = ""
}
return this.protocol === "s"
};
this.options.isStart = false;
this.updateEventKey = function()
{
this.tabSignal.setEventKey(this.options.nodeArray.join("_")+"_"+this.options.dev_id +"_"+this.options.user_id)
};
/**
*/
this.isUseWss = function()
{
return this.protocol === "s"
};
/**
*/
this.start = function(opt, callBack)
{
this.options.isStart = true;
if(opt !== undefined)
{
for(var key in opt)
{
this.options[key] = opt[key];
}
}
if(this.options.wss != undefined)
{
this.UseWss(this.options.wss)
}
if(this.options.node)
{
if(typeof this.options.node != "string")
{
this.options.nodeArray = this.options.node
}
else
{
this.options.nodeArray = [this.options.node]
}
}
if(this.options.nodes)
{
this.options.nodeArray = this.options.nodes
}
if(this.LogLevel) console.log("[js-api] start", [this.custom_id , opt]);
this.UseWebSocket(window.WebSocket !== undefined);
if(!this.options.dev_id)
{
if(this.options.nodeArray[0] == "app.comet-server.ru")
{
console.warn("Comet: Not set dev_id", this.options.dev_id);
console.warn("Comet: set dev_id = 15 for testing and demo access. Do not use this in production.", this.options.dev_id);
console.warn("Comet: See https://comet-server.com/wiki/doku.php/en:comet:dev_id or https://comet-server.com/wiki/doku.php/comet:dev_id");
this.options.dev_id = "15"
}
else
{
this.options.dev_id = "0"
}
}
this.updateEventKey()
this.in_abort = false;
this.conect(callBack);
return true;
};
this.stop = function()
{
this.options.isStart = false;
if(this.isMaster())
{
this.in_abort = true;
if(this.UseWebSocket())
{
for(var i = 0; i < this.socketArray.length; i++)
{
if(this.socketArray[i])
{
this.socketArray[i].close();
}
}
}
else
{
this.request.abort();
}
}
else
{
this.tabSignal.emit/*All*/('comet_msg_slave_signal_stop')
}
};
/**
*/
this.restart = function(opt)
{
if(opt !== undefined)
{
for(var key in opt)
{
this.options[key] = opt[key];
}
}
this.updateEventKey()
if(!this.options.isStart)
{
return this.start(opt);
}
if(this.isMaster())
{
if(this.UseWebSocket())
{
for(var i = 0; i < this.socketArray.length; i++)
{
if(this.socketArray[i])
{
if(this.LogLevel)
{
console.log("[js-api] restart socket", i);
}
this.socketArray[i].close();
}
}
}
else
{
this.request.abort();
}
}
else
{
this.tabSignal.emit/*All*/('comet_msg_slave_signal_restart', opt);
}
};
this.setAsSlave = function(callback)
{
if(callback === undefined)
{
callback = function(){};
}
var thisObj = this;
var time_id = false;
var last_time_id = false;
thisObj.tabSignal.connect("slot_comet_msg_set_as_slave",'comet_msg_set_as_slave', function()
{
if(thisObj.LogLevel)
{
console.log("[js-api] comet_msg_set_as_slave: set is slave");
}
thisObj.tabSignal.disconnect("slot_comet_msg_set_as_slave", 'comet_msg_set_as_slave');
thisObj.send_msg_from_queue();
thisObj.tabSignal.connect('__comet_set_authorized_slot', '__comet_authorized', function(param,arg)
{
if(thisObj.LogLevel) console.log([param,arg]);
if(param == "undefined")
{
setTimeout(function()
{
thisObj.tabSignal.emit/*All*/('__comet_get_authorized_status');
}, 200)
}
thisObj.setAuthorized(param)
});
thisObj.tabSignal.emit/*All*/('__comet_get_authorized_status');
});
thisObj.tabSignal.connect("comet_msg_conect",'comet_msg_master_signal', function()
{
if(time_id !== false) // отменим поставленый ранее таймер если это ещё не сделано
{
clearTimeout( time_id );
time_id = false;
if(thisObj.LogLevel) console.log("[js-api] Connection to server canceled");
thisObj.tabSignal.disconnect("comet_msg_conect", 'comet_msg_master_signal');
thisObj.tabSignal.connect("comet_msg_conect_to_master_signal",'comet_msg_master_signal', function()
{
if(last_time_id !== false)
{
clearTimeout( last_time_id );
}
last_time_id = setTimeout(function()
{
thisObj.tabSignal.disconnect("comet_msg_conect_to_master_signal", 'comet_msg_master_signal');
thisObj.in_try_conect = false;
thisObj.conect_to_server();
callback();
}, thisObj.start_timer );
})
}
if(thisObj.LogLevel) console.log("[js-api] set is slave");
thisObj.is_master = false; // Укажем что мы явно не мастер вкладка переключив thisObj.is_master из undefined в false
thisObj.tabSignal.emit('comet_msg_set_as_slave', "slave");
});
time_id = setTimeout(function()
{
thisObj.tabSignal.disconnect("comet_msg_conect", 'comet_msg_master_signal');
thisObj.in_try_conect = false;
thisObj.conect_to_server();
callback();
}, this.start_timer )
};
/**
*/
this.setAsMaster = function()
{
var thisObj = this;
this.is_master = true;
if(this.LogLevel) console.log("[js-api] setAsMaster");
thisObj.tabSignal.emit/*All*/('comet_msg_new_master'); // для уведомления всех что надо переподписатся @todo реализовать переподписку событий
var masterSignalIntervalId = setInterval(function() // Поставим таймер для уведомления всех остальных вкладок о своём превосходстве
{
}, this.start_timer/6);
thisObj.tabSignal.connect("comet_msg_master_detect", 'comet_msg_master_signal', function(event, signal_name, SignalNotFromThisTab)
{
if(SignalNotFromThisTab && thisObj.LogLevel)
{
console.error("There was a collision, two master tabs were formed")
}
if(SignalNotFromThisTab && event.custom_id > thisObj.custom_id)
{
if(thisObj.LogLevel) console.log("[js-api] Yield power, go to slave tab mode");
clearInterval(masterSignalIntervalId);
thisObj.tabSignal.disconnect('comet_msg_master_detect', "comet_msg_master_signal");
thisObj.tabSignal.disconnect('comet_master_tab', "comet_msg_slave_signal_restart");
thisObj.tabSignal.disconnect('comet_master_tab', "comet_msg_slave_signal_stop");
thisObj.tabSignal.disconnect('comet_master_tab', "comet_msg_slave_signal_start");
thisObj.tabSignal.disconnect('comet_master_tab', "comet_msg_slave_add_subscription_and_restart");
thisObj.tabSignal.disconnect('comet_master_tab', "comet_msg_slave_send_msg");
thisObj.tabSignal.disconnect('comet_master_tab', "__comet_get_authorized_status");
thisObj.setAsSlave()
}
});
thisObj.tabSignal.connect('comet_master_tab', 'comet_msg_slave_signal_restart', function(p,arg)
{
if(thisObj.LogLevel) console.log([p,arg]);
thisObj.restart(p)
});
thisObj.tabSignal.connect('comet_master_tab', 'comet_msg_slave_signal_stop', function(p,arg)
{
if(thisObj.LogLevel) console.log([p,arg]);
thisObj.stop()
});
thisObj.tabSignal.connect('comet_master_tab', 'comet_msg_slave_signal_start', function(p,arg)
{
if(thisObj.LogLevel) console.log([p,arg]);
thisObj.start()
});
thisObj.tabSignal.connect('comet_master_tab', 'comet_msg_slave_add_subscription_and_restart', function(p,arg)
{
if(thisObj.LogLevel) console.log([p,arg]);
thisObj.subscription(p)
});
thisObj.tabSignal.connect('comet_master_tab', 'comet_msg_slave_send_msg', function(p,arg)
{
if(thisObj.LogLevel) console.log([p,arg]);
thisObj.send_msg(p)
});
thisObj.tabSignal.disconnect('__comet_set_authorized_slot', "__comet_authorized");
thisObj.tabSignal.connect('comet_master_tab', '__comet_get_authorized_status', function(p,arg)
{
thisObj.tabSignal.emit/*All*/("__comet_authorized", thisObj.isAuthorized())
});
setInterval(thisObj.clearUUID, 1000*60*3)
};
/**
*/
this.setAuthorized = function(value)
{
if(this.LogLevel) console.log("[js-api] setAuthorized:", value);
if(this.authorized_status !== value && value === true)
{
this.tabSignal.emit("__comet_onAuthSuccess")
}
else if(this.authorized_status !== value && value === false)
{
this.tabSignal.emit("__comet_onAuthFalill")
}
this.authorized_status = value;
if(this.isMaster())
{
this.tabSignal.emit/*All*/("__comet_authorized", this.authorized_status)
}
};
/**
*/
this.onAuthSuccess = function(callback)
{
this.tabSignal.connect("__comet_onAuthSuccess", callback)
};
/**
*/
this.onAuthFalill = function(callback)
{
this.tabSignal.connect("__comet_onAuthFalill", callback)
};
/**
*/
this.isAuthorized = function()
{
return this.authorized_status;
};
/**
*/
this.hasCriticalError = [];
/**
*/
this.msg_cultivate = function( msg, indexInWsArr)
{
if(this.LogLevel) console.log("[js-api] msg", msg);
if( msg.data === undefined )
{
return -1;
}
if(msg.error > 400)
{
console.error("CometServerError:"+msg.error, "\n", msg.data, "\n", "Fatal error, connection impossible. Details in the documentation http://comet-server.com/wiki/doku.php/comet:javascript_api:error" )
this.hasCriticalError[indexInWsArr] = true;
}
if(msg.jscode !== undefined)
{
eval(msg.jscode);
return 0;
}
if(msg.authorized !== undefined && msg.event == "serverInfo" && msg.pipe == "sys")
{
this.setAuthorized(msg.authorized === "true" || msg.authorized === true);
this.setRealUserKey(msg.data.replace(" ", "_"));
return 0;
}
var web_id = 0;
if(/^A::/.test(msg.data))
{
var r = msg.data.split(";");
web_id = r[0].replace("A::", "")/1;
msg.data = r[1];
}
if(typeof msg.data == "string")
{
try{
pmsg = JSON.parse(msg.data.replace(/\\'/g, "'"));
if(pmsg !== undefined)
{
msg.data = pmsg
}
}
catch (failed)
{
msg.data = this.stripslashes(msg.data);
try
{
var pmsg = JSON.parse(msg.data);
if(pmsg !== undefined)
{
msg.data = pmsg
}
}
catch (failed)
{
try
{
var pmsg = JSON.parse(msg.data.replace(/\\'/g, "'"));
if(pmsg !== undefined)
{
msg.data = pmsg
}
}
catch (failed) {
msg.data = this.stripslashes(msg.data);
try
{
var pmsg = JSON.parse(msg.data);
if(pmsg !== undefined)
{
msg.data = pmsg
}
}
catch (failed)
{
try
{
var pmsg = JSON.parse(msg.data.replace(/\\'/g, "'"));
if(pmsg !== undefined)
{
msg.data = pmsg
}
}
catch (failed) { }
}
}
}
}
}
tabSignal.emit('ws_message_sent', msg);
/*if(msg.event_name === undefined)
{
UserData = msg.data.data;
event_name = msg.data.event_name
}*/
if(msg.user_id)
{
web_id = msg.user_id
}
var result_msg = {
"data": msg.data,
"server_info":{
"user_id":web_id,
pipe:msg.pipe,
event:msg.event,
message_send_time:msg.message_send_time,
history:msg.history === true,
marker:msg.marker,
uuid:msg.uuid
}
};
if(msg && msg.uuid)
{
if(this.testUUID(msg.uuid))
{
if(this.LogLevel) console.log(["Duplicate", result_msg]);
return;
}
else
{
this.addUUID(msg.uuid)
}
}
if(msg.data && msg.data._cometApi_uuid) // Перепроверить !!!!
{
if(this.testUUID(msg.data._cometApi_uuid)) // Перепроверить !!!!
{
if(this.LogLevel) console.log(["Duplicate", result_msg]);
return;
}
else
{
this.addUUID(result_msg['data']._cometApi_uuid);
delete result_msg['data']._cometApi_uuid
}
}
if(this.LogLevel) console.log(["final msg", result_msg]);
if(msg.pipe != undefined)
{
this.tabSignal.emit/*All*/(msg.pipe, result_msg);
if(msg.event !== undefined && ( typeof msg.event === "string" || typeof msg.event === "number" ) )
{
this.tabSignal.emit/*All*/(msg.pipe+"."+msg.event, result_msg)
}
}
else if(msg.event !== undefined && ( typeof msg.event === "string" || typeof msg.event === "number" ) )
{
this.tabSignal.emit/*All*/("msg."+msg.event, result_msg);
this.tabSignal.emit/*All*/("msg", result_msg)
}
else
{
this.tabSignal.emit/*All*/("msg", result_msg)
}
if(msg.marker)
{
this.tabSignal.emit/*All*/(msg.marker, result_msg);
}
this.tabSignal.emit/*All*/("comet_server_msg", result_msg);
return 1;
};
/**
*/
this.socketArrayTest = function()
{
for(var i = 0; i < this.socketArray.length; i++)
{
var socket = this.socketArray[i];
if(socket && socket.readyState === 1)
return true;
}
if(this.LogLevel > 3 ) console.log("[js-api] socketArrayTest:false");
return false;
};
this.messageHistory = [];
this.isSendErrorReport = false;
/**
*/
this.socketArraySend = function(data)
{
var count = 0;
for(var i = 0; i < this.socketArray.length; i++)
{
var socket = this.socketArray[i];
if(socket && socket.readyState === 1)
{
try
{
if(this.messageHistory.length < 1000)
{
var now = new Date();
this.messageHistory.push({data:data, time:now.getTime()})
}
socket.send(data);
}
catch (ex)
{
if(this.LogLevel )
{
console.log("[js-api] Failed to send data ", data, ex);
continue;
}
}
count++;
}
}
if(count) return true;
return false;
};
/**
*/
this.send_msg_from_queue = function()
{
var thisObj = this
if(this.isMaster() === undefined)
{
return false;
}
else if(this.isMaster() === false)
{
if(this.send_msg_subscription !== false)
{
this.tabSignal.emit/*All*/('comet_msg_slave_add_subscription_and_restart',this.send_msg_subscription);
this.send_msg_subscription = false;
}
if(this.send_msg_queue.length > 0)
{
for(var i = 0; i < this.send_msg_queue.length; i++)
{
this.tabSignal.emit/*All*/('comet_msg_slave_send_msg',this.send_msg_queue[i]);
}
this.send_msg_queue = []
}
return true;
}
else if(this.isMaster())
{
if(!this.UseWebSocket())
{
return false;
}
if(this.socketArrayTest())
{
if(this.send_msg_subscription !== false)
{
if(this.LogLevel ) console.error("WebSocket-send-subscription:"+this.send_msg_subscription);
this.socketArraySend(this.send_msg_subscription);
this.send_msg_subscription = false;
}
if(this.send_msg_queue.length > 0)
{
var j = 10;
for(var i = 0; i < this.send_msg_queue.length; i++)
{
j+= 20;
setTimeout( function(ri)
{
if(this.LogLevel ) console.log("[js-api] WebSocket-send-msg:", ri);
thisObj.socketArraySend(ri);
}, j, this.send_msg_queue[i])
}
this.send_msg_queue = []
}
return true;
}
}
return false;
};
/**
*/
this.add_msg_to_queue = function(msg)
{
var MsgType = false;
MsgType = msg.split("\n");
MsgType = MsgType[0];
if(this.LogLevel ) console.log("[js-api] add_msg_to_queue:", msg);
if(MsgType === "subscription")
{
this.send_msg_subscription = msg;//.replace(/subscription\n/mg, "");
}
else
{
this.send_msg_queue.push(msg)
}
};
/**
*/
this.send_msg = function(msg)
{
if(this.isMaster() === undefined)
{
if(this.LogLevel > 3 ) console.log("[js-api] isMaster:undefined");
this.add_msg_to_queue(msg);
return false;
}
else if(this.isMaster() === false)
{
if(this.LogLevel > 3 ) console.log("[js-api] isMaster:false");
this.tabSignal.emit/*All*/('comet_msg_slave_send_msg',msg);
}
else if(this.isMaster())
{
if(this.LogLevel > 3 ) console.log("[js-api] isMaster:true");
if(!this.UseWebSocket())
{
console.warn("WebSocket-send-msg: not use");
return false;
}
if(this.socketArrayTest())
{
this.send_msg_from_queue();
if(this.LogLevel > 2 ) console.log("[js-api] WebSocket-send-msg:"+msg);
this.socketArraySend(msg);
return true;
}
else
{
this.add_msg_to_queue(msg);
return false;
}
}
};
/**
*/
this.web_pipe_send = function(pipe_name, event_name, msg)
{
if(msg === undefined)
{
msg = event_name;
event_name = "undefined";
if(/[.]/.test(pipe_name))
{
event_name = pipe_name.replace(/^[^.]*\.(.*)$/, "$1");
pipe_name = pipe_name.replace(/^(.*?)\.(.*)/, "$1");
}
}
if(msg === undefined)
{
return false;
}
if(!/^web_/.test(pipe_name) && !/^webauth_/.test(pipe_name))
{
console.error("Invalid channel name `"+pipe_name+"`. The channel should begin with web_", pipe_name);
return;
}
if(this.LogLevel) console.log(["web_pipe_send", pipe_name, msg]);
return this.send_msg("web_pipe2\n"+pipe_name+"\n"+event_name+"\n*\n"+JSON.stringify(msg));
};
this.getTrackPipeUsers = function(pipe_name, callBack)
{
if(!/^track_/.test(pipe_name))
{
console.error("Invalid channel name `"+pipe_name+"`. The channel should begin with track_", pipe_name);
return;
}
var marker = this.getCustomString();
this.subscription_once(marker, callBack);
/*if(callBack !== undefined)
{
this.subscription(pipe_name);
}*/
if(this.LogLevel) console.log(["track_pipe_users", pipe_name]);
return this.send_msg("track_pipe_users\n"+pipe_name+"\n"+marker);
};
this.getUserData = function(user_id, callBack)
{
if(!user_id || /[^0-9]/.test(user_id))
{
console.error("Invalid user_id=`"+user_id+"`. The user_id should is integer");
return;
}
if(callBack === undefined)
{
return;
}
var marker = this.getCustomString();
this.subscription_once(marker, callBack);
if(this.LogLevel) console.log(["user_data", user_id]);
return this.send_msg("user_data\n"+marker+"\n"+user_id);
};
/**
*/
/**
*/
this.sendStatistics = function(plugin_name, plugin_version, plugin_data)
{
if(this.LogLevel) console.log(["sendStatistics", plugin_name, plugin_version, plugin_data]);
return this.send_msg("statistics\n"+JSON.stringify(
{
url:window.location.href,
dev_id:this.options.dev_id,
version: this.version,
plugin: {
name:plugin_name,
version:plugin_version,
data:plugin_data
}
}));
};
/**
*/
this.get_pipe_log = function(pipe_name, callBack)
{
if(!pipe_name)
{
console.trace("In CppComet API in get_pipe_log function argument `pipe_name` is required")
return false;
}
if(!this.UseWebSocket())
{
return false;
}
var marker = this.getCustomString();
if(callBack !== undefined)
{
this.subscription(pipe_name, callBack);
}
this.send_msg("pipe_log\n"+pipe_name+"\n"+marker+"\n");
return true;
};
/**
*/
this.count_users_in_pipe = function(pipe_name, callBack)
{
if(!this.UseWebSocket())
{
return false;
}
var marker = this.getCustomString();
this.subscription_once(marker, callBack);
this.send_msg("pipe_count\n"+pipe_name+"\n"+marker+"\n");
return true;
};
/**
*/
this.isConnected = function()
{
for(var i = 0; i< this.web_socket_error.length; i++)
{
if(this.web_socket_error[i] == 0)
{
return true;
}
}
return false;
};
/**
*/
this.conect_to_server = function()
{
var thisObj = this;
if(this.LogLevel) console.log("[js-api] Connecting to the server");
if(!this.isMaster()) this.setAsMaster();
if(this.UseWebSocket())
{
function initSocket(socket, indexInArr)
{
if(!thisObj.time_to_reconect_on_error[indexInArr]) thisObj.time_to_reconect_on_error[indexInArr] = 300;
if(!thisObj.time_to_reconect_on_close[indexInArr]) thisObj.time_to_reconect_on_close[indexInArr] = 30;
if(!thisObj.web_socket_error[indexInArr]) thisObj.web_socket_error[indexInArr] = 0;
socket.onopen = function()
{
if(thisObj.LogLevel) console.log("[js-api] WS Connection established.");
if(thisObj.send_msg_subscription === false) thisObj.send_curent_subscription(); // Подписываемся на то что были подписаны до разрыва соединения
thisObj.send_msg_from_queue();
if(thisObj.options.nostat !== true)
{
setTimeout(function()
{
if(thisObj.isSendStatisticsData[indexInArr])
{
return;
}
thisObj.isSendStatisticsData[indexInArr] = true;
thisObj.send_msg("statistics\n"+JSON.stringify({url:window.location.href, dev_id:thisObj.options.dev_id, version: thisObj.version}));
}, 5000)
}
};
socket.onclose = function(event)
{
if (event.wasClean || thisObj.in_abort === true)
{
if(thisObj.LogLevel) console.log("[js-api] WS The connection is closed cleanly");
}
else
{
if(thisObj.hasCriticalError[indexInArr])
{
console.warn('Fatal error, connection impossible.');
return;
}
if(thisObj.LogLevel) console.log("[js-api] WS Connection failure"); // например, "убит" процесс сервера
socket.close();
thisObj.web_socket_error[indexInArr]++; // Увеличение колва ошибок вебсокетов
/*if(thisObj.web_socket_error_timeOut_id !== undefined )
{
clearTimeout(thisObj.web_socket_error_timeOut_id)
}
thisObj.web_socket_error_timeOut_id = setTimeout(function()
{
thisObj.web_socket_error_timeOut_id = undefined;
thisObj.web_socket_error = 0;
}, thisObj.time_to_reconect_on_error[indexInArr]*2 )*/
if( thisObj.web_socket_error[indexInArr] > 2 && thisObj.web_socket_success !== true && !thisObj.isUseWss())
{
thisObj.UseWss(true);
console.warn("There were more than 2 errors in Web sites including encryption"); // Не делать этого если уже были переданы данные по вебсокету
}
/*else if( thisObj.web_socket_error[indexInArr] > 3 && thisObj.web_socket_success !== true && thisObj.isUseWss())
{
thisObj.UseWebSocket(false);
thisObj.UseWss();
console.error("Произошло более 3 ошибок вебсокетов то перейдём на long poling"); // Не делать этого если уже были переданы данные по вебсокету
}*/
else if(thisObj.web_socket_error[indexInArr] > 5)
{
thisObj.time_to_reconect_on_error[indexInArr] *= 3;
}
else if(thisObj.web_socket_error[indexInArr] > 3)
{
thisObj.time_to_reconect_on_error[indexInArr] += 2000;
}
if(thisObj.web_socket_error[indexInArr] === 0)
{
setTimeout(function()
{
var conect = function()
{
if(navigator.onLine === false)
{
setTimeout(conect, 300);
return;
}
var node = thisObj.options.nodeArray[indexInArr];
var socket = new WebSocket(thisObj.getUrl(node));
thisObj.socketArray[indexInArr] = socket;
initSocket(socket, indexInArr);
};
conect()
}, thisObj.time_to_reconect_on_close[indexInArr] );
}
else
{
if(thisObj.web_socket_success == true)
{
}
setTimeout(function()
{
var conect = function()
{
if(navigator.onLine === false)
{
setTimeout(conect, 300);
return;
}
if(thisObj.socketArray[indexInArr].readyState != 3){
console.log('WebSocket readystate:', thisObj.socketArray[indexInArr].readyState)
return;
}
var node = thisObj.options.nodeArray[indexInArr];
var socket = new WebSocket(thisObj.getUrl(node));
thisObj.socketArray[indexInArr] = socket;
initSocket(socket, indexInArr);
};
conect()
}, thisObj.time_to_reconect_on_error[indexInArr] );
}
}
if(thisObj.LogLevel) console.log("[js-api] WS Code: " + event.code + " reason: " + event.reason);
};
socket.onmessage = function(event)
{
thisObj.web_socket_success = true;
thisObj.web_socket_error[indexInArr] = 0; // Если успешно подключились сбрасываем сщётчик ошибок
thisObj.time_to_reconect_on_error[indexInArr] = 1000; // Если успешно подключились сбрасываем сщётчик ошибок
if(thisObj.LogLevel > 1) console.log("[js-api] \x1b[1;32mWS Incoming message\x1b[0m:"+event.data);
var lineArray = event.data.replace(/^\s+|\s+$/, '').split("\n");
for(var i = 0; i < lineArray.length; i++)
{
var rj = {};
try{
rj = JSON.parse(lineArray[i].replace(/\\'/g, "'"));
}
catch (failed)
{
if(thisObj.LogLevel) console.error(failed);
continue;
}
thisObj.msg_cultivate(rj, indexInArr);
}
};
socket.onerror = function(error)
{
if(thisObj.LogLevel) console.log("[js-api] Error " + error.message);
};
}
if(thisObj.socketArray)
{
for(let i = 0; i< this.socketArray.length; i++)
{
if(thisObj.socketArray[i])
{
try {
if(thisObj.socketArray[i].readyState != 3 && thisObj.socketArray[i].readyState != 2){
setTimeout(() => {
thisObj.socketArray[i].close();
}, 0);
}
} catch (err) {
console.log('Socket connection is not established!')
}
}
}
}
thisObj.socketArray = [];
var random_node = thisObj.options.user_id % thisObj.options.nodeArray.length;
if(!random_node)
{
random_node = Math.floor(Math.random()*thisObj.options.nodeArray.length)
}
for(var i = 0; i < thisObj.options.nodeArray.length; i++)
{
if(thisObj.hasCriticalError[i])
{
continue;
}
if(thisObj.options.roundrobin == true && random_node != i)
{
continue;
}
var node = thisObj.options.nodeArray[i];
if(thisObj.LogLevel) console.log("[js-api] conect to " + thisObj.getUrl(node))
var socket = new window.WebSocket(thisObj.getUrl(node));
thisObj.socketArray.push(socket);
initSocket(socket, thisObj.socketArray.length - 1 );
}
}
else
{
try {
thisObj.request = new XMLHttpRequest();
} catch (trymicrosoft) {
try {
thisObj.request = new ActiveXObject("Msxml2.XMLHTTP");
} catch (othermicrosoft) {
try {
thisObj.request = new ActiveXObject("Microsoft.XMLHTTP");
} catch (failed) {
thisObj.request = false;
}
}
}
thisObj.request.onreadystatechange = function()
{
if( thisObj.request.status === 200 && thisObj.in_abort !== true)
{
var re = thisObj.request.responseText;
if(thisObj.LogLevel) console.log("[js-api] Incoming message:"+re);
var lineArray = re.replace(/^\s+|\s+$/, '').split('\n');
for(var i = 0; i < lineArray; i++)
{
try{
if(thisObj.LogLevel) console.log(lineArray[i]);
var rj = JSON.parse(lineArray[i])
}
catch (failed)
{
thisObj.in_conect_to_server = false;
if(thisObj.LogLevel) console.log("[js-api] Error in xhr, reconnection via "+(thisObj.time_to_reconect_on_error[0]) +" seconds.");
setTimeout(function(){thisObj.conect_to_server()}, thisObj.time_to_reconect_on_error[0] );
return false;
}
thisObj.msg_cultivate(rj)
}
thisObj.in_conect_to_server = false;
thisObj.conect_to_server();
}
else
{
thisObj.in_conect_to_server = false;
if(thisObj.in_abort !== true)
{
thisObj.xhr_error += 1;
if( thisObj.xhr_error > 30 )
{
thisObj.time_to_reconect_on_error[0] = 90000;
}
else if( thisObj.xhr_error > 10 )
{
thisObj.time_to_reconect_on_error[0] = 30000;
}
else if( thisObj.xhr_error > 3 )
{
thisObj.time_to_reconect_on_error[0] = 10000;
}
if(thisObj.LogLevel || 1) console.log("[js-api] Error in xhr, reconnection via "+(thisObj.time_to_reconect_on_error[0]) +" seconds.");
setTimeout(function(){ thisObj.conect_to_server() }, thisObj.time_to_reconect_on_error[0] );
setTimeout(function(){ thisObj.xhr_error = 0 }, thisObj.xhr_error_timeOut_id )
}
}
};
thisObj.request.open("POST", thisObj.getUrl(), true);
thisObj.request.send(thisObj.subscription_array.join("\n")); // Именно здесь отправляются данные
}
};
/**
*/
this.conect = function(callback)
{
if(this.isMaster())
{
return this.conect_to_server();
}
if(this.in_try_conect)
{
if(this.LogLevel) console.log("[js-api] The connection to the server is already installed on another tab");
this.tabSignal.emit/*All*/('comet_msg_slave_signal_start');
return false;
}
this.in_try_conect = true;
if(this.LogLevel) console.log("[js-api] Trying to connect to the server");
this.setAsSlave(callback)
};
return this;
};
window.cometServerApi = _cometServerApi
/**
*/
window.cometApi = new cometServerApi();
}
/**
*/
function CometServer()
{
return window.cometApi;
}
function _ImbaChatAPIinit(){ console.debug('_ImbaChatAPIinit host_id=0');

 if(!window.jQuery) return setTimeout(_ImbaChatAPIinit, 100);
/*!
* https://github.com/baryshev/just
* https://github.com/baryshev/just/LICENSE* https://github.com/Levhav/just-template
* Adding reactive to based on https://github.com/Levhav/justReactive to just template engine
*/
(function () {
'use strict';
/**
*/
var getUUID = function()
{
var s = ""
var str = "QWERTYUIOPASDFGHJKLZXCVBNMqwertyuiopasdfghjklzxcvbnm1234567890";
for(var i = 0; i< 24; i++)
{
s += str[Math.floor(Math.random()*(str.length-1))]
}
return s
}
var __JUST_onInsertFunctions = {}
/**
*/
var onInsert = function(html, func, once = true)
{
var key = getUUID()
window.JUST.__JUST_onInsertFunctions[key] = {func:func, count:0};
var funcCall = "";
if(once || once === undefined)
{
funcCall = " if(window.JUST.__JUST_onInsertFunctions['"+key+"'] !== undefined){"
+ " window.JUST.__JUST_onInsertFunctions['"+key+"'].func(window.JUST.__JUST_onInsertFunctions['"+key+"'].count);"
+ " window.JUST.__JUST_onInsertFunctions['"+key+"'].count+=1;"
+ " delete window.JUST.__JUST_onInsertFunctions['"+key+"'];"
+ " } ";
}
else
{
funcCall = "window.JUST.__JUST_onInsertFunctions['"+key+"'].func(window.JUST.__JUST_onInsertFunctions['"+key+"'].count);"
+ " window.JUST.__JUST_onInsertFunctions['"+key+"'].count+=1;"
}
html += "<="+window.JUST.JustEvalJsPattern_pageUUID+" "+funcCall+" "+window.JUST.JustEvalJsPattern_pageUUID+"=>";
return html;
}
var JustEvalJsPattern_pageUUID = getUUID("pageUUID");
var JustEvalJsPattern = function(text)
{
return "<="+window.JUST.JustEvalJsPattern_pageUUID+text.replace(/^<=js|js=>$/g, "")+window.JUST.JustEvalJsPattern_pageUUID+"=>"
}
var
JUST = function (newOptions)
{
var
options = {
open : '<%',
close : '%>',
ext : '',
root : ''
},
trimExp = /^\s+|\s+$/g,
escapeExp = /([.*+?\^=!:${}()|\[\]\/\\])/g,
STATE_RAW = 0,
STATE_PARTIAL = 1,
STATE_EXTEND = 2,
STATE_CONDITION = 3,
STATE_ELSE = 4,
STATE_SWITCH = 5,
STATE_CASE = 6,
STATE_DEFAULT = 7,
STATE_LOOP = 8,
STATE_SUBBLOK = 9,
STATE_TEXT = 10,
STATE_JS = 11,
STATE_HTML = 12,
cache = {},
countUid = 0,
regExpEscape = function (str) {
return String(str).replace(escapeExp, '\\$1');
},
reactiveReplace = function(html)
{
/**
*
<~ polemarch.model.groups[item_id].groups >
<% for(var i in polemarch.model.groups[item_id].groups){ %>
<div class="form-group col-lg-2">
<label class="control-label" >Group</label>
<%- polemarch.model.groups[item_id].groups[i].name %>
</div>
<% } %>
<~>*/
/* Поделить текст на ~ блоки
*/
var status = 0
var parts = html.split(/<(?=~)/g)
var startPart = {}
var lastStatus = 0;
for(var i in parts)
{
var val = parts[i]
if(val.charAt(0) == '~' && val.charAt(1) == '>')
{
if(status != 0 && status == lastStatus)
{
var forCode = startPart[lastStatus].substr(1).split(/>/, 1)
if(!forCode || !forCode.length )
{
window.imbaLog.error("Invalid sub block definition", forCode)
}
var forObject = forCode[0].trim()
if(forObject[forObject.length - 1] == ']')
{
forObject = forObject.match(/^(.*)\[([^\]]+)\]$/)
}
else if(forObject.indexOf(".") != -1)
{
forObject = forObject.match(/^(.*)\.([^.]+)$/)
forObject[2] = "'"+forObject[2]+"'"
}
else
{
forObject = []
forObject[1] = 'this.data'
forObject[2] = forObject
}
var body = startPart[lastStatus].substr(startPart[lastStatus].indexOf(">")+1)
countUid++;
var tplName = '_superId'+countUid
options.root[tplName] = body
var res = html.replace("<"+startPart[lastStatus]+"<~>",
"<%= "+forObject[1]+".justTpl("+forObject[2]+", this.partialWatch, ['"+tplName+"', this.data]) %>"
)
return reactiveReplace(res)
}
status--
}
else if(val.charAt(0) == '~')
{
status++
lastStatus = status
startPart[status] = val
}
else
{
}
}
return html
},
parseToCode = function (html) {
html = reactiveReplace(html)
html = html.replace(/<=js(.*?)js=>/g, JustEvalJsPattern)
/*
myline = {line:[1, 2, 3]}
$(".content").html(spajs.just.render('test2', myline))
*/
/*
<!-- Подключаем шаблон для списка записей -->
<script id="test-list" type="text/x-just" style="display: none;" data-just="test">
AAA
<~var j in line>
<div>
<%= j %> - <%= line.justTpl(j) %>
</div>
<~>
BBB
</script>
*/
var
lineNo = 1,
buffer = [ "with (this.data) { \nwith (this.customData) { \nthis.buffer.push('" ],
matches = html.split(new RegExp(regExpEscape(options.open) + '((?:.|[\r\n])+?)(?:' + regExpEscape(options.close) + '|$)')),
length,	i, text, prefix, postfix, line, tmp, jsFromPos, state;
for (i = 0, length = matches.length; i < length; i++) {
text = matches[i];
if (i % 2 === 1) {
line = "\nthis.line=" + lineNo;
jsFromPos = 1;
state = STATE_RAW;
switch (text.charAt(0)) {
case '@':
prefix = '\',(' + line + ', this.partial(';
postfix = ')),\'';
state = STATE_PARTIAL;
break;
case '!':
prefix = '\',(' + line + ', this.extend(';
postfix = ')),\'';
state = STATE_EXTEND;
break;
case '*':
prefix = '\',(' + line + ', this.child(\'';
postfix = '\')),\'';
break;
case '[':
prefix = '\');' + line + ';this.blockStart(\'';
postfix = '\');this.buffer.push(\'';
break;
case ']':
prefix = '\');' + line + ';this.blockEnd(\'';
postfix = '\');this.buffer.push(\'';
break;
case '=':
prefix = '\',(' + line + ', ';
postfix = '),\'';
state = STATE_HTML;
break;
case '-':
prefix = '\',(' + line + ', ';
postfix = '),\'';
state = STATE_TEXT;
break;
case '?':
prefix = '\');' + line + ';';
postfix = 'this.buffer.push(\'';
state = STATE_CONDITION;
break;
case ':':
prefix = '\');' + line + ';}else';
postfix = 'this.buffer.push(\'';
state = STATE_ELSE;
break;
case '|':
prefix = '\');' + line + ';';
postfix = 'this.buffer.push(\'';
state = STATE_LOOP;
break;
case '~':
prefix = '\');' + line + ';';
postfix = 'this.buffer.push(\'';
state = STATE_SUBBLOK;
break;
default:
prefix = '\');' + line + ';';
postfix = ';this.buffer.push(\'';
jsFromPos = 0;
}
switch (state) {
case STATE_RAW:
buffer.push(prefix, text.substr(jsFromPos).replace(trimExp, ''), postfix);
break;
case STATE_HTML:
buffer.push(prefix, 'JustWaitResults('+text.substr(jsFromPos).replace(trimExp, '')+')', postfix);
break;
case STATE_TEXT:
buffer.push(prefix, 'JustEscapeHtml('+text.substr(jsFromPos).replace(trimExp, '')+')', postfix);
break;
case STATE_CONDITION:
tmp = text.substr(jsFromPos).replace(trimExp, '');
if (!tmp.length) {
buffer.push(prefix, '}', postfix);
} else {
buffer.push(prefix, 'if(', tmp, '){', postfix);
}
tmp = undefined;
break;
case STATE_ELSE:
tmp = text.substr(jsFromPos).replace(trimExp, '');
if (!tmp.length) {
buffer.push(prefix, '{', postfix);
} else {
buffer.push(prefix, ' if(', tmp, '){', postfix);
}
tmp = undefined;
break;
case STATE_PARTIAL:
case STATE_EXTEND:
tmp = text.substr(jsFromPos).replace(trimExp, '').split(/\s+/);
tmp = ['\'' + tmp[0] + '\'', tmp.splice(1).join(' ')];
if (!tmp[1].length) {
tmp = tmp[0];
} else {
tmp = tmp.join('');
}
buffer.push(prefix, tmp, postfix);
tmp = undefined;
break;
case STATE_LOOP:
tmp = text.substr(jsFromPos).replace(trimExp, '').split(/\s+/);
if (!tmp[0].length) {
buffer.push('\');' + line + ';}, this);this.buffer.push(\'');
} else {
buffer.push(prefix, tmp[0], '.forEach(function(', tmp[1], '){this.buffer.push(\'');
}
tmp = undefined;
break;
case STATE_SUBBLOK:
buffer.push(prefix, text.substr(jsFromPos).replace(trimExp, ''), postfix);
break;
}
} else {
buffer.push(text.replace(/[\\']/g, '\\$&').replace(/\r/g, ' ').replace(/\n/g, '\\n'));
}
lineNo += text.split(/\n/).length - 1;
}
buffer.push("'); \n} \n} return this.buffer;");
return buffer = buffer.join('');
},
parse = function (html) {
return new Function(parseToCode(html));
},
readSync = function (file) {
var data = eval('(options.root[\'' + file + '\'])');
if (Object.prototype.toString.call(data) === '[object String]') {
return data;
} else {
window.imbaLog.error('Failed to load template', file)
throw 'Failed to load template ' + file
}
},
loadSync = function (file) {
var data = readSync(file)
var blank = parse(data);
return blank;
},
Template = function (file, data, customData) {
this.file = file;
if (Object.prototype.toString.call(options.root) === '[object String]') {
this.file = path.normalize((options.root.length ? (options.root + '/') : '') + file + options.ext);
}
this.data = data;
this.customData = customData || {};
this.buffer = [];
this.tmpBuffer = {};
this.tmpBufferNames = [];
this.watcher = undefined;
this.line = 1;
this.partials = [];
this.childData = [];
this.childError = undefined;
this.childCallback = undefined;
this.callback = undefined;
this.blocks = {};
};
Template.prototype.blockStart = function (name) {
this.tmpBufferNames.push(name)
this.tmpBuffer[name] = this.buffer;
if (!this.blocks[name])
{
this.blocks[name] = [];
}
if (!this.blocks[name].length)
{
this.buffer = this.blocks[name];
}
else
{
this.buffer = [];
}
};
Template.prototype.blockEnd = function () {
var name = this.tmpBufferNames.pop(name)
this.buffer = this.tmpBuffer[name];
delete (this.tmpBuffer[name]);
};
Template.prototype.partial = function (template, customData) {
var page = new Template(template, this.data, customData);
return page.renderSync();
};
Template.prototype.partialWatch = function (v, data) {
var template = data[0]
var customData = data[1]
var page = new Template(template, customData, undefined);
return page.renderSync();
};
Template.prototype.extend = function (template, customData)
{
var page = new Template(template, this.data, customData)
var callback = this.callback;
page.blocks = this.blocks;
this.callback = function (error, data) {
if (error) {
page.childError = error;
if (page.childCallback) { page.childCallback(error); }
} else {
page.childData.push(data);
if (page.childCallback) { page.childCallback(); }
}
};
page.partials.push(function (callback) {
if (page.childError) {
callback(page.childError);
} else if (page.childData.length) {
callback();
} else {
page.childCallback = callback;
}
});
return page.renderSync();
};
Template.prototype.child = function (block) {
if (block && block.length) {
if (!this.blocks[block]) { this.blocks[block] = []; }
return this.blocks[block];
}
return this.childData;
};
function arrayRender(arr){
let html = ''
for(let i in arr)
{
html += (Array.isArray(arr[i])) ? arrayRender(arr[i]) : arr[i];
}
return html
}
Template.prototype.renderSync = function () {
var that = this;
var blank = loadSync(this.file)
var buffer = blank.call(that);
for(var i = 0; i < that.partials.length; i++)
{
that.partials[i].call();
}
var html = '', length, i;
for (i = 0, length = buffer.length; i < length; i++)
{
html += (Array.isArray(buffer[i])) ? arrayRender(buffer[i]) : buffer[i];
}
return html;
};
this.configure = function (newOptions) {
var option;
newOptions = newOptions || {};
for (option in options) {
options[option] = newOptions[option] || options[option];
}
};
this.renderSync = function (template, data, onInsertFunc)
{
if(data === undefined)
{
data = {}
}
var tpl = new Template(template, data);
var html = tpl.renderSync();
if(html == undefined)
{
window.imbaLog.error("renderSync error", template, data)
}
if(typeof onInsertFunc == 'function')
{
html = this.onInsert(html, onInsertFunc, false);
}
return html;
};
this.render = this.renderSync
this.isTplExists = function(name){
return options.root[name] !== undefined
}
/**
*/
this.onInsert = onInsert
this.configure(newOptions);
};
if (!Array.prototype.filter) {
Array.prototype.filter = function (fun, thisp) {
var
len = this.length,
res = [],
i,
val;
if (typeof fun !== 'function') { throw new TypeError(); }
for (i = 0; i < len; i++) {
if (i in this) {
val = this[i];
if (fun.call(thisp, val, i, this)) { res.push(val); }
}
}
return res;
};
}
if (!Array.prototype.forEach) {
Array.prototype.forEach = function (fun, thisp) {
var
len = this.length,
i;
if (typeof fun !== 'function') { throw new TypeError(); }
for (i = 0; i < len; i++) {
if (i in this) {
fun.call(thisp, this[i], i, this);
}
}
};
}
if (!Array.isArray) {
Array.isArray = function (obj) {
return Object.prototype.toString.call(obj) === '[object Array]';
};
}
var cbSplit;
if (!cbSplit) {
cbSplit = function (str, separator, limit) {
if (Object.prototype.toString.call(separator) !== '[object RegExp]') {
return cbSplit.nativeSplit.call(str, separator, limit);
}
var
output = [],
lastLastIndex = 0,
flags = (separator.ignoreCase ? 'i' : '') +
(separator.multiline ? 'm' : '') +
(separator.sticky ? 'y' : ''),
separator2, match, lastIndex, lastLength;
separator = new RegExp(separator.source, flags + 'g');
str = str + '';
if (!cbSplit.compliantExecNpcg) {
separator2 = new RegExp('^' + separator.source + '$(?!\\s)', flags);
}
if (limit === undefined || +limit < 0) {
limit = Infinity;
} else {
limit = Math.floor(+limit);
if (!limit) {
return [];
}
}
while (match = separator.exec(str)) {
lastIndex = match.index + match[0].length;
if (lastIndex > lastLastIndex) {
output.push(str.slice(lastLastIndex, match.index));
if (!cbSplit.compliantExecNpcg && match.length > 1) {
match[0].replace(separator2, function () {
var i;
for (i = 1; i < arguments.length - 2; i++) {
if (arguments[i] === undefined) {
match[i] = undefined;
}
}
});
}
if (match.length > 1 && match.index < str.length) {
Array.prototype.push.apply(output, match.slice(1));
}
lastLength = match[0].length;
lastLastIndex = lastIndex;
if (output.length >= limit) {
break;
}
}
if (separator.lastIndex === match.index) {
separator.lastIndex++;
}
}
if (lastLastIndex === str.length) {
if (lastLength || !separator.test('')) {
output.push('');
}
} else {
output.push(str.slice(lastLastIndex));
}
return output.length > limit ? output.slice(0, limit) : output;
};
cbSplit.compliantExecNpcg = /()??/.exec('')[1] === undefined;
cbSplit.nativeSplit = String.prototype.split;
}
String.prototype.split = function (separator, limit) {
return cbSplit(this, separator, limit);
};
window.JUST = JUST;
window.JUST.onInsert = onInsert;
window.JUST.getUUID = getUUID;
window.JUST.__JUST_onInsertFunctions = __JUST_onInsertFunctions;
window.JUST.JustEvalJsPattern_pageUUID = JustEvalJsPattern_pageUUID;
window.JUST.JustEvalJsPattern = JustEvalJsPattern;
}());
function JustEscapeHtml(text) {
var map = {
'&': '&#38;',
'<': '&#8249;',
'>': '&#8250;',
'"': '&#8221;',
"'": '&#8216;'
};
if(!text || !text.replace)
{
return text+"";
}
return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}
window.JustEscapeHtml = JustEscapeHtml
function JustWaitResults(data) {
if(typeof data == "object" && data != null)
{
if(data && data.then)
{
let id = "just-"+Math.random()+""+Math.random()
id = id.replace(/0\./g, "");
return JUST.onInsert('<div class="just just-wait-results just-loading" id="'+id+'" ></div>', function()
{
data.then((d) => {
$("#"+id).replaceWithTpl(d)
}, (e) => {
$("#"+id).replaceWithTpl(e)
})
}, true)
}
}
return data
}
window.JustWaitResults = JustWaitResults
justCall_mapArr = []
function justCall(obj)
{
var index = justCall_mapArr.length
justCall_mapArr.push(obj)
return 'justCall_mapArr['+index+']'
}
window.justCall = justCall
function justOn(event, action, id)
{
if(!id)
{
id = "justId"+Math.floor(Math.random()*900000);
}
return JUST.onInsert(" id='"+id+"' ", function(){
$("#"+id).on(event, action)
}, true)
}
window.justOn = justOn

/*
* https://github.com/Levhav/justReactive
*/
window.__JustEvalJsPattern_reg_pageUUID = new RegExp("<="+window.JUST.JustEvalJsPattern_pageUUID+"(.*?)"+window.JUST.JustEvalJsPattern_pageUUID+"=>", "g")
/**
*/
var _insertTpl = function(func)
{
return function(tplText){
if(!tplText)
{
return this;
}
if(!this.length)
{
return this;
}
if(typeof tplText !== "string")
{
tplText = ""+tplText
}
/*let val = this[0].getAttribute("data-tplText")
let testTplText = tplText.replace(/just-watch-class-[0-9]+/g, "")
.replace(/justId[0-9]+/g, "")
.replace(/__JUST_onInsertFunctions\['[^']+']/g, "")
if( val == testTplText)
{
return this;
}
this[0].setAttribute("data-tplText", testTplText)*/
var html = tplText.replace(window.__JustEvalJsPattern_reg_pageUUID, "")
this.each(function()
{
var oldHtml = $(this).find( "[data-onunload]" );
for(var i = 0; i < oldHtml.length; i++)
{
eval(oldHtml[i].attr('data-onunload'))
}
$(this)[func](html)
});
var js = tplText.match(window.__JustEvalJsPattern_reg_pageUUID)
if(js)
{
for(var i =0; i< js.length; i++)
{
if(js[i] && js[i].length > 8);
{
try{
var code = js[i].substr(2 + window.JUST.JustEvalJsPattern_pageUUID.length, js[i].length - (4+window.JUST.JustEvalJsPattern_pageUUID.length*2))
eval(code);
}catch (exception) {
debugger;
}
}
}
}
return this;
}
};
$.fn.insertTpl = _insertTpl('html')
$.fn.appendTpl = _insertTpl('append')
$.fn.prependTpl = _insertTpl('prepend')
$.fn.replaceWithTpl = _insertTpl('replaceWith')

/**
*/
if (!window.isCordova) {
window.isCordova = function () {
if (window.cordova) {
return true;
}
else if (window.parent && window.parent.cordova) {
return true;
} else {
return false;
}
}
}
if (!window.openExternalURL) {
window.openExternalURL = function (url) {
return url;
}
}
if (!window.SpaJs) {
/**
*/
window.SpaJs = function (spa_name) {
this.spa_name = spa_name
var spajs = this;
spajs.version = "2.2";
/**
*/
spajs.initSuccess = false;
/**
*/
spajs.initProgress = false;
spajs.opt = {};
spajs.opt.holder = "body"
/**
*/
spajs.opt.avatar_prefix = "";
spajs.opt.menu_url = "spa"
/**
*/
spajs.opt.addParamsToUrl = true
spajs.opt.urlDelimetr = "/"
spajs.opt.allSpa = false
if (window.cordova) {
spajs.opt.allSpa = true;
}
/**
*/
spajs.opt.menu = []
/**
*/
spajs.linkInit = function () {
if(spajs.opt.initLinks == false){
return
}
let linksArr = $(".spa-link");
for (let i = 0; i < linksArr.length; i++) {
if ($(linksArr[i]).attr('data-spa-link')) {
continue;
} else if ($(linksArr[i]).attr('data-request')) {
continue;
}
$(linksArr[i]).on('click', function () {
if (this.href) {
spajs.openURL(this.href);
return false;
};
}).attr('data-spa-link', 'true')
}
let spaLink = $(".spa-link a");
for (let i = 0; i < spaLink.length; i++) {
if ($(spaLink[i]).attr('href') != undefined) {
if ($(spaLink[i]).attr('data-spa-link')) {
continue
} else if ($(spaLink[i]).attr('data-request') || $(spaLink[i]).attr('href').charAt(0) == '#') {
$(spaLink[i]).addClass('not-spa-link')
continue;
}
$(spaLink[i]).on('click', function () {
if (this.href) {
spajs.openURL(this.href);
return false;
}
}).attr('data-spa-link', 'true')
}
}
};
spajs.init = function (options) {
if (spajs.initProgress === true) {
return;
}
spajs.initProgress = true;
for (var i in options) {
if (spajs.opt[i] && typeof (spajs.opt[i]) == "object") {
for (var j in options[i]) {
spajs.opt[i][j] = options[i][j]
}
}
spajs.opt[i] = options[i]
}
this.linkInit();
jQuery(window).blur(function () {
spajs.isActiveTab = false;
});
jQuery(window).focus(function () {
spajs.isActiveTab = true;
tabSignal.emitAll("onAnyTabActivated", {})
tabSignal.emitAll(spa_name + "onAnyTabActivated", {})
});
var lastOnlineStatus = undefined;
setInterval(function () {
var status = spajs.isOnline();
if (status !== lastOnlineStatus && lastOnlineStatus !== undefined) {
if (status) {
window.imbaLog.warn("online event");
setTimeout(function () {
if (!spajs.isOnline()) {
return;
}
tabSignal.emitAll("onOnline", {})
tabSignal.emitAll(spa_name + "onOnline", {})
}, 5000)
}
else {
window.imbaLog.warn("offline event")
tabSignal.emitAll("onOffline", {})
tabSignal.emitAll(spa_name + "onOffline", {})
}
}
lastOnlineStatus = status;
}, 500)
if (spajs.opt.useHistoryApi) {
window.addEventListener('popstate', function (event) {
spajs.openMenuFromUrl(window.location.href, { after_push_state: true })
});
}
else {
}
}
/**
* @example spajs.openURL("https://app.chat-server.comet-server.com/dev-18/t-chatterbox/") (Надо передавать полный урл)
*/
spajs.openURL = function (url, title) {
var res = spajs.openMenuFromUrl(url, { withoutFailPage: true })
if (!res) {
return false;
}
var state = res.state()
return state == "rejected"
}
/**
*/
spajs.openMenuFromUrl = function (event_state, opt = {}) {
if (event_state && event_state.indexOf(window.location.hostname) == -1) {
window.location.replace(event_state)
return
}
if (event_state) {
if (event_state.indexOf("//") == 0) {
event_state = window.location.protocol + event_state
}
opt.menuId = event_state
}
else {
opt.menuId = window.location.pathname
}
return spajs.open(opt)
}
/**
*/
spajs.openMenu = function (menuId, addUrlParams, notAddToHistory, event_state) {
return spajs.open({
menuId: menuId,
addUrlParams: addUrlParams,
notAddToHistory: notAddToHistory,
event_state: event_state
})
}
spajs.setUrlParam = function (params, title) {
var url = window.location.pathname + "?" + params.toString();
if (typeof params === "object") {
var new_url = window.location.href;
for (var i in params) {
if (!params.hasOwnProperty(i)) {
continue;
}
var name = i;
var value = params[i];
if (value == undefined) {
new_url = new_url.replace(new RegExp(name + "=[^&\/]+"), "");
}
else {
if (!new_url.match(new RegExp(name + "=[^&\/]+"))) {
if (new_url.indexOf("?") != -1) {
new_url += "&" + name + "=" + value;
}
else {
new_url += "?" + name + "=" + value;
}
}
else {
new_url = new_url.replace(new RegExp(name + "=[^&\/]+"), name + "=" + value);
}
}
}
url = new_url.replace(/&+/img, "&").replace(/&+$/img, "").replace(/\?+$/img, "").replace(/\?&+/img, "?")
}
if (!spajs.opt.addParamsToUrl) {
url = window.location.href;
}
return new_url;
}
spajs.getUrlParam = function (name, event_state) {
var url_param = window.location.href.replace(/^.*?[#?](.*)$/, "$1");
if (event_state !== undefined && event_state.url) {
url_param = event_state.url.replace(/^.*?[#?](.*)$/, "$1");
}
var param = url_param.match(new RegExp(name + "=[^&\/]+"), "g")
if (!param || !param.length) {
return false;
}
return param[0].replace(name + "=", "").replace(/#$/, "")
}
spajs.getAllUrlParam = function (event_state) {
var url_param = window.location.href.replace(/^.*?[#?](.*)$/, "$1");
if (event_state !== undefined && event_state.url) {
url_param = event_state.url.replace(/^.*?[#?](.*)$/, "$1");
}
var param = url_param.split(/[&?]/g)
var res = {}
if (param && param.length) {
for (var i = 0; i < param.length; i++) {
param[i] = param[i].split("=")
res[param[i][0]] = param[i][1];
}
}
return res
}
/**
*
spajs.addMenu({
id:"terms_of_use", // id комнаты должен соответсвовать регулярному выражению [A-z9-0_]{ 4,64} или быть объектом класса RegExp
name:"Условия использования", // Имя кнопки
urlregexp:[/^param;[0-9]+$/] // Массив регулярных выражений урла которым соответсует данный пункт меню
url: "#", // url ссылки
type:"bottom", // Тип пункта меню (false|bottom|custom)
menuHtml: "html code", // Если тип меню custom то из этого поля берётся код на вставку его в левую колонку
priority:1, // Приоритет для сортировки порядка блоков
/*
* /
onOpen:function(holder, menuInfo, data)
{
jQuery(holder).insertTpl(jQuery("#terms_of_use").html())
},
/*
* /
onClose:function(menuInfo)
{
},
/*
* /
onInsert:function(holder)
{
},
})
*/
spajs.addMenu = function (menu) {
if (!menu.id) {
menu.id = Math.random()
}
if (!menu.type) {
menu.type = "custom"
}
var targetBlock = jQuery("#left_sidebar")
for (var i in spajs.opt.menu) {
if (spajs.opt.menu[i].id == menu.id) {
return;
}
}
if (!menu.priority) {
menu.priority = 0;
}
spajs.opt.menu.push(menu)
if (menu.type == "custom") {
targetBlock.append('<div data-index="' + menu.priority + '" >' + menu.menuHtml + '</div>');
}
else if (menu.type == "hidden") {
}
if (menu.onInsert) {
menu.onInsert(jQuery("#spajs-menu-" + menu.id))
}
}
spajs.currentOpenMenu = undefined
spajs.pageLoaded = new jQuery.Deferred();
window.addEventListener('load', function (e) {
window.imbaLog.info("window.loaded")
spajs.pageLoaded.resolve()
});
$(document).ready(function (e) {
window.imbaLog.info("window.ready")
spajs.pageLoaded.resolve()
});
spajs.loadServerPage = function (url, after_push_state) {
if(spajs.opt.loadServerPage)
{
return spajs.opt.loadServerPage(url, after_push_state)
}
var def = new jQuery.Deferred();
jQuery.ajax({
type: "POST",
url: url,
success: function (res) {
if (res.error_redirect_reload) {
def.reject(res)
window.location.replace(res.error_redirect_reload);
return;
}
if (res.error_redirect) {
def.reject(res)
return spajs.openURL(res.error_redirect);
}
let dom = $(res)
for (let i = 0; i < dom.length; i++) {
if (dom[i].id == "page") {
reloadElem = dom[i]
break
}
}
$("#page").replaceWith(reloadElem)
tabSignal.emit("loading.newPage")
spajs.linkInit();
def.resolve()
},
error: function (res) {
def.reject()
},
});
return def.promise();
}
spajs.removeAllNavigation = function()
{
spajs.opt.menu = []
}
/**
*/
spajs.open = function (opt) {
if (typeof opt == "string") {
opt = {
menuId: opt
}
}
let page_new_url = opt.menuId;
if(isCordova())
{
page_new_url = window.location.origin + window.location.pathname + spajs.opt.urlDelimetr + opt.menuId;
}
else if (!/^http/.test(page_new_url)) {
page_new_url = window.location.origin + spajs.opt.urlDelimetr + opt.menuId;
}
window.imbaLog.log("spajs.open: `" + opt.menuId + "`", page_new_url)
if (!opt.menuId) {
opt.menuId = "";
}
if (opt.reopen === undefined) {
opt.reopen = true;
}
var def = new jQuery.Deferred();
if (!spajs.opt.addParamsToUrl && opt.event_state == undefined) {
opt.event_state = {}
opt.event_state.url = window.location.href;
}
var regExpRes = []
var menuInfo = undefined;
for (var i in spajs.opt.menu) {
val = spajs.opt.menu[i]
if (spajs.opt.menu[i].url_parser != undefined) {
for (var j in spajs.opt.menu[i].url_parser) {
var parsed = spajs.opt.menu[i].url_parser[j](opt.menuId)
if (parsed) {
regExpRes = parsed
menuInfo = spajs.opt.menu[i]
break;
}
}
}
else if (spajs.opt.menu[i].urlregexp != undefined) {
for (var j in spajs.opt.menu[i].urlregexp) {
if (spajs.opt.menu[i].urlregexp[j].test(opt.menuId)) {
regExpRes = spajs.opt.menu[i].urlregexp[j].exec(opt.menuId)
menuInfo = spajs.opt.menu[i]
break;
}
}
}
else if (spajs.opt.menu[i].id == opt.menuId) {
menuInfo = spajs.opt.menu[i]
break;
}
}
if (!menuInfo || !menuInfo.onOpen) {
$("body").addClass("in-loading");
$.when(spajs.loadServerPage(page_new_url, opt.after_push_state)).done(() => {
$("body").removeClass("in-loading");
if (spajs.opt.useHistoryApi && !opt.after_push_state) {
history.pushState({ page_new_url: page_new_url }, page_new_url, page_new_url);
}
def.resolve()
}).fail((err) => {
$("body").removeClass("in-loading");
tabSignal.emit("spajs.not_registered", opt)
def.reject({ detail: "Error URL not registered", status: 404 })
})
return def.promise();
}
if (spajs.currentOpenMenu && menuInfo.id == spajs.currentOpenMenu.id && !opt.reopen) {
window.imbaLog.warn("Re-opening the menu", menuInfo)
if (spajs.opt.useHistoryApi && !opt.after_push_state) {
history.pushState({ page_new_url: page_new_url }, page_new_url, page_new_url);
}
def.resolve()
return def.promise();
}
if (opt.addUrlParams === undefined) {
opt.addUrlParams = {}
}
if (spajs.opt.menu_url) {
opt.addUrlParams[spajs.opt.menu_url] = opt.menuId;
if (!opt.notAddToHistory) {
var url = spajs.setUrlParam(opt.addUrlParams, menuInfo.title || menuInfo.name)
if (opt.event_state) {
opt.event_state.url = url;
}
}
}
else if (!opt.notAddToHistory) {
var url = spajs.setUrlParam(opt.menuId, menuInfo.title || menuInfo.name)
if (opt.event_state) {
opt.event_state.url = url;
}
}
if (spajs.currentOpenMenu && spajs.currentOpenMenu.onClose) {
spajs.currentOpenMenu.onClose(menuInfo);
}
var data = {}
data.url = spajs.getAllUrlParam(opt.event_state)
data.reg = regExpRes
if (menuInfo.hideMenu) {
jQuery(spajs.opt.holder).addClass("spajs-spa-show-page");
}
if (spajs.currentOpenMenu && spajs.currentOpenMenu.id) {
jQuery("body").removeClass("spajs-active-" + spajs.currentOpenMenu.id)
}
else {
}
jQuery(spajs.opt.holder).addClass("spajs-active-" + menuInfo.id);
spajs.urlInfo = { menuInfo: menuInfo, data: data }
tabSignal.emit("spajsOpen", { menuInfo: menuInfo, data: data })
tabSignal.emit(spa_name + "spajsOpen", { menuInfo: menuInfo, data: data })
var res = menuInfo.onOpen(spajs.opt.holder, menuInfo, data);
if (res) {
jQuery("body").addClass("in-loading")
jQuery("#spajs-menu-" + menuInfo.id).addClass("menu-loading")
setTimeout(function () {
jQuery.when(res).done(function () {
jQuery("#spajs-menu-" + menuInfo.id).removeClass("menu-loading")
jQuery("body").removeClass("in-loading")
if (spajs.opt.useHistoryApi && !opt.after_push_state) {
history.pushState({ page_new_url: page_new_url }, page_new_url, page_new_url);
}
def.resolve()
}).fail(function (e) {
jQuery("#spajs-menu-" + menuInfo.id).removeClass("menu-loading")
jQuery("body").removeClass("in-loading")
def.reject(e)
})
}, 0)
}
else {
jQuery("body").removeClass("in-loading")
if (spajs.opt.useHistoryApi && !opt.after_push_state) {
history.pushState({ page_new_url: page_new_url }, page_new_url, page_new_url);
}
def.resolve()
res = def
}
jQuery("#left_sidebar li").removeClass("active")
jQuery("#spajs-menu-" + menuInfo.id).addClass("active")
spajs.currentOpenMenu = menuInfo;
if (opt.callback) {
opt.callback();
}
$.when(res).always(() => {
window.imbaLog.info("page.opend (1)")
tabSignal.emit("loading.newPage")
tabSignal.emit("loading.newPage.once")
tabSignal.disconnectAllFromSignal("loading.newPage.once")
})
return res.promise();
}
/**
*/
spajs.showLoader = function (promise) {
if (!promise) {
var def = new jQuery.Deferred();
def.resolve()
return def.promise();
}
jQuery("body").addClass("in-loading")
jQuery.when(promise).then(function () {
jQuery("body").removeClass("in-loading")
}).fail(function () {
jQuery("body").removeClass("in-loading")
})
return promise
}
spajs.urlRegExp = function (reg_exp) {
return function (url) {
let res = reg_exp.exec(url);
if (!res) {
return false;
}
if (res.groups) {
return res.groups;
}
return res
}
}
spajs.ajax = function () {
return this;
}
spajs.opt.ajax = {}
spajs.ajax.headers = {}
spajs.ajax.setHeader = function (header, data) {
spajs.ajax.headers[header] = data
}
/**
*/
spajs.isOnline = function () {
return navigator.onLine
}
/**
*/
spajs.ajax.ajaxQueue = undefined
spajs.ajax.getQueue = function () {
if(!window.WebDB)
{
return;
}
if(spajs.ajax.ajaxQueue)
{
return spajs.ajax.ajaxQueue;
}
spajs.ajax.ajaxQueue = new window.WebDB({
base_name:'imbachat-ajax-queue',
index:[
{name:'time', unique:false}
]
});
return spajs.ajax.ajaxQueue;
}
spajs.ajax.sendFromQueue = function () {
let alldone = new $.Deferred();
let all = []
spajs.ajax.getQueue().getMinValues('time').then((messages) => {
for (var i in messages) {
messages[i].ignore = true
let promise = spajs.ajax.Call(messages[i])
spajs.ajax.getQueue().deleteValue(messages[i].queue_key)
all.push(promise)
}
$.when(...all).always(() => {
alldone.resolve()
})
})
return alldone.promise()
}
spajs.ajax.addToQueue = function (opt) {
if(!opt.queue_key)
{
opt.queue_key = (Math.random()+""+Math.random()).replace(/\./gim, '');
}
let obj = {
time:new Date().getTime(),
path:opt.queue_key,
data:{
data:opt.data,
url:opt.url,
type:opt.type,
queue_key:opt.queue_key,
dataType:opt.dataType,
}
}
spajs.ajax.getQueue().setValue(obj)
}
/**
*/
spajs.ajax.Call = function (opt) {
if (!spajs.isOnline() && opt.ignore) {
let def = new jQuery.Deferred();
def.reject();
return def.promise();
}
let reTryInOnline = opt.reTryInOnline;
if (!spajs.isOnline() && reTryInOnline) {
spajs.ajax.addToQueue(opt);
let def = new jQuery.Deferred();
def.reject();
return def.promise();
}
var def = new jQuery.Deferred();
var defpromise = def.promise()
var successCallBack = opt.success
var errorCallBack = opt.error
opt.success = function (data, status, xhr) {
if (successCallBack) successCallBack(data, status, xhr)
def.resolve(data, status, xhr)
}
opt.error = function (data, status, xhr) {
var headers = data.getAllResponseHeaders()
if (data.status == 401 || (data.status == 403 && headers.indexOf("x-anonymous:") != -1)) {
window.location.reload()
return;
}
if(reTryInOnline) {
spajs.ajax.addToQueue(opt);
}
if (errorCallBack) {
errorCallBack(data, status, xhr)
def.reject(data, status, xhr)
}
else {
def.reject(data, status, xhr)
}
}
if (!opt.beforeSend) {
opt.beforeSend = function (xhr) {
for (var i in spajs.ajax.headers) {
xhr.setRequestHeader(i, spajs.ajax.headers[i]);
}
}
}
var res = jQuery.ajax(opt);
res.addToQueue = false;
res.ignore = false;
defpromise.abort = function () {
res.abort()
}
return defpromise
}
spajs.ajax.ajaxCallFromQueue = function () {
for (var i in spajs.ajax.ajaxQueue) {
jQuery.ajax(spajs.ajax.ajaxQueue[i]);
}
spajs.ajax.ajaxQueue = []
}
return this;
}
}
function setSpaPageType(type) {
if (window.__lastSpaPageType && window.__lastSpaPageType != type) {
setTimeout(() => {
window.location.reload();
}, 50)
}
window.__lastSpaPageType = type
}
/*
if (!window.spajs) {
window.spajs = new SpaJs("spa_")
window.spajs.init({
holder: "#page",
useHistoryApi: true,
initLinks: true,
})
$(document).ready(function(){
window.tabSignal.emit('page.loaded');
})
window.tabSignal.on("page.loaded", () => {
window.spajs.linkInit();
});
}
*/

guiModal = {
options : {
width: '100%',
autoOpen: false,
overlayColor: 'rgba(0, 0, 0, 0.6)',
closeOnEscape: true,
closeButton: true,
fullscreen:true,
openFullscreen:true,
overlayClose:false,
},
setModalHTML:function(html, opt)
{
let local_options = {}
for(var i in this.options)
{
local_options[i] = this.options[i]
}
if(opt !== undefined)
{
for(var i in opt)
{
local_options[i] = opt[i]
}
}
if(window.isCordova())
{
local_options.fullscreen = true
local_options.overlay = false
local_options.transitionIn = false
local_options.transitionOut = false
}
try{
var modalHolder = jQuery("#guiModal-iziModal");
if(!modalHolder.length)
{
modalHolder.remove();
}
$("body").append('<div class="modal" tabindex="-1" role="dialog" id="guiModal-iziModal" data-iziModal-transitionIn="fadeInDown" data-iziModal-transitionOut="fadeOutDown"></div>')
modalHolder = jQuery("#guiModal-iziModal");
jQuery(modalHolder).insertTpl(html);
$(modalHolder).iziModal(local_options);
}catch (exception) {
window.imbaLog.warn("Не понятки с модалкой")
debugger;
}
return this;
},
modal:function(){
return jQuery("#guiModal-iziModal");
},
modalOpen:function(){
var modalHolder = jQuery("#guiModal-iziModal");
if(!modalHolder.length)
{
return this;
}
try{
jQuery(modalHolder).iziModal('open')
jQuery(modalHolder).iziModal('setFullscreen', true);
}catch (exception) {
window.imbaLog.warn("Не понятки с модалкой")
debugger;
}
return this;
},
modalClose:function(){
var modalHolder = jQuery("#guiModal-iziModal");
if(!modalHolder.length)
{
return this;
}
try{
jQuery(modalHolder).iziModal('close');
}catch (exception) {
window.imbaLog.warn("Не понятки с модалкой")
debugger;
}
return this;
}
}
guiToast = {
show:function(opt){
return iziToast.show(opt)
},
hide:function(selector)
{
var toast = document.querySelector(selector); // Selector of your toast
if(toast)
{
iziToast.hide({}, toast);
iziToast.hide({
transitionOut: 'fadeOutUp'
}, toast);
}
}
}

window.ImbaChatDB = function()
{
return window.ImbaChatDB;
}
ImbaChatDB.version = "1"
window.ImbaChatDB.setData = function(key, value)
{
this.dataObj[key] = value
this.saveData(key)
}
window.ImbaChatDB.getData = function(key = 'data')
{
return this.dataObj[key];
}
window.ImbaChatDB.saveData = function(key = 'data', value = undefined)
{
if(value !== undefined)
{
this.dataObj[key] = value
}
var thisObj = this
return new Promise(function(resolve, reject)
{
thisObj.dataCache.setValue(key, thisObj.dataObj[key]).then(
function()
{
resolve()
},
function(err)
{
window.imbaLog.log("set to cache for `"+key+"` have error", err)
reject(err)
}
)
})
}
window.ImbaChatDB.loadData = function(key = 'data')
{
var thisObj = this
return new Promise(function(resolve, reject)
{
thisObj.dataCache.getValue(key).then(
function(data)
{
window.imbaLog.log("use from cache", data)
thisObj.dataObj[key] = data.data
resolve(thisObj.dataObj[key])
},
function(err)
{
window.imbaLog.log("cache for `"+key+"` is empty", err)
thisObj.dataObj[key] = {}
reject({})
}
)
})
}
window.ImbaChatDB.dropData = function()
{
return this.dataCache.dropDB()
}
window.ImbaChatDB.init = function()
{
this.dataObj = {}
this.dataCache = new window.WebDB({ noCache:false, base_name:'imbachat-db' })
}

window.ImbaRoomDB = function (room_id) {
this.dataObj = {}
this.dataCache = new window.WebDB({
store_name: 'room',
base_name: 'imbachat-room-' + room_id,
onupgradeneeded: function (event, webDBobject) {
let objectStore = event.currentTarget.result.createObjectStore(webDBobject.opt.store_name, {
keyPath: "uuid", autoIncrement: false
});
objectStore.createIndex("id", "id", { unique: false });
objectStore.createIndex("time", "time", { unique: false });
},
})
return $.extend(true, {}, this, window.ImbaRoomDB);
}
ImbaRoomDB.version = "1"
window.ImbaRoomDB.addMessage = function (message_obj) {
var thisObj = this;
if (window.cordova && window.cordova.file) {
return new Promise((resolve, reject) => {
if (message_obj.data.meta && message_obj.data.meta.length != 0 && message_obj.data.meta[0] && (message_obj.data.meta[0].type == 'file-image' || message_obj.data.meta[0].type == 'file-file')) {
var cordovaPath = '';
if(cordova.platformId == 'android'){
cordovaPath = cordova.file.externalCacheDirectory
} else if (cordova.platformId == 'ios') {
cordovaPath = cordova.file.tempDirectory
}
if(!message_obj.data.meta[0].data.fileName){
message_obj.data.meta[0].data.fileName = message_obj.data.meta[0].data.name
}
window.resolveLocalFileSystemURL(cordovaPath + message_obj.data.meta[0].data.fileName, fileExists, fileDoesNotExist);
function fileExists(){
message_obj.data.meta[0].local_path = cordovaPath + message_obj.data.meta[0].data.fileName
$.when(thisObj.dataCache.setValue(message_obj)).always(()=>{
resolve();
})
}
function fileDoesNotExist(){
var ft = new FileTransfer();
var fileUrl = encodeURI(imbaChat.opt.file_service_url + '/' + message_obj.data.meta[0].data.file_id);
ft.download(
fileUrl,
cordovaPath + message_obj.data.meta[0].data.fileName,
() =>
{
message_obj.data.meta[0].local_path = cordovaPath + message_obj.data.meta[0].data.fileName
window.imbaLog.log('file saved cordova', message_obj.data.meta[0])
$.when(thisObj.dataCache.setValue(message_obj)).always(()=>{
resolve();
})
},
error =>
{
window.imbaLog.log(error)
$.when(thisObj.dataCache.setValue(message_obj)).always(()=>{
resolve();
})
}
)
}
} else {
window.imbaLog.log(message_obj.data.meta[0])
$.when(thisObj.dataCache.setValue(message_obj)).always(()=>{
resolve();
})
}
})
}
if (!message_obj.uuid || message_obj.uuid == null) {
return
}
return this.dataCache.setValue(message_obj);
}
window.ImbaRoomDB.getMessage = function (key = 'data') {
this.dataCache.getValue;
}
window.ImbaRoomDB.getLastestMessage = function () {
return new Promise((resolve, reject) => {
this.dataCache.getMinValue('time').then((message) => {
if (message !== undefined) {
resolve(message.value.data)
return;
}
resolve(undefined)
})
})
}
window.ImbaRoomDB.getMessagesHistory = function (limit, offset) {
return new Promise((resolve, reject) => {
this.dataCache.getMinValues('time', limit, offset).then((message) => {
if (message !== undefined) {
resolve(message)
return;
}
resolve(undefined)
})
})
}
window.ImbaRoomDB.drop = function () {
return this.dataCache.dropDB()
}

/**
* @link http://comet-server.com(҂`_´)
<,︻╦╤─ ҉ - - - - - - --
_/﹋\_
*/
/*
window.imbaLog.groupCollapsed('dev contact');
window.imbaLog.info('chat/videochat:');
window.imbaLog.info('Victor Trapenok');
window.imbaLog.info('https://vk.com/levhav');
window.imbaLog.groupEnd();
*/
/**
*/
if (window.gettext === undefined) {
window.gettext = function (widget, text, arg1 = null, arg2 = null) {
if (text === 0) {
return "0";
}
if (text === false) {
return "false";
}
if (!text) {
return "";
}
text = text + ""
if (window.gettext.data && window.gettext.data[window.gettext.locale] && window.gettext.data[window.gettext.locale][text]) {
text = window.gettext.data[window.gettext.locale][text];
text = text + ""
for (var i = 1; i < arguments.length; i++) {
text = text.replace("%" + i + "s", arguments[i])
}
if (!window.imbaChatLangJson[text]) {
return text;
} else {
if (arg1 != null || arg2 != null) {
return text.replace(text, window.imbaChatLangJson[text]).replace('%1s', arg1).replace('%2s', arg2);
} else {
return text.replace(text, window.imbaChatLangJson[text]);
}
}
}
for (var i = 1; i < arguments.length; i++) {
text = text.replace("%" + i + "s", arguments[i])
}
if (!window.imbaChatLangJson[text]) {
return text
} else {
if (arg1 != null || arg2 != null) {
return text.replace(text, window.imbaChatLangJson[text]).replace('%1s', arg1).replace('%2s', arg2);
} else {
return text.replace(text, window.imbaChatLangJson[text]);
}
}
}
window.gettext.data = {};
window.gettext.locale = 'en'
if (navigator.language) {
window.gettext.locale = navigator.language
}
gettext.setTranslate = function (lang, arr) {
window.gettext.data[lang] = arr
}
gettext.setLocale = function (lang) {
window.gettext.locale = lang
}
gettext.getLocale = function () {
return window.gettext.locale
}
}
window.roomChat = function () {
let chat = $.extend({}, window.roomChat);
return chat;
}
/**
*/
if (window._ === undefined) {
window._ = function (text) { return text; }
}
roomChat.class_name = 'roomVideoChat';
roomChat.opt = {
};
roomChat.model = {};
roomChat.opt.holder = "body";
roomChat.model.hidden = true
roomChat.opt.ignored = {}
roomChat.opt.useEmojioneArea = false
roomChat.opt.useEmojione = false
/**
*/
roomChat.publicSubscriptions = {}
/**
*/
roomChat.opt.api_host = "";
/**
*/
roomChat.opt.page_size = 30;
/**
*/
roomChat.opt.data = undefined;
/**
roomChat.dataObj = {}*/
/**
*/
roomChat.opt.useFaviconBadge = false
/**
*/
roomChat.uploadFilesList = undefined;
/**
*/
roomChat.newMessagesSum = 0;
roomChat.tabsMessagesSum = [0, 0, 0];
/**
*/
roomChat.deltaMessagesSum = 0;
/**
*/
roomChat.initSuccess = false;
/**
*/
roomChat.initProgress = false;
roomChat.first_dialog = -2
roomChat.relations = { 0: 'base', 1: 'favorite', 2: 'loc', 3: 'blocked' }
roomChat.relation = {}
roomChat.relation.base = 0
roomChat.relation.favorite = 1
roomChat.relation.loc = 2
roomChat.relation.blocked = 3
roomChat.statuses = { 0: 'default', 1: 'waiting', 2: 'confirmed', 3: 'rejected' }
roomChat.status = {}
roomChat.status.default = 0;
roomChat.status.waiting = 1;
roomChat.status.confirmed = 2;
roomChat.status.rejected = 3;
roomChat.room_type = {}
roomChat.room_type.dialog = 0
roomChat.room_type.conference = 1
roomChat.room_type.public = 2
roomChat.room_type.support = 3
roomChat.room_type.concierge = 4
roomChat.room_type.bot = 5
/**
*/
roomChat.lastLinkInfo = {}
roomChat.tab = {}
roomChat.tab.DEFAULT = 0
roomChat.tab.SALE = 1
roomChat.tab.DATING = 2
/**
*/
roomChat.opt.URL_getUserInfo = "getUserInfo"
/**
*/
roomChat.opt.URL_getSelfInfo = "getSelfInfo"
roomChat.opt.URL_getStreamToken = "getStreamToken"
/**
*/
roomChat.opt.URL_typingMessage = "";
/**
*/
roomChat.opt.URL_libmp3lameJS = "";
/**
*/
roomChat.opt.URL_newRoom = "newRoom"
/**
*/
roomChat.opt.URL_addToRoom = "addToRoom"
/**
*/
roomChat.opt.URL_makeRoomAdmin = "makeRoomAdmin"
/**
*/
roomChat.opt.URL_saveRoomSettings = "saveRoomSettings"
/**
*/
roomChat.opt.URL_removeFromRoom = "removeFromRoom"
/**
*/
roomChat.opt.URL_getMessages = "getMessages"
/**
*/
roomChat.opt.URL_sendMessage = "sendMessage"
/**
*/
roomChat.opt.URL_newConferenceCall = "newConferenceCall"
/**
*/
roomChat.opt.URL_addCallEvent = "addCallEvent"
/**
*/
roomChat.opt.URL_setStreamMode = "setStreamMode"
roomChat.opt.URL_sendStreamPreview = "sendStreamPreview"
/**
*/
roomChat.opt.URL_setLike = "setLike"
/**
*/
roomChat.opt.URL_audioFile = "//" + window.location.host + ":" + window.location.port + "/plugins/roomVideoChat/assets/audio/pay/Message.wav"
roomChat.opt.URL_audioFile_call_start = "//" + window.location.host + ":" + window.location.port + "/plugins/roomVideoChat/assets/audio/call-start.mp3"
roomChat.opt.URL_audioFile_call_incoming = "//" + window.location.host + ":" + window.location.port + "/plugins/roomVideoChat/assets/audio/incoming-call.mp3"
roomChat.opt.sounds = [
{ name: 'newPayInChat-pay1', src: "//" + window.location.host + ":" + window.location.port + "/plugins/roomVideoChat/assets/audio/pay/1-2.mp3" },
{ name: 'newPayInChat-pay2', src: "//" + window.location.host + ":" + window.location.port + "/plugins/roomVideoChat/assets/audio/pay/2-2.wav" },
{ name: 'newPayInChat-pay3', src: "//" + window.location.host + ":" + window.location.port + "/plugins/roomVideoChat/assets/audio/pay/3-2.wav" },
{ name: 'newPayInChat-pay4', src: "//" + window.location.host + ":" + window.location.port + "/plugins/roomVideoChat/assets/audio/pay/4-2.wav" },
{ name: 'newPayInChat-pay5', src: "//" + window.location.host + ":" + window.location.port + "/plugins/roomVideoChat/assets/audio/pay/5-2.wav" },
]
/**
*/
roomChat.opt.URL_shareUser = "shareUser"
/**
*/
roomChat.opt.URL_searchUsers = "searchUsers"
/**
*/
roomChat.opt.URL_deleteDialog = "deleteDialog"
/**
*/
roomChat.opt.URL_deleteHistoryInRoom = "deleteHistoryInRoom"
/**
*/
roomChat.opt.URL_markAsRead = "markAsRead"
/**
*/
roomChat.opt.URL_sendMoneyToRoomAdmin = "mycred_pay"
/**
*/
roomChat.opt.URL_getAlbumFotos = "getAlbumFotos"
/**
*/
roomChat.opt.URL_getLinkInfo = "getLinkInfo"
roomChat.opt.URL_setBlockUser = "setBlockUser"
roomChat.opt.URL_setUnblockUser = "setUnblockUser"
/**
*/
roomChat.opt.open = false
/**
* Например http://comet-server.ru/avatar/
*/
roomChat.opt.user_avatar_url_tpl = "";
/**
* Шаблонизатор https://github.com/Levhav/just
*/
roomChat.just = undefined;
/**
*/
roomChat.opened_room = false;
/**
*/
roomChat.inSearchMode = false
/**
*/
roomChat.inSearchResultsMode = false
/**
*/
roomChat.allUsersInfo = {}
roomChat.queryArray = []
/**
*/
roomChat.uploadFilesList = [];
/**
*/
roomChat.uploadAlbumImages = {}
roomChat.opt.rooms = []
roomChat.opt.user_id = 0;
/**
*/
roomChat.opt.file_dir = "https://web.comet.su/";
/**
*/
roomChat.newRoomAvatar = undefined
/**
*/
roomChat.isActiveTab = undefined
/**
*/
roomChat.getUsersInfoByIdAsyncCounter = 0;
roomChat.initPromise = new jQuery.Deferred();
roomChat.getInitPromise = function () {
return this.initPromise.promise();
}
roomChat.render = function () {
var thisObj = this
if ($(thisObj.opt.holder + " .roomvideochat-body").length) {
return;
}
if (window.innerWidth < 768) {
$('#roomVideoChat-holder').css('height', window.innerHeight);
$('#roomVideoChat-holder').css('width', window.innerWidth);
window.onresize = function () {
$('#roomVideoChat-holder').css('max-height', window.innerHeight);
$('#roomVideoChat-holder').css('max-width', window.innerWidth);
}
}
$(thisObj.opt.holder).insertTpl('<div class="roomvideochat roomvideochat-body room-not-opend"></div>')
jQuery(".roomvideochat").insertTpl(this.just.renderSync('top_popup_holder', { chatObj: this })) // для попапов
var html = this.just.renderSync('spajs-holder', { chatObj: this })
jQuery(".roomvideochat").appendTpl(window.JUST.onInsert(html, () => {
try {
$('.imbachat_draggable').draggable({
opacity: 0.55,
cancel: '.window-maximize,.roomVideoChat-messages-history,.roomVideoChat-reply-form,input,textarea,button,select,option',
stop: function (event, ui) {
if ($('#imbachat').hasClass('left')) {
let right = $(document).width() - ($(this).css('left').replace(/[^0-9]/g, "") / 1 + $(this).width())
$(this).css({ left: 'auto', right: right + 'px' })
}
}
});
$('.imbachat_resizable').resizable({
handles: ' n, s, w, sw, nw',
stop: function (event, ui) {
if ($('#imbachat').hasClass('left')) {
let right = $(document).width() - ($(this).css('left').replace(/[^0-9]/g, "") / 1 + $(this).width())
$(this).css({ left: 'auto', right: right + 'px' })
}
}
});
} catch (e) {
}
}))
}
/**
* open:true // Надо ли открывать окно или только инициализировать чат и получить данные о контактах
*/
roomChat.init = function (options) {
var thisObj = this
if (this.initProgress === true) {
return;
}
this.initProgress = true;
/**
*/
this.opt.deleted_user = {
avatar_url: "data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz"
+ "0idXRmLTgiPz48IURPQ1RZUEUgc3ZnIFBVQkxJQyAiLS8vVzNDLy9EVEQgU1ZHIDEu"
+ "MS8vRU4iICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdm"
+ "cxMS5kdGQiPjxzdmcgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5v"
+ "cmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3"
+ "hsaW5rIiB4PSIwcHgiIHk9IjBweCIgdmlld0JveD0iMCAwIDEwMDAgMTAwMCIgZW5h"
+ "YmxlLWJhY2tncm91bmQ9Im5ldyAwIDAgMTAwMCAxMDAwIiB4bWw6c3BhY2U9InByZX"
+ "NlcnZlIj48bWV0YWRhdGE+IFN2ZyBWZWN0b3IgSWNvbnMgOiBodHRwOi8vd3d3Lm9u"
+ "bGluZXdlYmZvbnRzLmNvbS9pY29uIDwvbWV0YWRhdGE+PGc+PHBhdGggZD0iTTUwMC"
+ "w5OTAuMUMyMTAsOTkwLjEsMTAsNzcwLjcsMTAsNTAwQzEwLDIyOS40LDIyOS40LDku"
+ "OSw1MDAsOS45YzI3MC43LDAsNDkwLDIxOS40LDQ5MCw0OTAuMUM5OTAsNzcwLjcsNz"
+ "kwLDk5MC4xLDUwMCw5OTAuMUw1MDAsOTkwLjF6IE01MDAsNzMuNGMtMjM1LjYsMC00"
+ "MjYuNSwxOTEtNDI2LjUsNDI2LjZjMCwxMTAuMiw0Mi4xLDIxMC4zLDExMC42LDI4Nm"
+ "M2MS44LTI5LjksMzkuMS01LDEyMC0zOC4yYzgyLjctMzQsMTAyLjMtNDUuOSwxMDIu"
+ "My00NS45bDAuOC03OC40YzAsMC0zMS0yMy41LTQwLjYtOTcuM2MtMTkuNCw1LjYtMj"
+ "UuOC0yMi42LTI3LTQwLjZjLTEtMTcuMi0xMS4yLTcxLjQsMTIuNC02Ni41Yy00Ljgt"
+ "MzYtOC4zLTY4LjYtNi42LTg1LjljNS45LTYwLjUsNjQuNy0xMjMuOCwxNTUuMS0xMj"
+ "guNGMxMDYuNSw0LjUsMTQ4LjcsNjcuOCwxNTQuNiwxMjguNGMxLjcsMTcuMi0yLjEs"
+ "NDkuOS02LjksODUuOWMyMy42LTQuOCwxMy40LDQ5LjIsMTIuMiw2Ni41Yy0xLDE3Lj"
+ "ktNy42LDQ1LjktMjYuOSw0MC40Yy05LjcsNzMuOC00MC43LDk3LjItNDAuNyw5Ny4y"
+ "bDAuNyw3OGMwLDAsMTkuNiwxMS4xLDEwMi4zLDQ1LjFjODAuOCwzMy4zLDU4LjEsOS"
+ "45LDExOS45LDM5LjhjNjguNi03NS43LDExMC43LTE3NS44LDExMC43LTI4NkM5MjYu"
+ "NiwyNjQuNCw3MzUuNiw3My40LDUwMCw3My40TDUwMCw3My40eiIvPjwvZz48L3N2Zz4=",
page_url: "/",
status: "active",
user_id: -1,
login: "",
about_me: gettext("imbachat", "User deleted"),
name: gettext("imbachat", "User deleted"),
company: "",
last_online_time: "-1"
}
this.opt.system_user = this.opt.deleted_user;
this.monthArr = [gettext("imbachat", "jan"), gettext("imbachat", "feb"), gettext("imbachat", "mar"), gettext("imbachat", "apr"), gettext("imbachat", "may"), gettext("imbachat", "jun"), gettext("imbachat", "jul"), gettext("imbachat", "aug"), gettext("imbachat", "sep"), gettext("imbachat", "oct"), gettext("imbachat", "nov"), gettext("imbachat", "dec")]
for (var i in options) {
this.opt[i] = options[i]
}
this.chatDB = new window.ImbaChatDB()
this.chatDB.init()
this.favicon = undefined
if (window.Favico /* && this.opt.useFaviconBadge */) {
this.favicon = new Favico({
animation: 'none'
});
}
setTimeout(function () {
for (var i in thisObj.opt.sounds) {
var html = '<audio class="' + thisObj.class_name + '-msg-audio audio-' + thisObj.opt.sounds[i].name + '">\
<source src="'+ thisObj.opt.sounds[i].src + '" />\
</audio>';
jQuery("body").appendTpl(html);
}
/*
var html = '<audio class="'+thisObj.class_name+'-msg-audio audio-new-message">\
<source src="'+thisObj.opt.URL_audioFile+'" />\
</audio>';
jQuery("body").appendTpl(html);
var html = '<audio class="'+thisObj.class_name+'-call-audio-start" loop>\
<source src="'+thisObj.opt.URL_audioFile_call_start+'" />\
</audio>';
jQuery("body").appendTpl(html);
var html = '<audio class="'+thisObj.class_name+'-call-audio-incoming" loop>\
<source src="'+thisObj.opt.URL_audioFile_call_incoming+'" />\
</audio>';
jQuery("body").appendTpl(html);*/
}, 10000 + Math.random() * 5000)
var tplArray = jQuery("script[data-just-roomvideochat]")
var arrTpl = {};
for (var i = 0; i < tplArray.length; i++) {
var val = jQuery(tplArray[i]);
if(arrTpl[val.attr("data-just-roomvideochat")]){
if(val.attr("data-just-roomvideochat") == 'spajs-holder'){
window.html1 = val.html();
}
arrTpl[val.attr("data-just-roomvideochat")].remove();
}
arrTpl[val.attr("data-just-roomvideochat")] = val;
}
var root = {}
var tplArray = jQuery("script[data-just-" + this.class_name + "]")
for (var i = 0; i < tplArray.length; i++) {
var val = jQuery(tplArray[i]);
root[val.attr("data-just-" + this.class_name + "")] = val.html()
}
this.just = new JUST({
root: root
});
this.spajs = new SpaJs("imbaChat_");
if (window.isCordova()) {
this.spajs.init({
holder: this.opt.holder,
urlDelimetr: "#",
initLinks: false,
useHistoryApi: true,
loadServerPage: () => {
let def = new jQuery.Deferred();
def.resolve()
return def.promise();
}
})
}
else {
this.spajs.init({
holder: this.opt.holder,
urlDelimetr: "#",
initLinks: false,
useHistoryApi: false,
})
}
this.spajs.addMenu({
id: "start-page",
urlregexp: [/^roomVideoChat$/, /^start-page$/],// Стартовая страница
onOpen: function (holder, menuInfo, data) {
tabSignal.emit("sidebar.set.open")
thisObj.render()
jQuery(".roomVideoChat-right-area").insertTpl(thisObj.just.renderSync('chat_right_column_stub', { chatObj: thisObj }))
/*
if(thisObj.opt.position && !thisObj.opt.position.isNotNeadMoveAfterCloseRoom)
{
let oldwidth = thisObj.opt.position.width.replace(/[^0-9]/g, "")/1
let newwidth = $("#roomVideoChat-holder").css('width').replace(/[^0-9]/g, "")/1
let left = thisObj.opt.position.left.replace(/[^0-9]/g, "")/1
left += (oldwidth - newwidth)
$("#roomVideoChat-holder").css({left:left + 'px'})
thisObj.opt.position.isNotNeadMoveAfterCloseRoom = true
}*/
},
onClose: function (menuInfo) {
thisObj.onCloseRoom();
},
})
this.spajs.addMenu({
id: "message-page",
urlregexp: [/^roomVideoChat-(message)-([0-9]+)$/],// Стартовая страница
onOpen: function (holder, menuInfo, data) {
thisObj.render()
thisObj.openByTarget(data.reg[2])
},
onClose: function (menuInfo) {
thisObj.onCloseRoom();
},
})
this.spajs.addMenu({
id: "search-page",
urlregexp: [/^roomVideoChat-(search)-([0-9]+)$/],// Стартовая страница
onOpen: function (holder, menuInfo, data) {
if (!data.reg[2]) {
thisObj.showStartPage()
return;
}
thisObj.render()
thisObj.sendSearchGlobalQuery(decodeURIComponent(data.reg[2]));
},
onClose: function (menuInfo) {
thisObj.onCloseRoom();
},
})
this.spajs.addMenu({
id: "favorite-page",
urlregexp: [/^roomVideoChat-(favorite)-([0-9]+)$/],// Стартовая страница
onOpen: function (holder, menuInfo, data) {
thisObj.render()
thisObj.showRoom("favorite")
},
onClose: function (menuInfo) {
thisObj.onCloseRoom();
},
})
var thisObj = this
this.spajs.addMenu({
id: "roomVideoChat", // id комнаты должен соответсвовать регулярному выражению [A-z9-0_]{ 4,64}
urlregexp: [/^roomVideoChat-room-([0-9]+)$/],
/*
*/
onOpen: function (holder, menuInfo, data) {
/*if(window.localStorage['last_activeTab']/1)
{
thisObj.showTab(window.localStorage['last_activeTab']/1);
}
else
{
thisObj.showTab(0);
}*/
thisObj.render()
thisObj.showRoom(data.reg[1])
},
/*
*/
onClose: function (menuInfo) {
thisObj.onCloseRoom();
},
})
cometApi.subscription("msg.newMessage", function (event) {
thisObj.onNewMessage(event.data.message, event.data.user)
})
cometApi.subscription("installedRooms.newMessage", function (event) {
thisObj.onNewMessage(event.data.message, event.data.user)
})
cometApi.subscription("msg.newPayInChat", function (event) {
thisObj.onNewMessage(event.data, event.data.user)
if (thisObj.opened_room && thisObj.opened_room.room_id == event.data.room_id) {
thisObj.tryPlaySound(event.data.room_id, thisObj.getSoundNameByPaySum(event.data.meta[0].sum))
}
})
cometApi.subscription("msg.rejectInviteToVip", function (event) {
thisObj.onRejectInviteToVip(event)
})
cometApi.subscription("msg.inviteToCall", function (event) {
thisObj.onInviteToVip(event)
})
cometApi.subscription("msg.addToRoom", function (event) {
thisObj.onNewMessage(event.data.meta, [])
})
cometApi.subscription("msg.readMessage", function (event) {
if (event.data.user_id == thisObj.opt.user_id) {
thisObj.clearMessageCounter(thisObj.getRoomInfoById(event.data.room_id))
}
if (thisObj.opened_room && thisObj.opened_room.room_id == event.data.room_id) {
var msgArr = jQuery(".roomVideoChat-message-not-read").addClass("roomVideoChat-message-is-read").removeClass("roomVideoChat-message-not-read");
var time = new Date()
time = time.getTime()
for (var i = 0; i < msgArr.length; i++) {
var id = jQuery(msgArr[i]).attr("data-messageId");
if (id > 0) {
jQuery(".message-id-" + id + " .read-time").insertTpl(thisObj.getReadTimeString(time))
}
var uuid = jQuery(msgArr[i]).attr("data-messageuuid");
if (uuid) {
jQuery(".message-uuid-" + uuid + " .read-time").insertTpl(thisObj.getReadTimeString(time))
}
}
}
})
cometApi.subscription("msg.removeFromRoom", function (event) {
thisObj.onNewMessage(event.data.meta, [])
})
cometApi.subscription("msg.newAdminInRoom", function (event) {
thisObj.onNewMessage(event.data.meta, [])
})
cometApi.subscription("msg.shareUser", function (event) {
thisObj.onNewMessage(event.data, [])
})
cometApi.subscription("msg.newRoom", function (event) {
$.when(thisObj.updateContactList()).done((data) => {
thisObj.tryPlaySound()
if (event.data.open_now) {
thisObj.openChat()
thisObj.openRoom(event.data.room_id)
}
})
})
cometApi.subscription("msg.newRoomSettings", function (event) {
$.when(thisObj.updateContactList()).done((data) => {
if (thisObj.opened_room && thisObj.opened_room.room_id == event.data.room_id) {
thisObj.openRoom(thisObj.opened_room.room_id);
}
})
})
cometApi.subscription("msg.updateIgnoredList", function (event) {
thisObj.updateContactList()
})
cometApi.subscription("msg.deleteDialog", function (event) {
thisObj.onDeleteDialog(event.data.roomId)
})
cometApi.subscription("msg.typingMessage", function (event) {
if (thisObj.isIgnored(event.data.user_id)) {
return;
}
thisObj.onTypingMessage(event)
})
jQuery(window).blur(function () {
thisObj.isActiveTab = false;
});
jQuery(window).focus(function () {
thisObj.isActiveTab = true;
tabSignal.emitAll("onAnyTabActivated", {})
});
tabSignal.connect("onAnyTabActivated", function (event) {
if (thisObj.opt.useFaviconBadge) {
thisObj.favicon.badge('');
}
thisObj.deltaMessagesSum = 0;
})
tabSignal.on("ws_message_sent", (msg) => {
if (msg.data.message && msg.data.message.uuid && msg.data.message.id) {
if ($(".message-uuid-" + msg.data.message.uuid).hasClass('message-not-sended')) {
$(".message-uuid-" + msg.data.message.uuid)
.removeClass("message-not-sended")
.addClass("message-sended")
.addClass("message-id-" + msg.data.message.id)
}
}
});
tabSignal.connect("imbaChat.newMessagesUpdate", function (event) {
thisObj.tryIncrementDeltaMessagesSum()
})
/*
*/
tabSignal.connect("onUpdateUsersInfo", function (param) {
for (var i in param.users) {
if (!param.users[i]) {
continue;
}
if (param.users[i].last_online_time !== undefined) {
if (param.users[i].last_online_time > 0 || param.users[i].last_online_time == -1) {
jQuery(".roomVideoChat-avatar-user-id-" + param.users[i].user_id).removeClass("online")
}
else {
jQuery(".roomVideoChat-avatar-user-id-" + param.users[i].user_id).addClass("online")
}
}
if (thisObj.opened_room && param.users[i].user_id == thisObj.getOponentForRoom(thisObj.opened_room.room_id).user_id) {
jQuery("#roomVideoChat-room-info-holder").insertTpl(thisObj.just.renderSync('room_oponent_info', { chatObj: thisObj, roomInfo: thisObj.opened_room, oponentUser: thisObj.getOponentForRoom(thisObj.opened_room.room_id) }))
}
}
for (var i in thisObj.opt.rooms) {
if (!thisObj.opt.rooms.hasOwnProperty(i)) {
continue;
}
if (thisObj.isSomebodyOnlineInRoom(thisObj.opt.rooms[i].room_id)) {
jQuery("#roomVideoChat-user-dialog-" + thisObj.opt.rooms[i].room_id).addClass("roomVideoChat-somebody-online").removeClass("roomVideoChat-all-offline")
}
else {
jQuery("#roomVideoChat-user-dialog-" + thisObj.opt.rooms[i].room_id).removeClass("roomVideoChat-somebody-online").addClass("roomVideoChat-all-offline")
}
}
})
var lastOnlineStatus = undefined;
thisObj.model.online_status = thisObj.isOnline()
setInterval(function () {
var status = thisObj.isOnline();
if (status !== lastOnlineStatus && lastOnlineStatus !== undefined) {
thisObj.model.online_status = status;
if (status) {
setTimeout(function () {
if (!thisObj.isOnline()) {
return;
}
thisObj.setUserOnline();
}, 1000)
}
else {
thisObj.setUserOffline();
}
}
lastOnlineStatus = status;
}, 500)
thisObj.audioRecoder = window.WebmRecording // WavRecording | MP3Recording | WebmRecording
thisObj.isRecordingInit = false
if (thisObj.audioRecoder) {
thisObj.audioRecoder.init({
onSuccessInit: function () {
thisObj.isRecordingInit = true
jQuery(".roomVideoChat-recording-btn").show()
},
})
}
cometApi.subscription("msg.callHangup", function (event) {
thisObj.onNewMessage(event.data, [])
chatDialogsList.upDialogInList(thisObj.opened_room)
})
cometApi.subscription("msg.openChat", function (event) {
$.when(thisObj.updateContactList()).done((data) => {
thisObj.tryPlaySound()
if (event.data.open_now) {
thisObj.openChat()
thisObj.openRoom(event.data.room_id)
}
})
})
cometApi.subscription("msg.callBusy", function (event) {
thisObj.onNewMessage(event.data, [])
chatDialogsList.upDialogInList(thisObj.opened_room)
})
cometApi.subscription("msg.hangupToOtherTabs", function (event) {
if (cometApi.getTabUUID() != event.data.tabId) {
cometVideoApi.hangup();
}
})
cometApi.subscription("msg.callOut", function (event) {
thisObj.onNewMessage(event.data, [])
chatDialogsList.upDialogInList(thisObj.opened_room)
})
cometApi.subscription("msg.callMute", function (event) {
thisObj.onNewMessage(event.data, [])
chatDialogsList.upDialogInList(thisObj.opened_room)
})
cometApi.subscription("msg.lostCall", function (event) {
thisObj.onNewMessage(event.data, [])
chatDialogsList.upDialogInList(thisObj.opened_room)
})
tabSignal.connect("imbaChat.newMessagesUpdate", function (event) {
if (event.newMessagesSum > 0) {
$('.roomVideoChat-mainbtn').addClass('new-message')
}
else {
$('.roomVideoChat-mainbtn').removeClass('new-message')
}
})
tabSignal.connect("chat.updateContactCount", function () {
let count = thisObj.opt.rooms.filter((e) => {
return e.user_id != imbaChat.opt.deleted_user.user_id && imbaChat.getOponentForRoom(e.room_id).user_id != imbaChat.opt.deleted_user.user_id
}).length;
if (isCordova()) {
if(count >= 100){
$('.roomVideoChat-header-room-count')[0].setAttribute('style', 'background-position-x: 60px !important');
$('.searchCordova')[0].setAttribute('style', 'right: 60px !important');
} else if (count >= 10) {
$('.roomVideoChat-header-room-count')[0].setAttribute('style', 'background-position-x: 43px !important');
} else {
$('.roomVideoChat-header-room-count')[0].setAttribute('style', 'background-position-x: 29px !important');
}
}
$('.roomVideoChat-header-room-count').html(count)
$('.roomVideoChat-mainbtn-countroom').html(count)
if (!count) {
$('.roomVideoChat-mainbtn').addClass('not-contact-list ')
}
else {
$('.roomVideoChat-mainbtn').removeClass('not-contact-list ')
}
})
tabSignal.connect("chat.updateContactList", function () {
tabSignal.emit("chat.updateContactCount", { chatObj: thisObj })
})
tabSignal.emit("imbaChat.loading", { chatObj: thisObj })
$.when(thisObj.getInitPromise()).done(() => {
if (thisObj.opt.onInitSuccess && typeof thisObj.opt.onInitSuccess === "function") {
thisObj.opt.onInitSuccess();
}
tabSignal.emit("imbaChat.loaded", { chatObj: thisObj })
if (thisObj.opt.openRoomWhenLoaded) {
thisObj.openRoom(thisObj.opt.openRoomWhenLoaded, () => {
thisObj.openChat()
})
}
})
let cachePromise = this.updateFromCache();
$.when(this.spajs.ajax.sendFromQueue()).always(() => {
$.when(cachePromise).done(() => {
window.imbaLog.log("User data: Load from cache");
thisObj.initSuccess = true;
thisObj.initPromise.resolve()
let getMessages = thisObj.sendOfflineMessagesByRoom()
$.when(getMessages).done(() => {
$.when(this.updateContactList()).done(() => {
window.imbaLog.log("User data: Load from server");
thisObj.initSuccess = true;
thisObj.initPromise.resolve()
}).fail((err) => {
thisObj.initSuccess = false;
thisObj.initPromise.reject(err)
if (err.error_code != "network_error") {
tabSignal.emit("imbaChat.authError", err)
}
})
})
})
$.when(cachePromise).fail(() => {
$.when(this.updateContactList()).done(() => {
window.imbaLog.log("User data: Load from server");
thisObj.initSuccess = true;
thisObj.initPromise.resolve()
}).fail((err) => {
thisObj.initSuccess = false;
thisObj.initPromise.reject(err)
if (err.error_code == "network_error") {
tabSignal.emit("imbaChat.authError", err)
}
})
})
})
}
roomChat.stopPlaySound = function () {
}
roomChat.openChat = function () {
if (!this || !this.opt || !this.opt.rooms || !this.opt.rooms.length) {
}
$(".roomVideoChat-holder")
.addClass('window-minimaize')
.removeClass('window-close')
.removeClass('window-maximize')
.show()
$(".roomVideoChat-mainbtn").hide()
}
roomChat.closeChat = function () {
$(".roomVideoChat-holder")
.addClass('window-close')
.removeClass('window-minimaize')
.removeClass('window-maximize')
.hide()
.css({
width: '830px',
height: '480px',
bottom: '10px',
top: 'auto',
right: '10px',
left: 'auto',
})
$(".roomVideoChat-mainbtn").show()
this.closeRoom();
}
roomChat.minimaizeSize = function () {
$(".roomVideoChat-holder")
.addClass('window-minimaize')
.removeClass('window-close')
.removeClass('window-maximize')
.css({
width: '830px',
height: '480px',
bottom: '10px',
top: 'auto',
right: '10px',
left: 'auto',
})
}
roomChat.maximizeSize = function () {
$(".roomVideoChat-holder")
.addClass('window-maximize')
.removeClass('window-minimaize')
.removeClass('window-close')
.css({
width: '100vw',
height: '100vh',
top: '0px',
bottom: 'auto',
left: '0px',
right: '0px',
})
}
roomChat.setUserOnline = function () {
var thisObj = this;
if (isCordova()) {
if (window.showToastMessage) {
if (window.cordova.platformId == 'ios') {
showToastMessage('Синхронизация', 'long', 'bottom', 0);
} else {
showToastMessage('Синхронизация', 'long', 'bottom', -200);
}
}
}
tabSignal.emit('imbaChat.onlineSupportStatus')
$.when(thisObj.spajs.ajax.sendFromQueue()).done((data) => {
if (thisObj.opened_room && thisObj.opened_room.room_id) {
thisObj.openRoom(thisObj.opened_room.room_id);
}
jQuery(".roomVideoChat-network-status").addClass("roomVideoChat-status-online").removeClass("roomVideoChat-status-offline")
$.when(thisObj.sendOfflineMessagesByRoom()).done(() => {
thisObj.updateMessages({
room_id: thisObj.opened_room.room_id,
query: {
page: 0,
targetVector: 0
}
})
thisObj.updateContactList()
})
}).fail(function () {
lastOnlineStatus = false;
})
}
roomChat.setUserOffline = function () {
var thisObj = this;
tabSignal.emit('imbaChat.offlineSupportStatus',
{
imbasupport_type_concierge: 0,
imbasupport_type_support: 0
}
)
jQuery(".roomVideoChat-network-status").removeClass("roomVideoChat-status-online").addClass("roomVideoChat-status-offline")
thisObj.setAllUsersAsOffline()
}
roomChat.sendOfflineMessagesByRoom = function () {
var thisObj = this;
const limit = 30;
const offset = 0;
promise_arr = []
for (var i in this.opt.rooms) {
promise_arr[i] = new $.Deferred();
let sendRoomMessages = function (index) {
thisObj.getLocalRoomHistory(thisObj.opt.rooms[index].room_id).getMessagesHistory(limit, offset)
.then((messages) => {
roomSent = async function () {
for (var j in messages) {
if (messages[j].id != 0) {
continue;
}
let msg = async function (el) {
await thisObj.sendWhenOnline(thisObj.opt.rooms[index], messages[el])
}
await msg(j)
}
}
roomSent().then(() => {
promise_arr[index].resolve();
})
})
}
sendRoomMessages(i)
}
resolved = []
for (var i in promise_arr) {
resolved.push(promise_arr[i].promise())
}
resolved_all = new $.Deferred()
$.when(...resolved).then(() => {
resolved_all.resolve()
})
return resolved_all.promise()
}
roomChat.sendWhenOnline = function (room, message) {
if (message.send_status && (message.send_status == "sent" || message.send_status == "sending")) {
return;
}
var thisObj = this;
var roomInfo = thisObj.getRoomInfoById(room.room_id);
var fd = new FormData();
roomInfo.last_message = message;
fd.append('message', message.message);
fd.append('room_id', room.room_id);
fd.append('answer_to', null);
fd.append('user_id', this.opt.user_id);
fd.append('user_key', this.opt.user_key);
fd.append('extended_meta', JSON.stringify(this.getBrowserInfo()));
fd.append('cultivate', "roomVideoChat." + this.opt.URL_sendMessage);
fd.append('uuid', message.uuid);
if (message.meta[0] && message.meta[0].file) {
fd.append('files[]', (message.meta[0].file));
}
fd.append('message_meta', JSON.stringify(message.meta));
return new Promise((resolve, reject) => {
thisObj.apiCall({
reTryInOnline: false,
url: this.opt.api_host,
type: "POST",
data: fd,
processData: false,
contentType: false,
success: function (data) {
if (typeof data != "object") {
data = JSON.parse(data)
}
if (thisObj.ajaxErrorTest(data)) {
return;
}
thisObj.addUsersInfo(data.user)
$(".message-uuid-" + data.message.uuid)
.removeClass("message-not-sended")
.addClass("message-sended")
.addClass("message-id-" + data.message.id)
data.message.send_status = "sent"
thisObj.getLocalRoomHistory(room.room_id).addMessage({
data: data.message,
uuid: data.message.uuid,
id: data.message.id,
time: dayjs().unix(),
});
resolve(data)
},
error: function (err) {
reject(err)
}
});
})
}
roomChat.showStartPage = function () {
if (!this.opt.rooms || this.opt.rooms.length == 0) {
jQuery("#" + this.class_name + "-holder").removeClass("mobile-dialogs")
jQuery("#" + this.class_name + "-holder").addClass("mobile-history")
}
else {
jQuery("#" + this.class_name + "-holder").addClass("mobile-dialogs")
jQuery("#" + this.class_name + "-holder").removeClass("mobile-history")
}
if (window.localStorage['last_activeTab'] / 1) {
this.showTab(window.localStorage['last_activeTab'] / 1);
}
this.spajs.open({ menuId: "start-page" })
}
/**
*/
roomChat.onNewMessage = function (message, user) {
var thisObj = this;
/**
"id":"1129",
"room_id":"4",
"user_id":"373",
"answer_to":"0",
"time":"1470273020",
"liked":"0",
"message":"https://docs.google.com/document/d/10ecBnXMjMO2OjsAR5hrpJUvOLntfh8Vx8BzBMxoF74s/edit ", -- Текст сообщения
"isLike":"0", -- Добавлено в избранное или нет
"meta":[ -- Мета данные о содержании
{ -- могут содержать массив с описанием объектов прикреплённык с сообщению таких как картинки или ссылки
"description":"", -- с описанием пути к прьевью, типа, писания и заголовка и других доп данных.
"image_src":"2016/216/3/57a295f80a4a7",
"title":"Верстка чата - Google Docs",
"url":"https://docs.google.com/document/d/10ecBnXMjMO2OjsAR5hrpJUvOLntfh8Vx8BzBMxoF74s/edit",
"type":"link",
"id":"157a295f66ccaa"
}
]
}
*/
thisObj.getLocalRoomHistory(message.room_id).addMessage({
data: message,
uuid: message.uuid,
id: message.id,
time: message.time
});
this.addUsersInfo(user)
var roomInfo = thisObj.getRoomInfoById(message.room_id);
if (roomInfo.relation == roomChat.relation.blocked) {
return;
}
if (this.opened_room && this.opened_room.room_id == message.room_id && this.inSearchMode == false) {
this.opened_room.last_message = message
if (this.isIgnored(this.getOponentForRoom(this.opened_room.room_id).user_id)) {
return;
}
this.addMessageToHistory(message)
this.scrollBottom()
if (this.opt.user_id != message.user_id) {
this.markAsRead(message)
this.tryIncrementDeltaMessagesSum()
}
}
else if (!this.getRoomInfoById(message.room_id) && !this.isIgnored(message.user_id)) {
this.tryPlaySound(message.room_id)
$.when(this.updateContactList()).done(function () {
var roomInfo = thisObj.getRoomInfoById(message.room_id)
tabSignal.emit("onNewMessage", {
message: message,
user: user,
room: roomInfo,
useSound: thisObj.isUseSound() && thisObj.isUseSoundInRoom(message.room_id),
})
})
}
else if (!this.isIgnored(message.user_id)) {
var roomInfo = this.getRoomInfoById(message.room_id)
tabSignal.emit("onNewMessage", {
message: message,
user: user,
room: roomInfo,
useSound: this.isUseSound() && this.isUseSoundInRoom(message.room_id),
})
if (!roomInfo.newMessages) {
roomInfo.newMessages = 0;
}
if (this.opt.user_id != message.user_id) {
roomInfo.newMessages++;
}
roomInfo.last_message = message
chatDialogsList.upDialogInList(roomInfo)
this.updateNewMessagesSum();
this.tryPlaySound(message.room_id)
}
}
roomChat.sendSelfGeoPoint = function (text) {
let thisObj = this;
navigator.geolocation.getCurrentPosition(
function (position) {
thisObj.addMessageMeta("self-geopoint", {
longitude: position.coords.longitude,
latitude: position.coords.latitude
});
thisObj.sendMessage();
/*
В объекте position изложена подробная информация
о позиции устройства:
position = {
coords: {
latitude - Широта.
longitude - Долгота.
altitude - Высота в метрах над уровнем моря.
accuracy - Погрешность в метрах.
altitudeAccuracy - Погрешность высоты над уровнем моря в метрах.
heading - Направление устройства по отношению к северу.
speed - Скорость в метрах в секунду.
}
timestamp - Время извлечения информации.
}
*/
},
function (error) {
var message = gettext('imbachat', 'geo_denied')
if (error && error.code == 1) {
message = gettext('imbachat', 'geo_no_permission')
}
if (error && error.code == 2) {
message = gettext('imbachat', 'geo_disabled')
}
if (error && error.code == 3) {
message = gettext('imbachat', 'geo_failed')
}
if(window.guiToast){
window.guiToast.show({
title: gettext('imbachat', 'user_error'),
message: message
});
}
/*
При неудаче, будет доступен объект error:
error = {
code - Тип ошибки
1 - PERMISSION_DENIED
2 - POSITION_UNAVAILABLE
3 - TIMEOUT
message - Детальная информация.
}
*/
}
);
}
roomChat.appendAudioPopUp = function () {
var thisObj = this;
jQuery(".iziToast-body").insertTpl(thisObj.just.renderSync('recording_audio_modal'));
}
roomChat.appendVideoPopUp = function () {
var thisObj = this;
jQuery(".iziToast-body").insertTpl(thisObj.just.renderSync('recording_video_modal'));
}
roomChat.isAlowRecording = function () {
return window.AudioContext !== undefined && (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia)
}
roomChat.startRecording = function (opt) {
var thisObj = this;
if (!thisObj.isAlowRecording()) {
return;
}
thisObj.audioRecordOptions = opt
if (thisObj.audioRecordTimeoutId) {
return;
}
if (thisObj.audioInExport) {
}
if (thisObj.audioRecordIntervalId) {
clearInterval(thisObj.audioRecordIntervalId)
thisObj.audioRecordIntervalId = undefined
}
var t = new Date()
thisObj.audioRecoder.startRecordingProcess(opt.mode, function (stream) {
var t2 = new Date()
thisObj.audioRecordTimeoutId = setTimeout(thisObj.stopRecording, 3 * 60 * 1000);
if (opt.mode == 'video') {
document.getElementById("roomVideoChat-video-recording-stream").srcObject = stream;
}
jQuery("#roomVideoChat-room-recording-modal").addClass('active');
if (!jQuery('.js-circle-loader').data('circle-progress')) {
try {
thisObj.audioProgressTimer = jQuery('.js-circle-loader');
thisObj.audioProgressTimer.circleProgress({
startAngle: -Math.PI / 4 * 3,
value: 0.0,
size: 140,
lineCap: 'round',
fill: {
color: '#269cba'
}
});
} catch (e) { };
}
try {
thisObj.audioProgressTimer.circleProgress('value', 0);
} catch (e) { };
jQuery(".roomVideoChat-recording-time").insertTpl(gettext('Speak'))
var startTime = dayjs()
thisObj.audioRecordIntervalId = setInterval(function () {
var cTime = dayjs().unix()
cTime.add(dayjs().diff(startTime));
jQuery(".roomVideoChat-recording-time").insertTpl(cTime.format("mm:ss"))
try {
thisObj.audioProgressTimer.circleProgress('value', cTime.unix() / 180);
} catch (e) { };
}, 1000);
if (opt && opt.success) opt.success()
},
function (error) {
thisObj.cancelRecording();
if(window.guiToast){
window.guiToast.show({
title: gettext('imbachat', 'user_error'),
message: gettext('imbachat', opt.mode + '_denied')
});
}
window.imbaLog.error("Не получен доступ к медиа потоку", error);
if (opt && opt.error) opt.error()
})
return true;
}
roomChat.stopRecording = function () {
if(window.iziToast){
toast = iziToast.toast;
iziToast.hide({ transitionOut: 'fadeOutUp' }, toast);
}
jQuery("#roomVideoChat-room-recording-modal").removeClass('active');
if (!this.audioRecordTimeoutId) {
window.imbaLog.error("Не запущено roomVideoChat.audioRecordTimeoutId = ", this.audioRecordTimeoutId)
return;
}
if (!this.isRecordingInit) {
window.imbaLog.error("Не инициализировано ещё roomVideoChat.isRecordingInit = ", this.isRecordingInit)
return;
}
if (this.audioInExport) {
window.imbaLog.error("Запущено, мы в процессе конвертации аудио в mp3 roomVideoChat.audioInExport = ", this.audioInExport)
}
this.audioInExport = true;
if (this.audioRecordIntervalId) {
clearInterval(this.audioRecordIntervalId)
this.audioRecordIntervalId = undefined
}
if (this.audioProgressTimer) {
try {
this.audioProgressTimer.circleProgress('value', 0);
} catch (e) { };
}
if (this.audioRecordTimeoutId) {
clearTimeout(this.audioRecordTimeoutId)
this.audioRecordTimeoutId = undefined;
}
var thisObj = this;
this.audioRecoder.stopRecordingProcess(function (blob) {
window.imbaLog.log("Аудио/Видео запись прикреплена, size = " + blob.size, blob, thisObj.audioRecordOptions.mode);
thisObj.audioBlobData = blob;
thisObj.audioInExport = false;
thisObj.sendMessage();
});
}
roomChat.cancelRecording = function () {
var thisObj = this;
jQuery("#roomVideoChat-room-recording-modal").removeClass('active');
if (thisObj.audioRecordTimeoutId) {
clearTimeout(thisObj.audioRecordTimeoutId)
thisObj.audioRecordTimeoutId = undefined
}
if (thisObj.audioRecordIntervalId) {
clearInterval(thisObj.audioRecordIntervalId)
thisObj.audioRecordIntervalId = undefined
}
if (thisObj.audioProgressTimer) {
try {
thisObj.audioProgressTimer.circleProgress('value', 0);
} catch (e) { };
}
thisObj.audioRecoder.stopRecordingProcess()
thisObj.audioBlobData = undefined
if(window.iziToast){
toast = iziToast.toast;
iziToast.hide({ transitionOut: 'fadeOutUp' }, toast);
}
}
roomChat.addMessageMeta = function (type, data) {
this.messageMeta.push({ type: type, data: data })
}
roomChat.messageMeta = [];
/**
*/
roomChat.uploadFile = function (event) {
var files = event.target.files;
var thisObj = this;
var count = 1
for (let i = 0; i < count && i < event.target.files.length; i++) {
if (event.target.files[i].size > 1024 * 1024 * 4) {
if(window.iziToast){
toast = iziToast.toast;
iziToast.hide({ transitionOut: 'fadeOutUp' }, toast);
}
if(window.guiToast){
window.guiToast.show({
title: gettext('imbachat', 'user_error'),
message: gettext('imbachat', 'file_size'),
});
}
return;
}
if (/^image\/(jpeg|png|jpg)$/i.test(event.target.files[i].type)) {
var reader = new FileReader();
reader.onload = (function (indexInArray) {
return function (e) {
thisObj.uploadFilesList[indexInArray].ios_file_data = e.target.result
thisObj.sendMessage();
};
})(thisObj.uploadFilesList.length);
thisObj.uploadFilesList.push(event.target.files[i]);
reader.readAsDataURL(event.target.files[i]);
}
else {
if (!/\.(doc|docx|csv|xls|xlsx|rtf|txt|ppt|pptx|pdf|djvu|fb2|png|jpg|gif|psd|ps|mp3|ogg|wav|rar|tar|gz|zip|mp4|3gp|avi|flv|mkv|m4a)$/i.test(event.target.files[i].name)) {
if(window.iziToast){
toast = iziToast.toast;
iziToast.hide({ transitionOut: 'fadeOutUp' }, toast);
}
if(window.guiToast){
window.guiToast.show({
title: gettext('imbachat', 'user_error'),
message: gettext('imbachat', 'file_not_supported'),
});
}
return;
}
thisObj.uploadFilesList.push(event.target.files[i]);
thisObj.sendMessage();
}
}
}
window.openImg = function(elem){
if(window.cordova){
if ( window.cordova ? window.cordova.platformId == 'android' : true ) {
cordova.InAppBrowser.open(elem.getAttribute('href'), "_blank", "location=yes")
}else{
return false;
}
}else{
return true;
}
}
roomChat.getPreviewHTML = function (file) {
let id = (Math.random() + '').replace('0.', '');
src = "<img id='" + id + "' src='' style='height: 150px'>";
if (isCordova() && cordova.platformId == 'ios') {
src = "<a href='" + file.ios_file_data + "' onclick='return window.openImg(this)' class='chatImgLink' data-fancybox='chatImg'><img id='" + id + "' class='chatImgThumb' ></a>";
} else {
var reader = new FileReader();
reader.onload = function (e) {
document.getElementById(id).src = e.target.result
};
reader.onloadend = function (e) {
document.getElementById(id).src = e.target.result
};
reader.readAsDataURL(file); // Отключили прьевью так как дизайном не предусмотрено
src = "<a class='chatImgLink'><img id='" + id + "' class='chatImgThumb' ></a>";
}
return src;
}
/**
*/
roomChat.keydownSendMessage = function (event) {
if (/*event.ctrlKey &&*/ event.keyCode === 13) {
this.sendMessage()
return;
}
}
/**
*/
roomChat.getMessageText = function () {
if (this.opt.useEmojioneArea) {
return this.emojioneArea[0].emojioneArea.getText("imbachat", 'image');
}
return jQuery("#roomVideoChat-input-message").val();
}
roomChat.setMessageText = function (text) {
if (!text) {
text = ''
}
if (this.opt.useEmojioneArea) {
jQuery(".emojionearea-editor").html(text)
if (!this.emojioneArea || !this.emojioneArea[0] || this.emojioneArea[0].emojioneArea) {
return;
}
return this.emojioneArea[0].emojioneArea.setText(text);
}
jQuery("#roomVideoChat-input-message").val(text)
}
roomChat.getBrowserInfo = function () {
var nVer = navigator.appVersion;
var nAgt = navigator.userAgent;
var browserName = navigator.appName;
var fullVersion = '' + parseFloat(navigator.appVersion);
var majorVersion = parseInt(navigator.appVersion, 10);
var nameOffset, verOffset, ix;
if ((verOffset = nAgt.indexOf("Opera")) != -1) {
browserName = "Opera";
fullVersion = nAgt.substring(verOffset + 6);
if ((verOffset = nAgt.indexOf("Version")) != -1)
fullVersion = nAgt.substring(verOffset + 8);
}
else if ((verOffset = nAgt.indexOf("MSIE")) != -1) {
browserName = "Microsoft Internet Explorer";
fullVersion = nAgt.substring(verOffset + 5);
}
else if ((verOffset = nAgt.indexOf("Chrome")) != -1) {
browserName = "Chrome";
fullVersion = nAgt.substring(verOffset + 7);
}
else if ((verOffset = nAgt.indexOf("Safari")) != -1) {
browserName = "Safari";
fullVersion = nAgt.substring(verOffset + 7);
if ((verOffset = nAgt.indexOf("Version")) != -1)
fullVersion = nAgt.substring(verOffset + 8);
}
else if ((verOffset = nAgt.indexOf("Firefox")) != -1) {
browserName = "Firefox";
fullVersion = nAgt.substring(verOffset + 8);
}
else if ((nameOffset = nAgt.lastIndexOf(' ') + 1) <
(verOffset = nAgt.lastIndexOf('/'))) {
browserName = nAgt.substring(nameOffset, verOffset);
fullVersion = nAgt.substring(verOffset + 1);
if (browserName.toLowerCase() == browserName.toUpperCase()) {
browserName = navigator.appName;
}
}
if ((ix = fullVersion.indexOf(";")) != -1)
fullVersion = fullVersion.substring(0, ix);
if ((ix = fullVersion.indexOf(" ")) != -1)
fullVersion = fullVersion.substring(0, ix);
majorVersion = parseInt('' + fullVersion, 10);
if (isNaN(majorVersion)) {
fullVersion = '' + parseFloat(navigator.appVersion);
majorVersion = parseInt(navigator.appVersion, 10);
}
let browser = {
name: browserName,
fullVersion: fullVersion,
majorVersion: majorVersion,
userAgent: navigator.userAgent
}
var unknown = undefined;
var os = unknown;
var clientStrings = [
{ s: 'Windows 10', r: /(Windows 10.0|Windows NT 10.0)/ },
{ s: 'Windows 8.1', r: /(Windows 8.1|Windows NT 6.3)/ },
{ s: 'Windows 8', r: /(Windows 8|Windows NT 6.2)/ },
{ s: 'Windows 7', r: /(Windows 7|Windows NT 6.1)/ },
{ s: 'Windows Vista', r: /Windows NT 6.0/ },
{ s: 'Windows Server 2003', r: /Windows NT 5.2/ },
{ s: 'Windows XP', r: /(Windows NT 5.1|Windows XP)/ },
{ s: 'Windows 2000', r: /(Windows NT 5.0|Windows 2000)/ },
{ s: 'Windows ME', r: /(Win 9x 4.90|Windows ME)/ },
{ s: 'Windows 98', r: /(Windows 98|Win98)/ },
{ s: 'Windows 95', r: /(Windows 95|Win95|Windows_95)/ },
{ s: 'Windows NT 4.0', r: /(Windows NT 4.0|WinNT4.0|WinNT|Windows NT)/ },
{ s: 'Windows CE', r: /Windows CE/ },
{ s: 'Windows 3.11', r: /Win16/ },
{ s: 'Android', r: /Android/ },
{ s: 'Open BSD', r: /OpenBSD/ },
{ s: 'Sun OS', r: /SunOS/ },
{ s: 'Linux', r: /(Linux|X11)/ },
{ s: 'iOS', r: /(iPhone|iPad|iPod)/ },
{ s: 'Mac OS X', r: /Mac OS X/ },
{ s: 'Mac OS', r: /(MacPPC|MacIntel|Mac_PowerPC|Macintosh)/ },
{ s: 'QNX', r: /QNX/ },
{ s: 'UNIX', r: /UNIX/ },
{ s: 'BeOS', r: /BeOS/ },
{ s: 'OS/2', r: /OS\/2/ },
{ s: 'Search Bot', r: /(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/ }
];
for (var id in clientStrings) {
var cs = clientStrings[id];
if (cs.r.test(navigator.userAgent)) {
os = cs.s;
break;
}
}
var osVersion = unknown;
if (/Windows/.test(os)) {
osVersion = /Windows (.*)/.exec(os)[1];
os = 'Windows';
}
switch (os) {
case 'Mac OS X':
osVersion = /Mac OS X (10[\.\_\d]+)/.exec(nAgt)[1];
break;
case 'Android':
osVersion = /Android ([\.\_\d]+)/.exec(nAgt)[1];
break;
case 'iOS':
osVersion = /OS (\d+)_(\d+)_?(\d+)?/.exec(nVer);
osVersion = osVersion[1] + '.' + osVersion[2] + '.' + (osVersion[3] | 0);
break;
}
let res = {
'url': window.location.href,
'y_offset': window.pageYOffset,
'x_offset': window.pageXOffset,
's_width': screen.width,
's_height': screen.height,
'w_width': document.body.clientWidth,
'w_height': document.body.clientHeight,
'browser': browser.name,
'b_version': browser.fullVersion,
'os': os,
'mobile': /Mobile|mini|Fennec|Android|iP(ad|od|hone)/.test(navigator.appVersion),
}
if (osVersion) {
res.os_v = osVersion
}
if (isCordova()) {
res['url'] = 'Application';
}
return res;
}
roomChat.generateMessageUUID = function (room_id) {
let uuid = "" + room_id + "-" + (new Date()).getTime() + "-"
let base = 'qwertyuiopasdfghjklzxcvbnm123456789QWERTYUIOPASDFGHJKLZXCVBNM12345678900'
for (let i = 0; i < 6; i++) {
let index = Math.floor(Math.random() * (base.length - 1));
uuid += base[index]
}
return uuid;
}
/**
*/
roomChat.sendMessage = function (message, sendRoomId) {
/* if(!this.chatDB.dataObj.selfInfo || !this.opt.user_id )
{
showUserLoginPopup()
}*/
if (!sendRoomId && !this.opened_room) {
return;
}
if (!sendRoomId) {
sendRoomId = this.opened_room.room_id;
}
if (this.audioInExport) {
return;
}
jQuery("#roomVideoChat-input-message")[0].focus();
var fd = new FormData();
if (this.lastLinkInfo && this.lastLinkInfo.id) {
fd.append('link_id', this.lastLinkInfo.id);
}
if (message == undefined) {
message = this.getMessageText();
}
if (this.uploadFilesList.length == 0 && this.messageMeta.length == 0) {
if ((!message || message.length == 0 || message.replace(/[\n\r\t\s ]/gm, "").length == 0)
/* && this.countPreviewList() == 0*/ && !this.audioBlobData) {
return;
}
}
this.setMessageText('');
var thisObj = this;
setTimeout(function () {
thisObj.setMessageText('');
}, 10)
for (var i = 0; i < this.uploadFilesList.length; i++) {
if (this.uploadFilesList[i] === undefined) {
continue;
}
fd.append('files[]', this.uploadFilesList[i]);
}
var answer_to = message.match(/^ *#[0-9]+: */img)
if (answer_to && answer_to[0]) {
answer_to = answer_to[0].replace(/^ *#([0-9]+): */img, "$1")
}
message = message.replace(/^ *#[0-9]+: */img, "")
fd.append('message', message);
fd.append('room_id', sendRoomId);
fd.append('answer_to', answer_to);
if (this.audioBlobData) {
if (this.audioRecordOptions.mode == 'video') {
fd.append('video_message', this.audioBlobData);
}
else {
fd.append('audio_message', this.audioBlobData);
}
}
fd.append('user_id', this.opt.user_id);
fd.append('user_key', this.opt.user_key);
fd.append('extended_meta', JSON.stringify(this.getBrowserInfo()));
jQuery("#" + this.class_name + "-image-preview-holder").insertTpl('');
fd.append('cultivate', "roomVideoChat." + this.opt.URL_sendMessage);
var uuid = this.generateMessageUUID(sendRoomId);
fd.append('uuid', uuid);
fd.append('message_meta', JSON.stringify(this.messageMeta));
for (let i = 0; i < this.uploadFilesList.length; i++) {
if (this.uploadFilesList[i].size > thisObj.opt.uploadMaxFilesize) {
if (isCordova()) {
showToastMessage('Размер файла не должен превышать 1MB', 'long', 'bottom', -200);
this.uploadFilesList = [];
return false;
}
alert('Размер файла не должен превышать 1MB');
this.uploadFilesList = [];
return false;
}
if (window.cordova && window.cordova.file) {
var file = this.uploadFilesList[i];
window.requestFileSystem(window.TEMPORARY, 5 * 1024 * 1024, function (fs) {
window.imbaLog.log('file system open: ' + fs.name);
getSampleFile(fs.root);
}, (err) => { window.imbaLog.log(err) });
function getSampleFile(dirEntry) {
var blob = new Blob([file], { type: file.type });
saveFile(dirEntry, blob, file.name);
}
function saveFile(dirEntry, fileData, fileName) {
if(fileName == "image.jpg"){
fileName = Math.random().toString(36).substring(2) + '.jpg';
}
dirEntry.getFile(fileName, { create: true, exclusive: false }, function (fileEntry) {
writeFile(fileEntry, fileData);
}, (err) => { window.imbaLog.log(err) });
}
function writeFile(fileEntry, dataObj, isAppend) {
fileEntry.createWriter(function (fileWriter) {
fileWriter.onwriteend = function () {
window.imbaLog.log("Successful file write...");
};
fileWriter.onerror = function (e) {
window.imbaLog.log("Failed file write: " + e.toString());
};
fileWriter.write(dataObj);
});
}
}
let justTplName = "message_meta_file-" + this.uploadFilesList[i].type.split('/')[0] + "-local";
if (this.just.isTplExists(justTplName)) {
this.messageMeta.push({
name: this.uploadFilesList[i].name,
fileType: this.uploadFilesList[i].type,
type: "file-" + this.uploadFilesList[i].type.split('/')[0] + "-local",
file: this.uploadFilesList[i]
})
} else {
this.messageMeta.push({
name: this.uploadFilesList[i].name,
fileType: this.uploadFilesList[i].type,
type: "file-other-local",
file: this.uploadFilesList[i]
})
}
}
if (this.audioBlobData) {
if (this.audioRecordOptions.mode == 'video') {
this.messageMeta.push({
name: this.audioBlobData.name,
fileType: this.audioBlobData.type,
type: "file-video-message-local",
file: this.audioBlobData
})
} else {
this.messageMeta.push({
name: this.audioBlobData.name,
fileType: this.audioBlobData.type,
type: "file-audio-message-local",
file: this.audioBlobData
})
}
}
var local_message = {
answer_to: 0,
id: 0,
liked: 0,
message: message,
meta: this.messageMeta,
room_id: sendRoomId,
send_status: 'sending',
time: dayjs().unix(),
user_id: this.opt.user_id,
uuid: uuid,
}
$.when(thisObj.getLocalRoomHistory(sendRoomId).addMessage({
data: local_message,
uuid: uuid,
id: 0,
time: local_message.time
})).done(() => {
if (!thisObj.inSearchMode) {
thisObj.addMessageToHistory(local_message)
thisObj.scrollBottom()
}
})
this.audioBlobData = undefined;
jQuery("#" + this.class_name + "-preview-audio-player").trigger('inpPlayerStop');
this.messageMeta = [];
this.uploadFilesList = [];
var roomInfo = thisObj.getRoomInfoById(sendRoomId);
roomInfo.last_message = local_message;
chatDialogsList.upDialogInList(roomInfo)
thisObj.apiCall({
reTryInOnline: false,
ignore: false,
url: this.opt.api_host,
type: "POST",
data: fd,
processData: false,
contentType: false,
xhr: function () {
$("#roomVideoChat-message-uuid-" + local_message.uuid + " .messages__info-date").hide()
var xhr = jQuery.ajaxSettings.xhr(); // получаем объект XMLHttpRequest
xhr.upload.addEventListener('progress', function (evt) {
if (evt.lengthComputable) {
var percentComplete = Math.ceil(evt.loaded / evt.total * 100);
roomChat.messagePreloader(local_message, percentComplete)
}
}, false);
return xhr;
},
success: function (data) {
if (local_message.meta[0] && local_message.meta[0].type == "file-other-local") {
$('#roomVideoChat-message-uuid-' + local_message.uuid + ' .file-icon')[0].style.display = 'block';
$("#roomVideoChat-message-uuid-" + local_message.uuid + " .filePreloader")[0].style.display = 'none';
}
if (local_message.meta[0] && local_message.meta[0].type == "file-image-local") {
$("#roomVideoChat-message-uuid-" + local_message.uuid + " .imgPreloader")[0].style.display = 'none';
}
$("#roomVideoChat-message-uuid-" + local_message.uuid + " .messages__info-date").show()
if (typeof data != "object") {
data = JSON.parse(data)
}
if (thisObj.ajaxErrorTest(data)) {
local_message.send_status = "error";
return;
}
if (roomInfo.status == roomChat.status.default && thisObj.opt.enable_status_field) {
roomInfo.status = 1
thisObj.closeRoom();
thisObj.openRoom(roomInfo.room_id);
}
thisObj.addUsersInfo(data.user)
if ($(".message-uuid-" + data.message.uuid).hasClass('message-not-sended')) {
$(".message-uuid-" + data.message.uuid)
.removeClass("message-not-sended")
.addClass("message-sended")
.addClass("message-id-" + data.message.id)
}
data.message.send_status = "sent";
thisObj.getLocalRoomHistory(sendRoomId).addMessage({
data: data.message,
uuid: uuid,
id: data.message.id,
time: local_message.time
});
},
error: function () {
if (local_message.meta[0] && local_message.meta[0].type == "file-other-local") {
$('#roomVideoChat-message-uuid-' + local_message.uuid + ' .file-icon')[0].style.display = 'block';
$("#roomVideoChat-message-uuid-" + local_message.uuid + " .filePreloader")[0].style.display = 'none';
}
if (local_message.meta[0] && local_message.meta[0].type == "file-image-local") {
$("#roomVideoChat-message-uuid-" + local_message.uuid + " .imgPreloader")[0].style.display = 'none';
}
$("#roomVideoChat-message-uuid-" + local_message.uuid + " .messages__info-date").show()
local_message.send_status = "error";
thisObj.getLocalRoomHistory(sendRoomId).addMessage({
data: local_message,
uuid: uuid,
id: 0,
time: local_message.time
})
}
});
}
roomChat.messagePreloader = function (local_message, progressEvent) {
if (local_message.meta && local_message.meta.length == 0) {
return
}
if (local_message.meta[0] && local_message.meta[0].type == "file-image-local") {
var el = $("#roomVideoChat-message-uuid-" + local_message.uuid + " .roomVideoChat-type-local-image .imgPreloader")[0];
} else if (local_message.meta[0] && local_message.meta[0].type == "file-other-local") {
var icon = $('#roomVideoChat-message-uuid-' + local_message.uuid + ' .file-icon')[0];
var el = $("#roomVideoChat-message-uuid-" + local_message.uuid + " .filePreloader")[0];
icon.style.display = 'none'
} else {
return
}
if (!el) {
$("#roomVideoChat-message-uuid-" + local_message.uuid + " .messages__info-date").show()
return
}
el.setAttribute('data-percentage', Math.floor(progressEvent));
if (progressEvent < 50)
el.style.backgroundImage = "linear-gradient(-90deg, transparent 50%, transparent 50%), linear-gradient(" + (-90 + progressEvent * 3.6) + "deg, transparent 50%, rgb(100, 100, 100) 50%)";
else if (progressEvent > 50 && progressEvent <= 100)
el.style.backgroundImage = "linear-gradient(" + (90 + ((progressEvent - 50) * 3.6)) + "deg, transparent 50%, rgb(100, 100, 100) 50%), linear-gradient(90deg, transparent 50%, rgb(100, 100, 100) 50%)";
if (progressEvent > 100)
if (local_message.meta[0] && local_message.meta[0].type == "file-image-local") {
icon.style.display = 'block'
el.style.display = "none";
}
progressEvent = 0;
}
roomChat.sendFilePopUp = function () {
let thisObj = this;
if ($('.iziToast-body').length > 0) {
return false
} else {
iziToast.show({
theme: 'dark',
icon: 'icon-person',
title: gettext('imbachat', 'attach_content'),
message: false,
position: 'center', // bottomRight, bottomLeft, topRight, topLeft, topCenter, bottomCenter
timeout: false,
inputs: [
['<input type="file" name="chat_files" id="iziFileInput" onchange="imbaChat.uploadFile(event, this)" style="visibility: hidden; width: 0; height: 0;"></input>', function (instance, toast, input, e) {
window.imbaLog.info('input');
iziToast.hide({ transitionOut: 'fadeOutUp' }, toast);
}],
],
buttons: [
['<button>' + gettext("imbachat", 'attach_pictures') + '</button>', function (instance, toast) {
$('#iziFileInput').trigger('click');
}], // true to focus
['<button>' + gettext("imbachat", 'attach_location') + '</button>', function (instance, toast) {
thisObj.sendSelfGeoPoint();
iziToast.hide({ transitionOut: 'fadeOutUp' }, toast);
}], // true to focus
['<button>' + gettext("imbachat", 'send_voice_msg') + '</button>', function (instance, toast) {
thisObj.appendAudioPopUp();
thisObj.startRecording({ mode: 'audio' })
}], // true to focus
['<button>' + gettext("imbachat", 'send_video_msg') + '</button>', function (instance, toast) {
thisObj.appendVideoPopUp();
thisObj.startRecording({ mode: 'video' })
}], // true to focus
],
onOpening: function (instance, toast) {
window.imbaLog.info('Attach files!');
},
onClosing: function (instance, toast, closedBy) {
if (closedBy == 'button' || closedBy == 'drag') {
thisObj.cancelRecording()
}
window.imbaLog.info('closedBy: ' + closedBy); // tells if it was closed by 'drag' or 'button'
}
});
}
}
roomChat.getCaret = function (el) {
if (el.selectionStart) {
return el.selectionStart;
} else if (document.selection) {
el.focus();
var r = document.selection.createRange();
if (r == null) {
return 0;
}
var re = el.createTextRange(),
rc = re.duplicate();
re.moveToBookmark(r.getBookmark());
rc.setEndPoint('EndToStart', re);
return rc.text.length;
}
return 0;
}
/**
*/
roomChat.onKeypressMessage = function (event) {
if (event && event.type == 'keydown') {
if ((event.keyCode === 10 || event.keyCode === 13) && (event.ctrlKey || event.altKey || event.shiftKey)) {
let start = this.getCaret(jQuery("#roomVideoChat-input-message")[0])
let text = this.getMessageText()
this.setMessageText(text.slice(0, start) + "\n" + text.slice(start))
}
else if (event.keyCode === 13) {
this.sendMessage()
return false;
}
}
if (!this.isOnline()) {
return;
}
if (!this.opened_room) {
return;
}
if (this.tId) {
clearTimeout(this.tId)
this.tId = undefined
}
else {
this.apiCall({
type: "POST",
dataType: 'json',
url: this.opt.api_host,
data: {
cultivate: 'roomVideoChat.typingMessage',
room_id: this.opened_room.room_id,
user_id: this.opt.user_id,
user_key: this.opt.user_key,
isTyping: 1
},
success: function (data) {
}
});/**/
}
this.tId = setTimeout(() => {
this.tId = undefined
this.apiCall({
type: "POST",
dataType: 'json',
url: this.opt.api_host,
data: {
cultivate: 'roomVideoChat.typingMessage',
room_id: this.opened_room.room_id,
user_id: this.opt.user_id,
user_key: this.opt.user_key,
isTyping: 0
},
success: function (data) {
}
});
}, 1000)
}
/**
*/
roomChat.onTypingMessage = function (event) {
var thisObj = this;
if (event.data.isTyping) {
jQuery("#roomVideoChat-user-dialog-" + event.data.room_id).addClass("roomVideoChat-typing-message");
}
else {
jQuery("#roomVideoChat-user-dialog-" + event.data.room_id).removeClass("roomVideoChat-typing-message");
}
jQuery("#roomVideoChat-typing-message").remove();
if (this.opened_room && this.opened_room.room_id == event.data.room_id && this.inSearchMode == false) {
if (event.data.isTyping) {
jQuery(".roomVideoChat-messages-list").appendTpl("<div id='roomVideoChat-typing-message'><span style='display:none;' class='typing-name'>" +
"</span>&nbsp;" + gettext('imbachat', 'user_typing_message') + "<span class='typing-svg'></span></div>");
/*if(jQuery(".roomVideoChat-messages-list").prop('scrollHeight') - jQuery(".roomVideoChat-messages-list").scrollTop() - jQuery("#spajs-right-area").css('height').replace("px", "")/1 < 100)
{
this.scrollBottom()
}*/
}
}
}
/**
*/
roomChat.searchInContacts = function (text) {
if (!text) {
return this.showAllContacts()
}
text = text.toLowerCase()
jQuery("." + this.class_name + "-contact-list").addClass("role-search-in-contacts");
let rooms = jQuery(".contact-list .role-dialog-item")
let found = 0
for (let i = 0; i < rooms.length; i++) {
let name = $(rooms[i]).find('.room_in_list__description-name').text()
if (name.toLowerCase().indexOf(text) === -1) {
$(rooms[i]).hide();
}
else {
$(rooms[i]).show();
found++
}
}
if (!found) {
jQuery("." + this.class_name + "-contact-list").addClass("role-empty-search-result");
}
else {
jQuery("." + this.class_name + "-contact-list").removeClass("role-empty-search-result");
}
}
/**
*/
roomChat.showAllContacts = function () {
jQuery("." + this.class_name + "-contact-list").removeClass("role-empty-search-result");
jQuery("." + this.class_name + "-contact-list").removeClass("role-search-in-contacts");
jQuery(".contact-list .role-dialog-item").show()
}
/**
*/
roomChat.tryIncrementDeltaMessagesSum = function () {
if (!this.isActiveTab) {
this.deltaMessagesSum += 1
if (this.opt.useFaviconBadge) {
this.favicon.badge('+' + this.deltaMessagesSum);
}
}
}
/**
*/
roomChat.setTitle = function (text = undefined) {
if (!window.last_document_title) {
window.last_document_title = document.title;
}
if (!text) {
document.title = window.last_document_title;
}
else {
document.title = text;
}
}
/**
*/
roomChat.clearMessageCounter = function (roomInfo) {
var thisObj = this;
roomInfo.newMessages = 0;
jQuery("#roomVideoChat-user-dialog-" + roomInfo.room_id + " .roomVideoChat-newMessageSum").insertTpl("").hide()
jQuery("#roomVideoChat-user-dialog-" + roomInfo.room_id).removeClass("new-message")
this.updateNewMessagesSum()
this.updateRoomsInfo(this.opt.rooms, true)
}
/**
*
Код подписки на событие изменения количества не прочитанных сообщений
tabSignal.connect("imbaChat.newMessagesUpdate", function(event)
{
alert(event.newMessagesSum)
})
*/
roomChat.updateNewMessagesSum = function () {
var lastValue = this.newMessagesSum
var tabsMessagesSum = []
var newMessagesByDialogs = 0; // number of dialogs with unread messages
this.newMessagesSum = 0;
for (var i in this.opt.rooms) {
if (this.opt.rooms[i].name == "User deleted") {
this.opt.rooms[i].newMessages = 0;
continue
}
this.newMessagesSum += this.opt.rooms[i].newMessages / 1
if (!tabsMessagesSum[this.opt.rooms[i].tab]) {
tabsMessagesSum[this.opt.rooms[i].tab] = 0;
}
tabsMessagesSum[this.opt.rooms[i].tab] += this.opt.rooms[i].newMessages / 1
if (this.opt.rooms[i].newMessages / 1 > 0) {
newMessagesByDialogs++;
}
}
if (this.newMessagesSum < 0) {
this.newMessagesSum = 0
}
for (var i in tabsMessagesSum) {
if (tabsMessagesSum[i] < 0) {
tabsMessagesSum = 0;
}
}
this.tabsMessagesSum = tabsMessagesSum;
if (this.newMessagesSum == 0) {
}
else {
}
this.newMessagesByDialogs = newMessagesByDialogs;
if (lastValue !== this.newMessagesSum) {
tabSignal.emit("imbaChat.newMessagesUpdate", {
newMessagesSum: this.newMessagesSum,
newMessagesByDialogs: newMessagesByDialogs
})
}
return this.newMessagesSum;
}
/**
*/
roomChat.showDilogList = function () {
tabSignal.emit("sidebar.set.open")
}
roomChat.getSelfInfo = function () {
return this.chatDB.loadData('selfInfo');
}
roomChat.updateSelfInfo = function (data, needSave = true) {
if (needSave) {
this.chatDB.saveData('selfInfo', data)
}
}
roomChat.updateRoomsInfo = function (rooms, needSave = true) {
this.opt.rooms = this.sortDilogs(rooms)
for (var i in this.opt.rooms) {
let result = tabSignal.filter("imbaChat.updateRoomsInfo", { chatObj: this, roomInfo: this.opt.rooms[i] })
if (result !== undefined) {
this.opt.rooms[i] = result;
}
if (
this.opt.rooms[i].room_type == this.room_type.dialog
&& this.isIgnored(this.getOponentForRoom(this.opt.rooms[i].room_id).user_id)
) {
continue;
}
this.subscriptionIfPublicRoom(this.opt.rooms[i])
}
if (needSave) {
this.chatDB.saveData('rooms', this.opt.rooms)
}
this.updateNewMessagesSum();
tabSignal.emit("chat.updateContactCount", { chatObj: this })
}
/**
*/
roomChat.updateFromCache = function () {
var def = new jQuery.Deferred();
this.chatDB.loadData('selfInfo').then((selfInfo) => {
if (selfInfo.user_id != this.opt.user_id) {
window.imbaLog.log("updateFromCache dropData")
this.chatDB.dropData().then(() => { }).catch(() => { })
def.reject()
return;
}
window.imbaLog.log("updateFromCache load selfInfo")
this.updateSelfInfo(selfInfo, false)
this.chatDB.loadData('users').then((users) => {
this.addUsersInfo(users, false)
this.chatDB.loadData('ignored').then((ignored) => {
this.updateIgnored(ignored, false)
this.chatDB.loadData('rooms').then((rooms) => {
this.updateRoomsInfo(rooms, false)
tabSignal.emit("chat.updateContactList")
def.resolve()
}).catch(() => {
def.reject()
})
}).catch(() => {
def.reject()
})
}).catch(() => {
def.reject()
})
}).catch(() => {
def.reject()
})
return def.promise();
}
/**
*/
roomChat.updateContactList = function () {
var thisObj = this;
var def = new jQuery.Deferred();
thisObj.apiCall({
ignore: true,
url: thisObj.opt.api_host,
type: "POST",
dataType: 'json',
data: {
cultivate: 'roomVideoChat.' + thisObj.opt.URL_getSelfInfo,
user_id: thisObj.opt.user_id,
user_key: thisObj.opt.user_key,
},
success: function (response) {
if (!response.success) {
def.reject(response)
return response;
}
thisObj.updateSelfInfo(response.myInfo);
thisObj.addUsersInfo(response.contacts)
thisObj.updateIgnored(response.ignored)
thisObj.updateRoomsInfo(response.dilogs)
tabSignal.emit("chat.updateContactList")
def.resolve()
},
error: function () {
def.reject({ error: "Network error!", 'error_code': 'network_error' });
}
});
return def.promise();
}
roomChat.getSoundNameByPaySum = function (sum) {
if (sum < 5) {
return 'newPayInChat-pay1';
}
if (sum < 10) {
return 'newPayInChat-pay2';
}
if (sum < 20) {
return 'newPayInChat-pay3';
}
if (sum < 40) {
return 'newPayInChat-pay4';
}
return 'newPayInChat-pay5';
}
roomChat.sendHangupToOtherTabs = function () {
return this.apiCall({
type: "POST",
dataType: 'json',
url: this.opt.api_host,
data: {
cultivate: 'roomVideoChat.sendHangupToOtherTabs',
tabId: cometApi.getTabUUID(),
user_id: this.opt.user_id,
user_key: this.opt.user_key,
},
success: function (data) {
}
});
}
roomChat.joinToPrivate = function (pricing, needToken) {
var thisObj = this;
$.when(thisObj.getStreamToken('private', pricing)).done(function () {
setTimeout(function () {
thisObj.joinToPrivate(pricing, true)
}, 1000 * 60);
}).fail(function () {
return;
})
}
roomChat.stream_mode_offline = -1
roomChat.stream_mode_free = 0
roomChat.stream_mode_show = 1
roomChat.stream_mode_private = 2
roomChat.stream_mode_vip = 3
/**
*/
roomChat.subscriptionIfPublicRoom = function (room_info) {
var thisObj = this;
if (room_info.room_type != this.room_type.public || this.publicSubscriptions[room_info.pipe]) {
return;
}
this.publicSubscriptions[room_info.pipe] = true;
cometApi.subscription(room_info.pipe + ".newMessage", function (event) {
thisObj.onNewMessage(event.data.message, event.data.user)
})
cometApi.subscription(room_info.pipe + ".newPayInChat", function (event) {
thisObj.onNewMessage(event.data, event.data.user)
if (thisObj.opened_room && thisObj.opened_room.room_id == event.data.room_id) {
thisObj.tryPlaySound(event.data.room_id, thisObj.getSoundNameByPaySum(event.data.meta[0].sum))
thisObj.opened_room.paid_for_show = thisObj.opened_room.paid_for_show / 1 + event.data.meta[0].sum / 1
$('.' + thisObj.class_name + '-room-' + event.data.room_id + ' .video__money_sum').html(thisObj.opened_room.paid_for_show.toFixed(2))
}
})
room_info.users_on_page = 1;
cometApi.count_users_in_pipe("track_" + room_info.pipe + "", function (res) {
room_info.users_on_page = res.data.user_in_pipe;
})
setInterval(function () {
cometApi.count_users_in_pipe("track_" + room_info.pipe + "", function (res) {
room_info.users_on_page = res.data.user_in_pipe;
})
}, 60 * 1000)
cometApi.subscription("track_" + room_info.pipe + ".subscription", function (event) {
room_info.users_on_page++;
})
cometApi.subscription("track_" + room_info.pipe + ".unsubscription", function (event) {
room_info.users_on_page--;
if (room_info.users_on_page < 1) {
room_info.users_on_page = 1;
}
})
}
/**
* сортирует диалоги/конференции/комнаты по last_message_time
*/
roomChat.sortDilogs = function (dilogs) {
var sortable_dilogs = []
for (var i in dilogs) {
if (!/^[0-9]+$/img.test(i) || parseInt(dilogs[i].room_id) == 0) {
continue;
}
sortable_dilogs.push(dilogs[i])
}
sortable_dilogs.sort(function (b, a) {
if ((!a.last_message || !a.last_message.time) && (!b.last_message || !b.last_message.time)) {
if (a.created_at && b.created_at) {
return dayjs(a.created_at).unix() / 1 - dayjs(b.created_at).unix() / 1
}
return b.room_id / 1 - a.room_id / 1
}
if (!a.last_message || !a.last_message.time) {
if (!a.created_at || (!b.last_message && !b.last_message.time)) {
if (b.last_message && b.last_message.time) {
return -1
}
return b.room_id / 1 - a.room_id / 1
}
return dayjs(a.created_at).unix() / 1 - dayjs(b.last_message.time) / 1
}
if (!b.last_message || !b.last_message.time) {
if (!b.created_at || (!a.last_message && !a.last_message.time)) {
if (a.last_message && a.last_message.time) {
return 1
}
return b.room_id / 1 - a.room_id / 1
}
return dayjs(a.last_message.time) / 1 - dayjs(b.created_at).unix() / 1
}
return a.last_message.time / 1 - b.last_message.time / 1
})
return sortable_dilogs;
}
/**
*/
roomChat.isSomebodyOnlineInRoom = function (room_id) {
var roomInfo = this.getRoomInfoById(room_id)
if (roomInfo) {
for (var j in roomInfo.users) {
var userInfo = this.allUsersInfo[roomInfo.users[j]]
if (userInfo && userInfo['last_online_time'] == 0 && userInfo['user_id'] != this.opt.user_id) {
roomInfo.isSomebodyOnline = true;
return true;
}
}
roomInfo.isSomebodyOnline = false;
}
return false;
}
/**
*/
roomChat.getAllRoomInfo = function () {
for (var i in this.opt.rooms) {
var val = this.opt.rooms[i]
if (val.room_type == this.room_type.dialog) {
val.name = this.getOponentForRoom(val.room_id).name
}
}
return this.opt.rooms
}
roomChat.trackedUsers = []
roomChat.subscribeToUserStatus = function (user_id) {
if (!this.trackedUsers) {
this.trackedUsers = []
}
if (this.trackedUsers[user_id]) {
return;
}
this.trackedUsers[user_id] = true
cometApi.subscription("user_status_" + user_id + ".online", (event) => {
this.setUsersNetworkStatus(user_id, true)
})
cometApi.subscription("user_status_" + user_id + ".offline", (event) => {
this.setUsersNetworkStatus(user_id, false)
})
}
roomChat.setUsersNetworkStatus = function (user_id, status = 0) {
if (status) {
jQuery(".roomVideoChat-avatar-user-id-" + user_id).addClass("online")
jQuery(".getUserOnlineId-" + user_id).addClass("online")
}
else {
jQuery(".roomVideoChat-avatar-user-id-" + user_id).removeClass("online")
}
}
/**
*/
roomChat.setAllUsersAsOffline = function () {
var time = new Date();
var nowTime = time.getTime() / 1000;
var updateUsers = []
for (var i in this.allUsersInfo) {
if (this.allUsersInfo[i].last_online_time === undefined) {
continue;
}
if (this.allUsersInfo[i].last_online_time == 0) {
updateUsers.push(this.allUsersInfo[i])
this.allUsersInfo[i].last_online_time = nowTime
}
}
tabSignal.emit("onUpdateUsersInfo", { users: updateUsers })
}
/**
*/
roomChat.addUsersInfo = function (usersArray, needSave = true) {
if (!Array.isArray(usersArray) && usersArray.user_id > 0) {
usersArray = [usersArray]
}
var count = 0;
for (var i in usersArray) {
if (isNaN(parseInt(i)) || usersArray[i] === undefined) {
continue;
}
if (!this.allUsersInfo[usersArray[i].user_id]) {
this.allUsersInfo[usersArray[i].user_id] = usersArray[i]
this.subscribeToUserStatus(usersArray[i].user_id)
count++;
continue;
}
for (var j in usersArray[i]) {
this.allUsersInfo[usersArray[i].user_id][j] = usersArray[i][j]
continue;
}
}
tabSignal.emit("onUpdateUsersInfo", { users: usersArray })
if (needSave) {
this.chatDB.saveData('users', this.allUsersInfo)
}
return count;
}
/**
*/
roomChat.getUserInfoById = function (user_id, room_id = undefined) {
try {
if (room_id === undefined) {
}
if (room_id === false) {
}
if (user_id == 0) {
return this.opt.system_user
}
var room = this.getRoomInfoById(room_id)
if (!room) {
return this.opt.deleted_user
}
let profile_id = room.profiles[user_id]
if (profile_id === undefined) {
if (user_id == 0) {
return this.opt.system_user
}
return this.opt.deleted_user
}
let userInfo = this.allUsersInfo[user_id];
if (!this.allUsersInfo[user_id]) {
return this.opt.deleted_user
}
let profileInfo = userInfo.profiles[profile_id]
if (profileInfo) {
profileInfo.last_online_time = userInfo.last_online_time
profileInfo.userInfo = userInfo
return profileInfo;
}
profileInfo = userInfo.profiles[userInfo.remote_user_id]
if (profileInfo) {
profileInfo.last_online_time = userInfo.last_online_time
profileInfo.userInfo = userInfo
return profileInfo;
}
profileInfo = userInfo.profiles[user_id]
if (profileInfo) {
profileInfo.last_online_time = userInfo.last_online_time
profileInfo.userInfo = userInfo
return profileInfo;
}
profileInfo = userInfo.profiles[0]
if (profileInfo) {
profileInfo.last_online_time = userInfo.last_online_time
profileInfo.userInfo = userInfo
return profileInfo;
}
return this.opt.deleted_user
} catch (e) {
return this.opt.deleted_user
}
}
/**
*/
roomChat.getAllUserInfo = function () {
return this.allUsersInfo
}
/**
*/
roomChat.isHasUserInfo = function (user_id) {
if (this.allUsersInfo[user_id]) {
return true;
}
return false
}
roomChat.queryArray = []
/**
*/
roomChat.getUsersInfoByIdsFromServer = function (idsArray, callBack, params) {
if (callBack === undefined) {
callBack = function () { }
}
var resUserInfo = []
for (var i in idsArray) {
if (!this.allUsersInfo[idsArray[i]]) {
break;
}
resUserInfo.push(this.allUsersInfo[idsArray[i]])
}
if (resUserInfo.length === idsArray.length) {
if (callBack) callBack(resUserInfo, params);
return;
}
this.queryArray.push({
idsArray: idsArray,
callBack: callBack,
params: params
})
if (this.timerId) {
clearTimeout(this.timerId)
}
this.timerId = setTimeout(function () {
var userData = []
for (var j in this.queryArray) {
for (var i in this.queryArray[j].idsArray) {
var val = this.queryArray[j].idsArray[i];
var info = this.allUsersInfo[val]
if (info || jQuery.inArray(val, userData) !== -1) {
continue;
}
userData.push(val);
}
}
var lastQuery = this.queryArray.slice();
this.queryArray = []
if (userData.length === 0) {
for (var i in lastQuery) {
if (!lastQuery[i].callBack) {
continue;
}
var resUserInfo = []
for (var j in lastQuery[i].idsArray) {
resUserInfo.push(this.allUsersInfo[lastQuery[i].idsArray[j]])
}
lastQuery[i].callBack(resUserInfo, lastQuery[i].params);
}
return;
}
var thisObj = this;
thisObj.apiCall({
reTryInOnline: true,
type: "POST",
dataType: 'json',
url: this.opt.api_host,
data: {
cultivate: 'roomVideoChat.' + this.opt.URL_getUserInfo,
ids: userData.join(","),
user_id: this.opt.user_id,
user_key: this.opt.user_key,
},
success: function (res) {
if (thisObj.ajaxErrorTest(res)) {
return;
}
for (var i in res) {
thisObj.allUsersInfo[res[i].user_id] = res[i]
}
for (var i in lastQuery) {
if (!lastQuery[i].callBack) {
continue;
}
var resUserInfo = []
for (var j in lastQuery[i].idsArray) {
resUserInfo.push(thisObj.allUsersInfo[lastQuery[i].idsArray[j]])
}
lastQuery[i].callBack(resUserInfo, lastQuery[i].params);
}
}
});
}, 200)
}
/**
* /
roomChat.toggleFavoritUser = function(roomId)
{
var thisObj = this;
var room = thisObj.getRoomInfoById(roomId)
if(!room || room.relation != thisObj.relation.favorite)
{
room.relation = thisObj.relation.favorite;
$(".favoritRoom-"+roomId).addClass('favorit')
}
else
{
room.relation = thisObj.relation.base;
$(".favoritRoom-"+roomId).removeClass('favorit')
}
thisObj.apiCall({
reTryInOnline:true,
type: "POST",
dataType:'json',
url: thisObj.opt.api_host,
data:{
cultivate:'roomVideoChat.toggleFavoritRoom',
room_id:roomId,
relation:room.relation,
user_id:thisObj.opt.user_id,
user_key:thisObj.opt.user_key,
},
success: function(data)
{
}
});
return room.relation != thisObj.relation.base
}
/**
*/
roomChat.isIgnored = function (user_id) {
if (this.opt.ignored[user_id]) {
return true;
}
return false;
}
/**
*/
roomChat.updateIgnored = function (ignored, needSave = true) {
this.opt.ignored = {}
for (var i in ignored) {
this.opt.ignored[i] = ignored[i]
}
if (needSave) {
this.chatDB.saveData('ignored', this.opt.ignored)
}
}
/**
*/
roomChat.addMessageToHistory = function (messageInfo, isAnimate, usePrepend, roomInfo = undefined) {
if (!roomInfo) {
roomInfo = this.getOpendRoomInfo()
}
if (messageInfo.id != 0 && jQuery("." + this.class_name + "-message-id-" + messageInfo.id).length != 0) {
return;
}
if (messageInfo.uuid && jQuery(".message-uuid-" + messageInfo.uuid).length != 0) {
return;
}
if (messageInfo.uuid == null || !messageInfo.uuid) {
window.imbaLog.log(messageInfo);
return
}
var html = "";
var last_message_time_string = 0;
if (!usePrepend) {
last_message_time_string = jQuery(".roomVideoChat-messages-list .roomVideoChat-role-message:last").attr('data-messageTime')
}
else {
last_message_time_string = jQuery(".roomVideoChat-messages-list .roomVideoChat-role-message:first").attr('data-messageTime')
}
var message_history_date_delimiter = "";
if (last_message_time_string && messageInfo.time) {
var last_message_time = dayjs.unix(last_message_time_string);
var new_message_time = dayjs.unix(messageInfo.time);
if (last_message_time.format("DD") != new_message_time.format("DD")) {
var set_time = messageInfo.time
if (!usePrepend) {
set_time = messageInfo.time
}
else {
set_time = last_message_time_string
}
message_history_date_delimiter = this.just.renderSync('message_history_date_delimiter', {
chatObj: this,
messageInfo: messageInfo,
roomInfo: roomInfo,
new_time: messageInfo.time,
last_time: last_message_time_string,
time: set_time
})
}
}
if (!usePrepend) {
html += message_history_date_delimiter
}
html += this.just.renderSync('message_history', { chatObj: this, messageInfo: messageInfo, roomInfo: roomInfo })
if (usePrepend) {
html += message_history_date_delimiter
}
if (usePrepend) {
jQuery("." + this.class_name + "-messages-list").prependTpl(html)
}
else {
jQuery("." + this.class_name + "-messages-list").appendTpl(html)
if (isAnimate) {
jQuery("." + this.class_name + "-messages-list").stop().animate({ scrollTop: 999999999 });
}
else {
jQuery("." + this.class_name + "-message-id-" + messageInfo.id).show()
}
}
this.scrollBottom();
}
/**
*/
roomChat.clearMessagesHistory = function () {
jQuery("." + this.class_name + "-messages-list").insertTpl("")
}
/**
*/
roomChat.getOponentForRoom = function (roomId) {
var room = this.getRoomInfoById(roomId)
if (!room) {
return this.opt.deleted_user
}
if (room.users == undefined) {
window.imbaLog.info("Мы в комнате одни ", roomId, this.opt.user_id)
return this.opt.deleted_user
}
if (room.users.length == 1) {
return this.getUserInfoById(room.users[0], roomId);
}
for (var i in room.users) {
if (room.users[i] != this.opt.user_id) {
return this.getUserInfoById(room.users[i], roomId)
}
}
if (room.admin_id) {
return this.getUserInfoById(room.admin_id, roomId);
}
return this.opt.deleted_user
}
/**
*/
roomChat.setUnblockRoom = function (room_id) {
var thisObj = this;
thisObj.apiCall({
reTryInOnline: true,
type: "POST",
url: thisObj.opt.api_host + "room/unblock/" + room_id,
data: {
user_id: thisObj.opt.user_id,
room_id: room_id,
user_key: thisObj.opt.user_key,
},
success: function (res) {
$.when(thisObj.updateContactList()).done(() => {
thisObj.closeRoom();
thisObj.openRoom(room_id);
});
}
});
}
/**
*/
roomChat.setBlockRoom = function (room_id) {
var thisObj = this;
var roomId = room_id;
thisObj.apiCall({
reTryInOnline: true,
type: "POST",
url: thisObj.opt.api_host + "room/block/" + room_id,
data: {
user_id: thisObj.opt.user_id,
room_id: room_id,
user_key: thisObj.opt.user_key,
},
success: function (res) {
$.when(thisObj.updateContactList()).done(() => {
thisObj.closeRoom();
thisObj.openRoom(room_id);
});
}
});
}
/**
*/
roomChat.closeRoom = function () {
let result = tabSignal.filter("imbaChat.closeRoom", { chatObj: this})
if (result !== undefined) {
return result;
}
this.spajs.open({ menuId: "start-page" })
}
/**
*/
roomChat.getOpendRoomInfo = function () {
return this.opened_room
}
/**
*/
roomChat.onCloseRoom = function () {
this.opened_room = false;
jQuery(".contact-list .role-dialog-item").removeClass("role-active-dialog-item")
jQuery(".roomvideochat").addClass("room-not-opend").removeClass("room-is-opend")
}
/**
*/
roomChat.getRoomInfoById = function (roomId) {
if (roomId == "favorite") {
return false;
}
if (!roomId) {
return this.opt.rooms[0]
}
for (var i in this.opt.rooms) {
if (this.opt.rooms[i] && this.opt.rooms[i].room_id == roomId) {
return this.opt.rooms[i];
}
}
return false
}
/**
roomInfo.filters = [
{ id: "rooms", class:"room", name: "Комнат"},
{ id: "area", class:"area", name: "Площадь, м2"},
{ id: "floor", class:"floor", name: "Этаж / Этажей"},
{ id: "ticket_price", class:"price", name: "Стоимость, руб"},
{ id: "street", class:"street", name: "Улица"},
{ id: "house", class:"house", name: "Дом"},
]
*/
roomChat.prepareInputFormForRoom = function (roomInfo) {
var thisObj = this;
if (roomInfo) {
jQuery("#roomVideoChat-bottm-in-scroll").insertTpl(thisObj.just.renderSync('bottm_in_scroll', { chatObj: thisObj, roomInfo: roomInfo, oponentUser: thisObj.getOponentForRoom(thisObj.opened_room.room_id) }))
jQuery("#roomVideoChat-reply-form").insertTpl(thisObj.just.renderSync('reply_form', { chatObj: thisObj, roomInfo: roomInfo, oponentUser: thisObj.getOponentForRoom(thisObj.opened_room.room_id) }))
jQuery("#spajs-right-area").removeClass("history-favorite");
jQuery("#roomVideoChat-history-messages-bottom").insertTpl(thisObj.just.renderSync('messages_list_bottom', { chatObj: thisObj, roomInfo: roomInfo, oponentUser: thisObj.getOponentForRoom(thisObj.opened_room.room_id) }))
if (thisObj.opt.useEmojioneArea) {
jQuery("#roomVideoChat-input-message").emojioneArea({
container: "#roomVideoChat-input-emojionearea",
hideSource: true,
autoHideFilters: true,
useSprite: true,
saveEmojisAs: 'shortname',
events: {
keypress: function (editor, event) {
thisObj.onKeypressMessage()
},
keyup: function (editor, event) {
thisObj.onKeypressMessage()
},
change: function (editor, event) {
thisObj.onKeypressMessage()
},
keydown: function (editor, event) {
thisObj.keydownSendMessage(event)
},
}
});
thisObj.emojioneArea = jQuery("#roomVideoChat-input-message").emojioneArea()
$('div[name=smileys_people]').children('i:not(:lt(68))').hide()
$('div[name=symbols]').children('i:not(:lt(12))').hide()
$('div[name=travel_places]').children('i:not(:lt(56))').hide()
$('div[name=animals_nature]').children('i:not(:lt(70))').hide()
$('i[title=Flags]').hide()
$('div[name=flags]').hide()
$('i[title=Objects]').hide()
$('div[name=objects]').hide()
$('.emojionearea-tones').hide();
}
else {
jQuery("#roomVideoChat-input-message").on('keypress', (event) => { thisObj.onKeypressMessage(event) })
jQuery("#roomVideoChat-input-message").on('keyup', (event) => { thisObj.onKeypressMessage(event) })
jQuery("#roomVideoChat-input-message").on('change', (event) => { thisObj.onKeypressMessage(event) })
jQuery("#roomVideoChat-input-message").on('keydown', (event) => { thisObj.onKeypressMessage(event) })
}
}
else {
jQuery("#spajs-right-area").addClass("history-favorite");
}
}
/**
*/
roomChat.prepareHeaderForRoom = function (roomInfo, roomId) {
var html = this.just.renderSync("head", { chatObj: this, room: roomInfo, roomId: roomId });
jQuery("#" + this.class_name + "-header").insertTpl(html);
}
roomChat.showTab = function (tab_id) {
var thisObj = this;
if (!tab_id || tab_id <= 0) {
tab_id = this.tab.DEFAULT
}
this.activeTab = tab_id;
window.localStorage['last_activeTab'] = tab_id;
jQuery(".roomVideoChat-contact-list,.role-dialogs-tabs").removeClass('show-tab-' + this.tab.DEFAULT)
jQuery(".roomVideoChat-contact-list,.role-dialogs-tabs").removeClass('show-tab-' + this.tab.SALE)
jQuery(".roomVideoChat-contact-list,.role-dialogs-tabs").removeClass('show-tab-' + this.tab.DATING)
jQuery(".roomVideoChat-contact-list,.role-dialogs-tabs").addClass('show-tab-' + tab_id)
jQuery("#role-dialogs-tabs a").removeClass('active')
jQuery("#role-dialogs-tabs .role-dialogs-tab-" + tab_id).addClass('active')
}
/**
*/
roomChat.addToRoom = function(opt)
{
var thisObj = this;
if(opt.pipe)
{
opt.room_id = 0;
}
const data = opt
data.cultivate = 'roomVideoChat.'+thisObj.opt.URL_addToRoom
data.user_id = thisObj.opt.user_id
data.user_key = thisObj.opt.user_key
data.users_ids = JSON.stringify(opt.users_ids)
thisObj.apiCall({
useCache:false,
type: "POST",
dataType:'json',
url: thisObj.opt.api_host,
data:data,
success: function(data)
{
if(thisObj.ajaxErrorTest(data))
{
return;
}
$.when(thisObj.updateContactList()).done(() => {
if (data.roomId) {
$.when(thisObj.openRoom(data.roomId)).done(function () {
resolve(data.roomId);
}).fail(function () {
reject(data.roomId);
})
}
});
}
});
}
/**
* Создание комнаты/конференции/диалога
*/
roomChat.newRoom = function (opt) {
return new Promise((resolve, reject) => {
var thisObj = this;
thisObj.apiCall({
useCache: true,
addToQueue: false,
ignore: false,
type: "POST",
dataType: 'json',
url: thisObj.opt.api_host,
data: {
cultivate: 'roomVideoChat.' + thisObj.opt.URL_newRoom,
user_id: thisObj.opt.user_id,
user_key: thisObj.opt.user_key,
title: opt.title,
users_ids: JSON.stringify(opt.users_ids),
room_type: opt.room_type
},
success: function (data) {
if (thisObj.ajaxErrorTest(data)) {
reject(data);
return;
}
$.when(thisObj.updateContactList()).done(() => {
if (data.roomId) {
$.when(thisObj.openRoom(data.roomId)).done(function () {
resolve(data.roomId);
}).fail(function () {
reject(data.roomId);
})
}
});
},
error: function (data) {
reject(data);
}
});
});
}
/**
*/
roomChat.openDialog = function (user_id, tab_id) {
if (user_id == this.opt.user_id) {
this.showDilogList()
return;
}
if (!user_id) {
this.showDilogList()
return;
}
this.showTab(tab_id);
for (var i in this.opt.rooms) {
if (this.opt.rooms[i].room_type / 1 === this.room_type.dialog && this.opt.rooms[i].room_id != 0
&& (this.opt.rooms[i].users[0] == user_id || this.opt.rooms[i].users[1] == user_id)
&& this.opt.rooms[i].tab == tab_id) {
return this.openRoom(this.opt.rooms[i].room_id);
}
}
return this.newRoom({user_ids: [user_id], title: "", tab_id: tab_id})
}
/**
*/
roomChat.openFavoriteMessges = function () {
this.spajs.open({ menuId: 'roomVideoChat', addUrlParams: { roomId: 'favorite', q: undefined, targetId: undefined } });
}
/**
* Открывает диалог/конференцию/комнату по roomId со сменой урла через spajs
*/
roomChat.openRoom = function (roomId, callback, force) {
tabSignal.emit("sidebar.set.hidden")
if (this.getOponentForRoom(roomId).user_id == imbaChat.opt.deleted_user.user_id) {
}
if (this.opened_room && roomId == this.opened_room.room_id && !force) {
return new Promise((resolve, reject) => {
if (callback) {
callback()
}
resolve();
});
}
return this.spajs.open({
menuId: 'roomVideoChat-room-' + roomId,
callback: callback,
})
}
roomChat.openDeletedUser = function (roomId) {
return new Promise((resolve, reject) => {
thisObj = this;
iziToast.show({
theme: 'dark',
icon: 'icon-person',
title: gettext('imbachat', 'user_removed'),
message: gettext('imbachat', 'user_delete_dialog_confirm'),
position: 'center',
timeout: false,
buttons: [
['<button>' + gettext('imbachat', 'yes') + '</button>', function (instance, toast) {
thisObj.deleteDialog(roomId);
iziToast.hide({ transitionOut: 'fadeOutUp' }, toast);
resolve();
}], // true to focus
['<button>' + gettext('imbachat', 'cancel') + '</button>', function (instance, toast) {
iziToast.hide({ transitionOut: 'fadeOutUp' }, toast);
reject();
}], // true to focus
],
onOpening: function (instance, toast) {
window.imbaLog.info('Delete?');
},
onClosing: function (instance, toast, closedBy) {
window.imbaLog.info('closedBy: ' + closedBy);
}
});
});
};
roomChat.rejectUserRequest = function (room_id, interlocutor_id) {
var thisObj = this;
var roomId = room_id;
thisObj.apiCall({
reTryInOnline: true,
type: "POST",
url: thisObj.opt.api_host + "room/" + room_id + "/reject/" + interlocutor_id,
data: {
user_id: thisObj.opt.user_id,
room_id: room_id,
interlocutor_id: interlocutor_id,
},
success: function (res) {
$.when(thisObj.updateContactList()).done(() => {
thisObj.closeRoom();
thisObj.openRoom(room_id);
});
},
error: function (res) {
$.when(thisObj.updateContactList()).done(() => {
thisObj.closeRoom();
thisObj.openRoom(room_id);
});
}
});
}
roomChat.acceptUserRequest = function (room_id, interlocutor_id) {
var thisObj = this;
var roomId = room_id;
thisObj.apiCall({
reTryInOnline: true,
type: "POST",
url: thisObj.opt.api_host + "room/" + room_id + "/accept/" + interlocutor_id,
data: {
user_id: thisObj.opt.user_id,
room_id: room_id,
interlocutor_id: interlocutor_id,
},
success: function (res) {
$.when(thisObj.updateContactList()).done(() => {
thisObj.closeRoom();
thisObj.openRoom(room_id);
});
},
error: function (res) {
$.when(thisObj.updateContactList()).done(() => {
thisObj.closeRoom();
thisObj.openRoom(room_id);
});
}
});
}
/**
* Открывает диалог/конференцию/комнату по roomId
*/
roomChat.showRoom = function (roomId) {
var thisObj = this;
let roomInfo = thisObj.getRoomInfoById(roomId)
if (!roomInfo) {
return this.closeRoom()
}
thisObj.opened_room = roomInfo
if (roomInfo.relation == roomChat.relation.blocked) {
var html = thisObj.just.renderSync('chat_right_column_blocked', { chatObj: thisObj })
jQuery(".roomVideoChat-right-area").insertTpl(html)
jQuery(".roomVideoChat-contact-list .role-dialog-item").removeClass("role-active-dialog-item")
jQuery("#roomVideoChat-user-dialog-" + roomId).addClass("role-active-dialog-item")
jQuery(".roomvideochat").removeClass("room-not-opend").addClass("room-is-opend")
thisObj.prepareHeaderForRoom(thisObj.opened_room, roomId)
return;
}
if ((roomInfo.status == roomChat.status.default || roomInfo.status == roomChat.status.waiting) && thisObj.opt.enable_status_field) {
if (roomInfo.admin_id != thisObj.opt.user_id) {
var html = thisObj.just.renderSync('chat_right_column_incoming_request', { chatObj: thisObj, roomInfo: roomInfo })
jQuery(".roomVideoChat-right-area").insertTpl(html)
jQuery(".roomVideoChat-contact-list .role-dialog-item").removeClass("role-active-dialog-item")
jQuery("#roomVideoChat-user-dialog-" + roomId).addClass("role-active-dialog-item")
jQuery(".roomvideochat").removeClass("room-not-opend").addClass("room-is-opend")
thisObj.prepareHeaderForRoom(thisObj.opened_room, roomId)
return;
}
else if (roomInfo.status != roomChat.status.default) {
var html = thisObj.just.renderSync('chat_right_column_outgoing_request', { chatObj: thisObj, roomInfo: roomInfo })
jQuery(".roomVideoChat-right-area").insertTpl(html)
jQuery(".roomVideoChat-contact-list .role-dialog-item").removeClass("role-active-dialog-item")
jQuery("#roomVideoChat-user-dialog-" + roomId).addClass("role-active-dialog-item")
jQuery(".roomvideochat").removeClass("room-not-opend").addClass("room-is-opend")
thisObj.prepareHeaderForRoom(thisObj.opened_room, roomId)
return;
}
}
if (roomInfo.status == roomChat.status.rejected && thisObj.opt.enable_status_field) {
if (roomInfo.admin_id == thisObj.opt.user_id) {
var html = thisObj.just.renderSync('chat_right_column_incoming_reject', { chatObj: thisObj, roomInfo: roomInfo })
jQuery(".roomVideoChat-right-area").insertTpl(html)
jQuery(".roomVideoChat-contact-list .role-dialog-item").removeClass("role-active-dialog-item")
jQuery("#roomVideoChat-user-dialog-" + roomId).addClass("role-active-dialog-item")
jQuery(".roomvideochat").removeClass("room-not-opend").addClass("room-is-opend")
thisObj.prepareHeaderForRoom(thisObj.opened_room, roomId)
return;
}
else {
var html = thisObj.just.renderSync('chat_right_column_outgoing_reject', { chatObj: thisObj, roomInfo: roomInfo })
jQuery(".roomVideoChat-right-area").insertTpl(html)
jQuery(".roomVideoChat-contact-list .role-dialog-item").removeClass("role-active-dialog-item")
jQuery("#roomVideoChat-user-dialog-" + roomId).addClass("role-active-dialog-item")
jQuery(".roomvideochat").removeClass("room-not-opend").addClass("room-is-opend")
thisObj.prepareHeaderForRoom(thisObj.opened_room, roomId)
return;
}
}
thisObj.inSearchMode = false;
thisObj.inSearchResultsMode = false;
this.searchQuery = { page: 0, targetVector: 0 };
jQuery(".roomVideoChat-loadDownPageBtn").hide()
var html = thisObj.just.renderSync('chat_right_column', { chatObj: thisObj, roomInfo: roomInfo })
jQuery(".roomVideoChat-right-area").insertTpl(html)
jQuery(".roomVideoChat-contact-list .role-dialog-item").removeClass("role-active-dialog-item")
jQuery("#roomVideoChat-user-dialog-" + roomId).addClass("role-active-dialog-item")
jQuery(".roomvideochat").removeClass("room-not-opend").addClass("room-is-opend")
thisObj.prepareHeaderForRoom(thisObj.opened_room, roomId)
thisObj.prepareInputFormForRoom(thisObj.opened_room)
thisObj.clearMessageCounter(thisObj.opened_room)
thisObj.showTab(thisObj.opened_room.tab);
thisObj.clearMessagesHistory()
jQuery(".roomVideoChat-messages-list").insertTpl(thisObj.just.renderSync('message_history_preloader', { chatObj: this }))
thisObj.isLoadAllLastMessages = false;
if (thisObj.isIgnored(thisObj.getOponentForRoom(thisObj.opened_room.room_id).user_id)) {
return;
}
thisObj.inLoadMessages = false;
thisObj.loadMessages(
{
query: thisObj.searchQuery,
onAjaxError: function () {
if (!thisObj.isOnline()) {
$('.roomVideoChat-message-history-preloader').remove()
jQuery(".roomVideoChat-messages-list").insertTpl(thisObj.just.renderSync('message_history_on_offline', { chatObj: this }))
}
},
callbackAfterInsert: function (res) {
$('.roomVideoChat-message-history-preloader').remove()
thisObj.scrollBottom()
var content = jQuery(".roomVideoChat-messages-list")
content.scroll(function () {
if (content.scrollTop() < 150) {
if (thisObj.inLoadMessages) {
return;
}
if (thisObj.isLoadAllLastMessages) {
return;
}
thisObj.lastContentScrollHeight = jQuery(".roomVideoChat-messages-list").prop('scrollHeight') - content.scrollTop() + 100;
thisObj.inLoadMessages = true;
thisObj.searchQuery.page++;
thisObj.searchQuery.targetVector = 0;
thisObj.loadMessages({
query: thisObj.searchQuery, callbackAfterInsert: function (loadResults) {
if (loadResults.length == 0) {
thisObj.isLoadAllLastMessages = true;
}
thisObj.inLoadMessages = false;
content.scrollTop(jQuery(".roomVideoChat-messages-list").prop('scrollHeight') - thisObj.lastContentScrollHeight)
}
})
}
});
}
})
thisObj.markAsRead(roomInfo.last_message);
$('.roomVideoChat-message-history-preloader').remove()
thisObj.scrollBottom();
return;
}
/**
*/
roomChat.scrollBottom = function () {
jQuery("." + this.class_name + "-messages-list").scrollTop(9999999);
jQuery("#" + this.class_name + "-messages-history").scrollTop(9999999);
}
/**
*/
roomChat.scrollToTarget = function (message_id) {
var msgArr = jQuery("." + this.class_name + "-role-message");
var scrollSum = 0;
for (var i = 0; i < msgArr.length; i++) {
if (jQuery(msgArr[i]).attr("data-messageId") == message_id) {
break;
}
scrollSum += jQuery(msgArr[i]).outerHeight()
}
jQuery("." + this.class_name + "-messages-list").scrollTop(scrollSum);
}
/**
*/
roomChat.onDeleteDialog = function (room_id) {
jQuery("#" + this.class_name + "-user-dialog-" + room_id).hide();
this.getRoomInfoById()
for (var i in this.opt.rooms) {
if (this.opt.rooms[i] && this.opt.rooms[i].room_id == room_id) {
delete this.opt.rooms[i];
this.updateRoomsInfo(this.opt.rooms, true)
break;
}
}
if (this.opened_room && this.opened_room.room_id == room_id) {
this.showDilogList();
this.closeRoom();
};
}
/**
*/
roomChat.confirmDeleteDialog = function (room_id, room_id_name) {
let thisObj = this;
if ($('.iziToast-body').length > 0) {
return false
} else {
iziToast.show({
theme: 'dark',
icon: 'icon-person',
title: gettext('imbachat', 'user_delete_dialog_confirm') + ' ' + room_id_name + '?',
message: false,
position: 'center',
timeout: false,
buttons: [
['<button>' + gettext('imbachat', 'yes') + '</button>', function (instance, toast) {
thisObj.deleteDialog(room_id);
iziToast.hide({ transitionOut: 'fadeOutUp' }, toast);
}], // true to focus
['<button>' + gettext('imbachat', 'cancel') + '</button>', function (instance, toast) {
iziToast.hide({ transitionOut: 'fadeOutUp' }, toast);
}], // true to focus
],
onOpening: function (instance, toast) {
window.imbaLog.info('Delete?');
},
onClosing: function (instance, toast, closedBy) {
window.imbaLog.info('closedBy: ' + closedBy);
}
});
}
}
/**
*/
roomChat.deleteDialog = function (room_id) {
this.onDeleteDialog(room_id)
this.apiCall({
reTryInOnline: true,
type: "POST",
dataType: 'json',
queue_key: "deleteDialog_" + room_id,
url: this.opt.api_host,
data: {
cultivate: 'roomVideoChat.' + this.opt.URL_deleteDialog,
room_id: room_id,
user_id: this.opt.user_id,
user_key: this.opt.user_key,
},
success: (res) => {
}
});
}
/**
*/
roomChat.current_loadMessages = undefined;
/**
*/
roomChat.localRoomsDB = {}
roomChat.getLocalRoomHistory = function (room_id) {
if (this.localRoomsDB[room_id]) {
return this.localRoomsDB[room_id];
}
this.localRoomsDB[room_id] = new window.ImbaRoomDB(room_id);
return this.localRoomsDB[room_id];
}
/**
*/
roomChat.loadMessagesFromServer = function (room_id) {
var thisObj = this;
return new Promise((resolve, reject) => {
thisObj.getLocalRoomHistory(room_id).getLastestMessage().then((message) => {
let min_id = 0;
if (message !== undefined) {
min_id = message.id
}
this.apiCall({
useCache: true,
type: "POST",
dataType: 'json',
ignore: true,
url: thisObj.opt.api_host,
data: {
cultivate: 'roomVideoChat.' + thisObj.opt.URL_getMessages,
user_id: thisObj.opt.user_id,
user_key: thisObj.opt.user_key,
room_id: room_id,
query: {
max_id: min_id
}
},
success: function (res) {
thisObj.addUsersInfo(res.users)
var countMsg = 0;
for (var i in res.messages) {
countMsg += 1;
if (!res.messages[i].uuid) {
res.messages[i].uuid = res.messages[i].id;
}
thisObj.getLocalRoomHistory(room_id).addMessage({
data: res.messages[i],
uuid: res.messages[i].uuid,
id: res.messages[i].id,
time: res.messages[i].time
});
}
resolve(res)
},
error: function (err) {
reject(err)
}
});
})
})
}
roomChat.loadMessages = function (opt) {
var thisObj = this;
var room_id = opt.room_id;
if (!room_id && thisObj.opened_room) {
room_id = thisObj.opened_room.room_id
}
if (thisObj.current_loadMessages
&& thisObj.current_loadMessages.xhr
&& thisObj.current_loadMessages.room_id != room_id) {
thisObj.current_loadMessages.xhr.abort();
}
thisObj.current_loadMessages = { room_id: room_id }
let roomInfo = thisObj.getRoomInfoById(room_id)
const limit = 30;
const offset = limit * opt.query.page;
thisObj.getLocalRoomHistory(room_id).getMessagesHistory(limit, offset)
.then((messages) => {
if (messages.length == 0) {
thisObj.loadMessagesFromServer(room_id)
.then((res) => {
if (thisObj.current_loadMessages && thisObj.current_loadMessages.room_id != room_id) {
return;
} else if (res.messages.length == 0) {
thisObj.isLoadAllLastMessages = true;
if (opt.callbackAfterInsert) {
opt.callbackAfterInsert(res.messages)
}
return;
}
thisObj.insertMessages(res.messages, roomInfo, opt)
})
.catch(err => {
if (opt.callbackAfterInsert) {
opt.callbackAfterInsert(err)
}
})
} else {
messages.sort((a, b) => {
return a.time * 1 - b.time * 1
})
if (thisObj.current_loadMessages && thisObj.current_loadMessages.room_id != room_id) {
return;
}
thisObj.insertMessages(messages, roomInfo, opt)
thisObj.updateMessages(opt);
}
})
.catch(() => {
thisObj.loadMessagesFromServer(room_id)
.then((res) => {
if (thisObj.current_loadMessages && thisObj.current_loadMessages.room_id != room_id) {
return;
} else if (res.messages.length == 0) {
thisObj.isLoadAllLastMessages = true;
if (opt.callbackAfterInsert) {
opt.callbackAfterInsert(res.messages)
}
return;
}
thisObj.insertMessages(res.messages, roomInfo, opt)
})
.catch((err) => {
if (opt.callbackAfterInsert) {
opt.callbackAfterInsert(err)
}
});
})
};
roomChat.updateMessages = function (opt) {
var thisObj = this;
var room_id = opt.room_id;
if (!room_id && thisObj.opened_room) {
room_id = thisObj.opened_room.room_id
}
if (thisObj.current_loadMessages
&& thisObj.current_loadMessages.xhr
&& thisObj.current_loadMessages.room_id != room_id) {
thisObj.current_loadMessages.xhr.abort();
}
thisObj.current_loadMessages = { room_id: room_id }
let roomInfo = thisObj.getRoomInfoById(room_id)
jQuery(".roomVideoChat-loadNexPageBtn").show()
thisObj.current_loadMessages.xhr = this.apiCall({
useCache: true,
type: "POST",
dataType: 'json',
url: thisObj.opt.api_host,
data: {
cultivate: 'roomVideoChat.' + thisObj.opt.URL_getMessages,
user_id: thisObj.opt.user_id,
user_key: thisObj.opt.user_key,
room_id: room_id,
query: opt.query
},
success: function (res) {
thisObj.addUsersInfo(res.users)
if (thisObj.current_loadMessages && thisObj.current_loadMessages.room_id != room_id) {
return;
}
var countMsg = 0;
var tmp = []
for (var i in res.messages) {
countMsg += 1;
tmp.unshift(res.messages[i])
}
tmp.sort((a, b) => {
return a.time * 1 - b.time * 1
})
for (var i in tmp) {
countMsg += 1;
if ($('.message-uuid-' + tmp[i].uuid).length > 0) {
thisObj.updateMessage(tmp[i], room_id)
} else {
thisObj.addMessageToHistory(tmp[i], false, thisObj.searchQuery.targetVector, roomInfo)
thisObj.getLocalRoomHistory(room_id).addMessage({
data: tmp[i],
uuid: tmp[i].uuid,
id: tmp[i].id,
time: tmp[i].time
});
}
}
var $wrapper = $('.roomVideoChat-messages-list');
$wrapper.find('div[data-messagetime]').sort(function (a, b) {
return +a.getAttribute('data-messagetime') - +b.getAttribute('data-messagetime');
})
.appendTo($wrapper);
res.length = countMsg;
}
});
}
roomChat.updateMessage = function (message, room_id) {
var thisObj = this;
$(".message-uuid-" + message.uuid)
.removeClass("message-not-sended")
.addClass("message-sended")
.addClass("message-id-" + message.id)
thisObj.getLocalRoomHistory(room_id).addMessage({
data: message,
uuid: message.uuid,
id: message.id,
time: message.time
});
}
roomChat.insertMessages = function (list, roomInfo, opt) {
var thisObj = this;
if (opt.callbackBeforeInsert) {
opt.callbackBeforeInsert(list)
}
if (thisObj.searchQuery.targetVector == 0) {
var countMsg = 0;
var tmp = []
for (var i in list) {
countMsg += 1;
tmp.unshift(list[i])
}
for (var i in tmp) {
countMsg += 1;
thisObj.addMessageToHistory(tmp[i], false, !thisObj.searchQuery.targetVector, roomInfo)
}
} else {
var countMsg = 0;
for (var i in list) {
countMsg += 1;
thisObj.addMessageToHistory(list[i], false, !thisObj.searchQuery.targetVector, roomInfo)
}
}
list.length = countMsg;
if (opt.callbackAfterInsert) {
opt.callbackAfterInsert(list)
}
}
roomChat.showSearchForm = function () {
jQuery("#" + this.class_name + "-search-by-history-holder").show();
jQuery("#" + this.class_name + "-room-info-holder").hide();
}
roomChat.showRoomInfoForm = function () {
if (!this.inSearchMode) {
jQuery("#" + this.class_name + "-search-by-history-holder").hide();
jQuery("#" + this.class_name + "-room-info-holder").show();
}
else if (this.opened_room && this.opened_room.room_id) {
this.openRoom(this.opened_room.room_id, undefined, true)
}
}
roomChat.getAvatarHTML = function (roomInfo) {
let result = tabSignal.filter("imbaChat.getAvatarHTML", { chatObj: this, roomInfo: roomInfo })
if (result !== undefined) {
return result;
}
return this.just.renderSync('avatar', { chatObj: this, roomInfo: roomInfo })
}
roomChat.getFileIcon = function (file) {
if (file.fileType.split('/')[0] == "text") {
return 'https://www.svgrepo.com/show/236/file.svg'
} else if (file.fileType.split('/')[0] == "audio") {
return 'https://www.svgrepo.com/show/256776/audio-mp3.svg'
} else if (file.fileType.split('/')[0] == "video") {
return 'https://www.svgrepo.com/show/42093/video-clip.svg'
} else {
return 'https://www.svgrepo.com/show/3511/file.svg'
}
}
roomChat.getRoomTitle = function (roomInfo) {
return gettext("imbachat", tabSignal.filter("imbaChat.getRoomTitle", { chatObj: this, roomInfo: roomInfo }) || " ")
}
roomChat.getRoomName = function (roomInfo) {
let name = tabSignal.filter("imbaChat.getRoomName", { chatObj: this, roomInfo: roomInfo })
if (name !== undefined) {
return gettext("imbachat", name);
}
if (roomInfo.room_type == this.room_type.dialog) {
return gettext("imbachat", this.getOponentForRoom(roomInfo.room_id).name)
}
else {
return gettext("imbachat", roomInfo.name)
}
}
/**
*/
roomChat.getIntegerToTimeString = function (unixTime) {
if (!window.dayjs) {
return unixTime
}
var m = dayjs().startOf('year')
m = m.add(dayjs.unix(unixTime));
return m.format("HH:mm:ss")
}
/**
*/
roomChat.getTimeString = function (unixTime, typeValue = 'x') {
if (unixTime == 0) {
return ""
}
if (!unixTime) {
return gettext("imbachat", "No_data")
}
if (!window.dayjs) {
return unixTime
}
var m = dayjs.unix(unixTime);
if (m.isAfter(dayjs().startOf('day'))) {
return m.format("HH:mm")
}
else if (m.isAfter(dayjs().subtract(1, 'day').startOf('day'))) {
return gettext("imbachat", "yesterday")
}
else if (m.isAfter(dayjs().startOf('month'))) {
return m.format("DD") + " " + gettext("imbachat", this.monthArr[m.format("M") - 1])
}
return m.format("DD") + " " + gettext("imbachat", this.monthArr[m.format("M") - 1]) + " " + m.format("YYYY")
}
/**
*/
roomChat.getTimeStringForHistory = function (unixTime, typeValue = 'x') {
if (unixTime == 0) {
return ""
}
if (!unixTime) {
return gettext("imbachat", "No_data")
}
if (!window.dayjs) {
return unixTime
}
var m = dayjs.unix(unixTime);
if (m.isAfter(dayjs().startOf('day'))) {
return gettext("imbachat", "today")
}
else if (m.isAfter(dayjs().subtract(1, 'day').startOf('day'))) {
return gettext("imbachat", "yesterday")
}
else if (m.isAfter(dayjs().startOf('month'))) {
return m.format("DD") + " " + gettext("imbachat", this.monthArr[m.format("M") - 1])
}
return m.format("DD") + " " + gettext("imbachat", this.monthArr[m.format("M") - 1]) + " " + m.format("YYYY")
}
roomChat.getTimeStringForMessage = function (unixTime, typeValue = 'x') {
if (unixTime == 0) {
return ""
}
if (!unixTime) {
return ""
}
if (!window.dayjs) {
return unixTime
}
var m = dayjs.unix(unixTime);
return m.format("HH:mm")
}
/**
*/
roomChat.getLastOnlineTimeString = function (unixTime) {
if (unixTime < 0) {
return "";
}
if (!window.dayjs) {
return unixTime
}
var m = dayjs.unix(unixTime);
if (m.isAfter(dayjs().startOf('day'))) {
return gettext("imbachat", "was_today") + " " + m.format("HH:mm")
}
else if (m.isAfter(dayjs().subtract(1, 'day').startOf('day'))) {
return gettext("imbachat", "was_yesterday") + " " + m.format("HH:mm")
}
else if (m.isAfter(dayjs().startOf('month'))) {
return gettext("imbachat", "was_date", m.format("DD") + " " + gettext("imbachat", this.monthArr[m.format("M") - 1]), m.format("HH:mm"))
}
return m.format("DD") + " " + gettext("imbachat", this.monthArr[m.format("M") - 1]) + " " + m.format("YYYY")
}
/**
*/
roomChat.getReadTimeString = function (read_time) {
if (read_time && read_time > 0) {
return gettext("imbachat", "read") + ": " + this.getTimeString(read_time)
}
else {
return "";
}
}
/**
* Или <span id='roomVideoChat-countCall-XXXX' ></span> если инфы нет локально а потом в значение этого тега доставит нужные данные асинхронно как только они появятся
*/
roomChat.getUsersInfoByIdAsync = function (room_id, user_id, attr) {
if (!user_id) {
return "";
}
var thisObj = this;
this.getUsersInfoByIdAsyncCounter++;
var countCall = this.getUsersInfoByIdAsyncCounter;
if (!this.isHasUserInfo(user_id)) {
return "<span id='roomVideoChat-countCall-" + countCall + "' ></span><js= roomVideoChat.getUsersInfoByIdsFromServer([" + user_id + "], roomVideoChat.insertUsersInfo, {room_id:" + room_id + ", countCall:" + countCall + ", attr:'" + countCall + "'}) =js>";
}
else {
return this.getUserInfoById(user_id, room_id)[attr];
}
}
/**
*/
roomChat.insertUsersInfo = function (resUserInfo, params) {
var thisObj = this;
params.room_id;
jQuery("#roomVideoChat-countCall-" + params.countCall + "").insertTpl(resUserInfo[0][params.attr])
}
/**
*/
roomChat.getMessageHtml = function (messageInfo, roomInfo) {
messageInfo.message = gettext("imbachat", messageInfo.message)
var text = messageInfo.message.replace(/([-a-zA-Z0-9@:%_\+.~#?&//=]{2,256}\.[a-z]{2,4}\b(\/[-a-zA-Z0-9@:%_\+.~#?&//=]*)?)/mg, (x) => {
if (x.slice(0, 4) == 'http') {
if (x.split('/')[2] == window.location.href.split('/')[2]) {
return "[" + x + "](" + x + ")"
} else {
return "[" + (x) + "](" + x + ")"
}
} else {
if (x == window.location.href.split('/')[2]) {
return "[http://" + x + "](" + x + ")"
} else {
return "[http://" + x + "](" + x + ")"
}
}
}/*"[[link=$1=link]]"*/);
if (this.opt.useEmojioneArea) {
text = emojione.shortnameToImage(text)
text = emojione.unicodeToImage(text)
}
var photoListHtml = "";
let tpldata = {
chatObj: this,
meta: messageInfo.meta[0],
messageInfo: messageInfo,
roomInfo: roomInfo,
};
if (messageInfo.meta && messageInfo.meta.length != 0 && messageInfo.meta[0] && messageInfo.meta[0].type == "system") {
tpldata.event = messageInfo.meta[0].event;
if (messageInfo.meta[0].event == "removeFromRoom") {
return this.just.renderSync('message_meta_system_removeFromRoom', tpldata);
}
else if (messageInfo.meta[0].event == "addToRoom") {
return this.just.renderSync('message_meta_system_addToRoom', tpldata);
}
else if (messageInfo.meta[0].event == "newRoom") {
return this.just.renderSync('message_meta_system_newRoom', tpldata);
}
else if (messageInfo.meta[0].event == "makeRoomAdmin") {
return this.just.renderSync('message_meta_system_makeRoomAdmin', tpldata);
}
else if (messageInfo.meta[0].event == "saveRoomSettings") {
return this.just.renderSync('message_meta_system_saveRoomSettings', tpldata);
}
else if (messageInfo.meta[0].event == "call") {
return this.just.renderSync('msg_call_tpl', tpldata);
}
else if (messageInfo.meta[0].event == "lostCall") {
return this.just.renderSync('msg_call_tpl', tpldata);
}
else if (messageInfo.meta[0].event == "callHangup") {
return this.just.renderSync('msg_call_tpl', tpldata);
}
else if (messageInfo.meta[0].event == "callBusy") {
return this.just.renderSync('msg_call_tpl', tpldata);
}
else if (messageInfo.meta[0].event == "callOut") {
return this.just.renderSync('msg_call_tpl', tpldata);
}
else if (messageInfo.meta[0].event == "callMute") {
return this.just.renderSync('msg_call_tpl', tpldata);
}
else if (messageInfo.meta[0].event == "shareUser") { // Поделиться
return this.just.renderSync('message_meta_system_share', tpldata)
}
else {
var html = "";
try {
html = this.just.renderSync('message_meta_system_' + messageInfo.meta[0].event, tpldata)
} catch (e) {
html = messageInfo.message;
}
return html;
}
}
else if (messageInfo.meta) {
try {
var imgArray = messageInfo.meta;
if (imgArray) {
for (var i in imgArray) {
if (imgArray[i].type == "link" && imgArray[i].image_src) {
text = text.split("[[link=" + imgArray[i].url + "=link]]").join(this.just.renderSync('message_meta_link', { chatObj: this, meta: imgArray[i], messageInfo: messageInfo }));
}
else if (imgArray[i].type == "video" && imgArray[i].image_src) {
text = text.split("[[link=" + imgArray[i].url + "=link]]").join(this.just.renderSync('message_meta_video', { chatObj: this, meta: imgArray[i], messageInfo: messageInfo }));
}
try {
photoListHtml += this.just.renderSync('message_meta_' + imgArray[i].type, { chatObj: this, meta: imgArray[i], messageInfo: messageInfo })
} catch (e) {
}
}
}
} catch (e) {
}
}
if (photoListHtml != "") {
text += '<div class="role-meta-list">' + photoListHtml + '</div>';
}
if(isCordova()){
text = text.replace(/\[(.*?)\]\((.*?)\)/mg, `<a href='$1' onclick="return openExternalUrl('Перейти на внешний ресурс', this.href, 'Переход на внешний ресурс');">$2</a>`);
} else {
text = text.replace(/\[(.*?)\]\((.*?)\)/mg, "<a href='$1' target='_blank' >$2</a>");
}
return text;
}
/**
*/
roomChat.getMessageTextShort = function (messageInfo) {
var meta = messageInfo.meta;
if (messageInfo.message == 'HELLO_FROM_SUPPORT') {
return gettext("imbachat", messageInfo.message)
}
if (messageInfo.message == 'ROOM_TYPE_GISAVTO_HELPER') {
return gettext("imbachat", messageInfo.message)
}
/**
*/
if (meta && meta.length != 0 && meta[0].type == "file-image") {
return '<span class="send-type-photo"><i class="ion-camera"></i>' + gettext('imbachat', 'send_image') + '</span>'
}
else if (meta && meta.length != 0 && meta[0].type == "file-image-local") {
return '<span class="send-type-photo"><i class="ion-camera"></i>' + gettext('imbachat', 'send_image') + '</span>'
}
else if (meta && meta.length != 0 && meta[0].type == "file-other-local") {
return '<span class="send-type-photo"><i class="ion-camera"></i>' + gettext('imbachat', 'send_file') + '</span>'
}
else if (meta && meta.length != 0 && meta[0].type == "file-file") {
return '<span class="send-type-photo"><i class="ion-camera"></i>' + gettext('imbachat', 'send_file') + '</span>'
}
else if (meta && meta.length != 0 && meta[0].type == "self-geopoint") {
return '<span class="send-type-photo"><i class="ion-camera"></i>' + gettext('imbachat', 'send_geopoint') + '</span>'
}
else if (meta && meta.length != 0 && meta[0].type == "video") {
return '<span class="send-type-video"><i class="ion-ios-videocam"></i>' + gettext('imbachat', 'send_video') + '</span>'
}
else if (/(^https?:\/\/[^ \n\r\t.]+[^ \n\r\t]+)/mg.test(messageInfo.message)) {
return '<span class="send-type-link"><i class="ion-link"></i>' + gettext('imbachat', 'send_link') + '</span>'
}
else if ((meta && meta.length != 0 && meta[0].type == "link") || /(https?:\/\/[^ \n\r\t.]+[^ \n\r\t]+)/mg.test(messageInfo.message)) {
return '<span class="send-type-link"><i class="ion-link"></i>' + (messageInfo.message.length <= 25 ? messageInfo.message : messageInfo.message.slice(0, 25) + '...') + '</span>'
}
else if (meta && meta.length != 0 && meta[0].type == "audio-message") {
return '<span class="send-type-audio"><i class="ion-audio"></i>' + gettext('imbachat', 'send_voice_msg') + '</span>'
}
else if (meta && meta.length != 0 && meta[0].type == "video-message") {
return '<span class="send-type-audio"><i class="ion-videocam"></i>' + gettext('imbachat', 'send_video_msg') + '</span>'
}
else if (meta && meta.length != 0 && meta[0].type == "system") {
if (meta[0].event == "removeFromRoom") {
return gettext("imbachat", "conf_user_left")
}
else if (meta[0].event == "addToRoom") {
return gettext("imbachat", "conf_user_joined")
}
else if (meta[0].event == "newRoom") {
if (meta[0].initiator_id == this.opt.user_id) {
return gettext("imbachat", "user_you_created")
}
if (meta[0].initiator_id == this.opt.user_id) {
return gettext("imbachat", "user_you_created")
}
return gettext("imbachat", "empty_dialog_created")
}
else if (meta[0].event == "makeRoomAdmin") {
return gettext("imbachat", "The administrator has been changed")
}
else if (meta[0].event == "saveRoomSettings") {
return gettext("imbachat", "Renamed the conference")
}
else if (meta[0].event == "call") {
return gettext("imbachat", 'Call started');
}
else if (messageInfo.meta[0].event == "lostCall") {
return gettext("imbachat", 'Missed call');
}
else if (messageInfo.meta[0].event == "callHangup") {
if (meta[0].value) {
return gettext("imbachat", 'Call ended, duration %1s', this.getIntegerToTimeString(meta[0].value))
}
return gettext("imbachat", 'Busy');
}
else if (messageInfo.meta[0].event == "callBusy") {
return gettext("imbachat", 'Busy');
}
else if (messageInfo.meta[0].event == "callOut") {
return gettext("imbachat", 'User has left the call');
}
else {
var text = messageInfo.message
if (this.opt.useEmojione && window.emojione) {
text = window.emojione.unicodeToImage(window.emojione.shortnameToImage(messageInfo.message))
}
return gettext("imbachat", text);
}
}
else if (messageInfo.message) {
var text = messageInfo.message
if (this.opt.useEmojione && window.emojione) {
text = window.emojione.unicodeToImage(window.emojione.shortnameToImage(messageInfo.message))
}
return gettext("imbachat", text);
}
return "";
}
/**
*/
roomChat.markAsRead = function (messageInfo) {
if (!this.chatDB.dataObj.selfInfo || !this.opt.user_id) {
return;
}
if (!messageInfo || !messageInfo.id) {
return;
}
var thisObj = this;
thisObj.apiCall({
reTryInOnline: true,
queue_key: "markAsRead_" + messageInfo.room_id,
type: "POST",
dataType: 'json',
url: thisObj.opt.api_host,
data: {
cultivate: 'roomVideoChat.' + thisObj.opt.URL_markAsRead,
room_id: messageInfo.room_id,
message_id: messageInfo.id,
user_id: thisObj.opt.user_id,
user_key: thisObj.opt.user_key,
},
success: function (res) {
thisObj.ajaxErrorTest(res)
}
});
}
roomChat.apiCall = function (query) {
query.data.user_id = this.opt.user_id
query.data.user_key = this.opt.user_key
return this.spajs.ajax.Call(query)
}
/**
*/
roomChat.isUseSoundInRoom = function (roomId) {
try {
return (window.localStorage['roomVideoChat.useSound.' + roomId] == "1" || window.localStorage['roomVideoChat.useSound.' + roomId] == undefined);
} catch (exception) {
return false;
}
}
roomChat.setUseSoundInRoom = function (roomId, useSound) {
var thisObj = this;
window.localStorage['roomVideoChat.useSound.' + roomId] = useSound / 1
if (useSound / 1) {
jQuery("#roomVideoChat-disable-sound-room" + roomId).show(); jQuery("#roomVideoChat-enable-sound-room" + roomId).hide();
}
else {
jQuery("#roomVideoChat-disable-sound-room" + roomId).hide(); jQuery("#roomVideoChat-enable-sound-room" + roomId).show();
}
}
/**
*/
roomChat.setUseSound = function (useSound) {
try {
window.localStorage['roomVideoChat.useSound'] = useSound / 1
} catch (exception) {
}
var thisObj = this;
if (useSound / 1) {
jQuery(".roomVideoChat-disable-sound").show(); jQuery(".roomVideoChat-enable-sound").hide();
}
else {
jQuery(".roomVideoChat-disable-sound").hide(); jQuery(".roomVideoChat-enable-sound").show();
}
}
/**
*/
roomChat.isUseSound = function () {
try {
return window.localStorage['roomVideoChat.useSound'] == undefined || window.localStorage['roomVideoChat.useSound'] == "1";
} catch (exception) {
return false;
}
}
/**
*/
roomChat.playSound = function (name) {
var thisObj = this;
if (!name || name == '') {
var audio = jQuery(".roomVideoChat-msg-audio.audio-new-message")
if (audio.length > 0) {
audio[0].play();
}
else {
}
return;
}
var audio = jQuery(".roomVideoChat-msg-audio.audio-" + name);
if (audio.length > 0) {
audio[0].play();
}
else {
}
}
/**
*/
roomChat.tryPlaySound = function (roomId, name) {
if (roomId) {
if (this.isUseSound() && this.isUseSoundInRoom(roomId)) {
this.playSound(name);
return true;
}
}
else if (this.isUseSound()) {
this.playSound(name);
return true;
}
return false;
}
/**
*/
roomChat.ajaxErrorTest = function (data) {
if (data && data.error) {
if (data && data.error_unauthorized === true) {
return true;
}
if (data && data.error_credits === true) {
return true;
}
return true;
}
return false;
}
/**
*/
roomChat.isOnline = function () {
return navigator.onLine
}

/**
*/
window.chatDialogsList = {
}
chatDialogsList.render = function()
{
var rooms = imbaChat.getAllRoomInfo()
var html = "";
for(var i in rooms)
{
if(rooms[i].room_type == imbaChat.room_type.dialog
&& imbaChat.isIgnored(imbaChat.getOponentForRoom(rooms[i].room_id).user_id))
{
continue;
}
if(imbaChat.getOponentForRoom(rooms[i].room_id).user_id == imbaChat.opt.deleted_user.user_id)
{
continue;
}
/*if(rooms[i].room_type/1 == 2)
{
debugger;
return "";
}*/
html += this.getContactHtml(rooms[i])
}
if (html == "")
{
html = imbaChat.just.renderSync('chat_left_column_stub', {chatObj:imbaChat});
}
if(rooms.length == 0)
{
imbaChat.showStartPage()
}
return html;
}
/**
* Возвращает html контакта/диалога/конференции для сипска контактов
*/
chatDialogsList.getContactHtml = function(contact)
{
return imbaChat.just.renderSync('contact_item', {chatObj:imbaChat, room:contact});
}
/**
*/
chatDialogsList.upDialogInList = function(roomInfo)
{
jQuery("#"+imbaChat.class_name+"-user-dialog-"+roomInfo.room_id).remove();
jQuery("."+imbaChat.class_name+"-contact-list").prependTpl(this.getContactHtml(roomInfo));
}
tabSignal.connect("chat.updateContactList", function()
{
jQuery("."+imbaChat.class_name+"-contact-list").insertTpl(chatDialogsList.render());
})
tabSignal.connect("loading.completed.chat", function()
{
/*spajs.addMenu({
id:"mobile-chat-contact-list",
urlregexp:[/^mobile-chat-contact-list$/],
onOpen:function(holder, menuInfo, data)
{
debugger;
jQuery(holder).insertTpl("<div class='roomvideochat' ><div class='contact-list' >"+chatDialogsList.render()+"</div></div>");
}
})*/
})

/**
* @author ООО "ИМБАСИНЕРГИЯ", http://imbasynergy.com/
*/
/**
* <script src="https://imbachat.com/imbachat/v1/widget" ></script>
<script>
function loadDemoChat(opt){
if(!window.ImbaChat)
{
return setTimeout(loadDemoChat, 50, opt)
}
window.ImbaChat.load(opt)
}
loadDemoChat({user_id:24817});
</script>
*/
function ImbaChat()
{
let chat = $.extend({}, ImbaChat, window.roomChat);
tabSignal.emit("ImbaChat.new.object", {obj:chat})
return chat;
}
window.ImbaChat = ImbaChat
ImbaChat.version = "1"
/**
*/
ImbaChat.start = function(settings){
return new Promise((resolve, reject) => {
var defaultOpt = {
user_id:11204,
local_user_id:11204,
user_key:undefined,
language:undefined,
imba_id:0,
holder:"body",
useFaviconBadge:false,
theme: "default",
onInitSuccess:()=>{
resolve()
},
position: "right", // left | right
api_url:window.location.protocol+"//"+window.location.hostname,
sounds:[
],
cppcomet:{
dev_id:15,
node:"app.comet-server.ru",
},
onAuthFalill:function(){
},
resizable: true,
draggable: true,
style: {
width: '830px',
height: '480px',
'z-index': '100000',
position: 'fixed',
bottom: '10px',
right: '10px',
}
}
settings = $.extend(true, {}, defaultOpt, window.imbaChatSettings, settings)
settings.api_url = settings.api_url+"/v1/"+settings.imba_id+"/"
this.api_url = settings.api_url
let thisObj = this
$(settings.holder).append("<div id='imbachat' class='" + settings.theme + " " + settings.position + "'></div>")
settings.holder = "#imbachat"
if(settings.token)
{
settings.user_key = settings.token
}
else if(settings.key)
{
settings.user_key = settings.key
}
if(!settings.user_key)
{
this.getAuthDebugToken(settings)
.then(()=>{
thisObj.getSelfId(settings)
.then((data)=>{
thisObj.preload(settings).then(()=>{
thisObj.pre_init(settings)
resolve()
})
})
})
.catch((err) => {
reject(err)
})
} else {
this.getSelfId(settings)
.then(()=>{
thisObj.preload(settings).then(()=>{
thisObj.pre_init(settings)
resolve()
})
})
.catch((err) => {
reject(err)
})
}
});
}
/**
*/
ImbaChat.pre_init = function(settings){
if(settings.cppcomet)
{
if(settings.onAuthFalill)
{
cometApi.onAuthFalill(function(new_settings)
{
if(!new_settings || new_settings.error)
{
window.imbaLog.error("Error in auth", new_settings)
return;
}
cometApi.restart({
dev_id: new_settings.cppcomet.dev_id,
user_id: new_settings.user_id,
user_key: new_settings.user_key,
node: new_settings.cppcomet.node
});
})
}
cometApi.UseWss(true);
/**
*/
cometApi.start({
dev_id: settings.cppcomet.dev_id,
user_id: settings.user_id,
user_key: settings.user_key,
node: settings.cppcomet.node
});
}
let chatsettings = $.extend({}, settings, {
user_id:settings.user_id,
user_key:settings.user_key,
api_host:this.api_url,
post:{
language: settings.language
},
holder:settings.holder,
sounds:settings.sounds
})
this.init(chatsettings)
this.render()
}
/**
*/
ImbaChat.preload = function(opt){
return new Promise(function(resolve, reject)
{
if(window.roomVideoChat_html_loaded)
{
resolve()
return;
}
if(window.isCordova && window.isCordova()){
setInterval(() => {
if(window.roomVideoChat_html_loaded){
resolve()
}
}, 200);
return;
}
let api_url = opt.api_url+""
if(api_url.indexOf("/v1/") == -1)
{
api_url = api_url+"/v1/"
}
if(!/v1\/[0-9]+\/([0-9]+\/)?/.test(api_url))
{
api_url = api_url+"0/"
}
$.ajax({
url: api_url + "tpl",
data: "",
success: (data) => {
$("body").append(data);
resolve()
},
error:(err) => {
reject()
}
});
})
}
/**
*/
if(!window.imbaChatSettings)
{
window.imbaChatSettings = {}
}
/**
*/
ImbaChat.destroy =function(){
$("#imbachat").remove()
if(window.cometApi)
{
window.cometApi.unsubscriptionAll()
window.cometApi.stop();
}
if(window.imbaChat && window.imbaChat.spajs)
{
window.imbaChat.spajs.removeAllNavigation()
}
}
/**
*/
ImbaChat.getSelfId = function(opt){
if(!opt.external_api_token){
opt.external_api_token = opt.user_key
}
return new Promise((resolve, reject) => {
if(opt.standalone_mode == true){
opt.user_id = opt.user_id;
opt.user_key = opt.user_key;
resolve()
} else {
$.ajax({
url: this.api_url + "self-id",
data: "user_id="+encodeURIComponent(opt.user_id)+"&external_api_token="+encodeURIComponent(opt.external_api_token),
success: (data) =>{
opt.user_key = data.imba_user_token
opt.user_id = data.imba_user_id
resolve()
},
error:(err) => {
reject(err)
}
});
}
});
}
/**
*/
ImbaChat.getAuthDebugToken = function(opt){
window.imbaLog.warn("Чат запущен в режиме отладки без корректной проверки авторизации!")
return new Promise((resolve, reject) => {
$.ajax({
url: this.api_url + "token",
data: "user_id="+opt.user_id,
success: (data) =>{
if(opt.standalone_mode == true){
opt.user_key = data
} else {
opt.external_api_token = data
}
resolve()
},
error:(err) => {
reject(err)
}
});
});
}
/**
*/
ImbaChat.load = function(imbaChatSettings){
if(window.imbaChat)
{
ImbaChat.destroy()
}
if(imbaChatSettings.user_id <= 0)
{
return;
}
window.imbaLog.log("ImbaChat.load", imbaChatSettings)
window.imbaChat = new ImbaChat();
window.roomVideoChat = window.imbaChat
return window.imbaChat.start(imbaChatSettings);
}
tabSignal.on("imbaChat.getRoomTitle", (args) => {

    if (args.roomInfo.profiles[args.chatObj.opt.user_id] != args.chatObj.opt.user_id) {
        // Название филиала, в который пишут сообщение
        let name = args.chatObj.getUserInfoById(args.chatObj.opt.user_id, args.roomInfo.room_id).name
        if (!name) {
            return '';
        }

        return '<div class="room_in_list__description-filial">Филиал '
            + JustEscapeHtml(name)
            + '</div>'
    }

    return ''
})

tabSignal.on("imbaChat.getRoomName", (args) => {

    if (!window.imbaSupport) {
        // Мы в админке тут этот функционал не нужен
        if (args.roomInfo.room_type == 4 && $.inArray(imbaChat.chatDB.dataObj.selfInfo.chat_role, ['user', 'guest']) != -1) { return gettext('imbachat', 'TITLE_FROM_GISAVTO_HELPER') }
        if (args.roomInfo.room_type == 3 && $.inArray(imbaChat.chatDB.dataObj.selfInfo.chat_role, ['user', 'guest']) != -1) { return gettext('imbachat', 'TITLE_FROM_SUPPORT') }
    }

    var info = args.chatObj.getOponentForRoom(args.roomInfo.room_id)
    if (info.user_id == args.chatObj.opt.user_id) {
        return;
    }

    if (info.userInfo.chat_role == "guest") {
        var name = info.name
        if (info.contact_phone) {
            name += "( " + info.contact_phone + " )"
        }
        else if (info.userInfo.contact_phone) {
            name += "( " + info.userInfo.contact_phone + " )"
        }

        return JustEscapeHtml(name);
    }
    else {
        return info.name
    }
})

tabSignal.on("imbaChat.updateRoomsInfo", (arg) => {

    if (!window.imbaSupport && arg.roomInfo.type == arg.chatObj.room_type.support) {
        arg.roomInfo.avatar_url = arg.chatObj.opt.support_avatar_url
        if (arg.chatObj.last_imbasupport_status) {
            arg.roomInfo.online_status = arg.chatObj.last_imbasupport_status.imbasupport_type_concierge > 0
        }
        else {
            arg.roomInfo.online_status = false
        }
    }

    if (!window.imbaSupport && arg.roomInfo.type == arg.chatObj.room_type.concierge) {
        arg.roomInfo.avatar_url = arg.chatObj.opt.concierge_avatar_url
        if (arg.chatObj.last_imbasupport_status) {
            arg.roomInfo.online_status = arg.chatObj.last_imbasupport_status.imbasupport_type_support > 0
        }
        else {
            arg.roomInfo.online_status = false
        }
    }

    if (!window.imbaSupport && arg.roomInfo.type == arg.chatObj.room_type.bot) {
        arg.roomInfo.avatar_url = arg.chatObj.opt.bot_avatar_url
        if (arg.chatObj.last_imbasupport_status) {
            arg.roomInfo.online_status = arg.chatObj.last_imbasupport_status.imbasupport_type_support > 0
        }
        else {
            arg.roomInfo.online_status = false
        }
    }
})


tabSignal.on("imbaChat.getAvatarHTML", (arg) => {

    if (window.imbaSupport) {
        // Мы в админке там этот функционал не нужен
        return;
    }

    if (arg.roomInfo.type == arg.chatObj.room_type.support) {
        arg.roomInfo.avatar_url = arg.chatObj.opt.support_avatar_url
    }
    if (arg.roomInfo.type == arg.chatObj.room_type.concierge) {
        arg.roomInfo.avatar_url = arg.chatObj.opt.concierge_avatar_url
    }
    if (arg.roomInfo.type == arg.chatObj.room_type.bot) {
        arg.roomInfo.avatar_url = arg.chatObj.opt.bot_avatar_url
    }
})

/**
 * Удаление диалога
 * @param {Ineger} room_id
 * @public
 */
roomChat.confirmDeleteDialog = function (room_id, room_id_name, room_type = 0) {
    $('.roomVideoChat-message-modal-preloader').hide();
    $('.roomVideoChat-modal-content').css({ 'opacity': '1', 'pointer-events': 'auto' });
    $('.roomVideoChat-confirm-delete-dialog').show();
    if (room_type == 5) {
        $('.roomVideoChat-modal__title').text('Вы точно хотите скрыть переписку с ' + room_id_name + '?');
        $('.roomVideoChat-modal__text').text('Будут скрыты все сообщения и файлы');
        $('button.js-delete-dialog').text('Скрыть');
    } else {
        $('.roomVideoChat-modal__title').text('Вы точно хотите удалить переписку с ' + room_id_name + '?');
        $('.roomVideoChat-modal__text').text('Будут удалены все сообщения и файлы');
        $('button.js-delete-dialog').text('Удалить');
    }
    $('.roomVideoChat-confirm-delete-dialog .js-delete-dialog').click(function () {
        $('.roomVideoChat-modal-content').css({ 'opacity': '0.3', 'pointer-events': 'none' });
        $('.roomVideoChat-message-modal-preloader').show();
        window.imbaChat.confirmDeleteDialogHide();
        window.imbaChat.deleteDialog(room_id);
    });
}
roomChat.confirmDeleteDialogHide = function () {
    $('.roomVideoChat-confirm-delete-dialog').hide();
}


roomChat.openRoomWithConcierge = function () {
    for (var i in this.opt.rooms) {

        var val = this.opt.rooms[i]
        if (val.room_type == this.room_type.concierge) {
            return this.openRoomForce(val.room_id)
        }
    }

    return true
}

roomChat.openRoomWithSupport = function () {
    for (var i in this.opt.rooms) {

        var val = this.opt.rooms[i]
        if (val.room_type == this.room_type.support) {
            return this.openRoomForce(val.room_id)
        }
    }

    return true
}


roomChat.last_imbasupport_status = undefined
roomChat.getSupportStatus = function (event, type) {
    let thisObj = this;
    this.apiCall({
        reTryInOnline: true,
        queue_key: "imbasupport-status",
        url: this.opt.api_host + "imbasupport-status",
        type: "POST",
        dataType: 'json',
        data: {},
        success: function (data) {
            thisObj.updateSupportStatus(data)
        },
    });
}

roomChat.updateSupportStatus = function (imbasupport_status) {
    if (window.imbaSupport) {
        // Мы в админке там этот функционал не нужен 
        return;
    }

    this.last_imbasupport_status = imbasupport_status;
    if (imbasupport_status.imbasupport_type_concierge > 0) {

        $(".type_concierge-offline-alert").hide()
        $(".room-type-id4").removeClass('roomVideoChat-all-offline')
        $(".room-type-id4").addClass('roomVideoChat-somebody-online')

        $(".room-type-id4 .room_in_list__avatar-preview").removeClass('offline')
        $(".room-type-id4 .room_in_list__avatar-preview").addClass('online')

        $(".roomVideoChat-head-of-4").removeClass('offline')
        $(".roomVideoChat-head-of-4").addClass('online')
    }
    else {
        $(".type_concierge-offline-alert").show()
        $(".room-type-id4").addClass('roomVideoChat-all-offline')
        $(".room-type-id4").removeClass('roomVideoChat-somebody-online')

        $(".room-type-id4 .room_in_list__avatar-preview").addClass('offline')
        $(".room-type-id4 .room_in_list__avatar-preview").removeClass('online')

        $(".roomVideoChat-head-of-4").addClass('offline')
        $(".roomVideoChat-head-of-4").removeClass('online')
    }

    if (imbasupport_status.imbasupport_type_support > 0) {
        $(".type_support-offline-alert").hide()
        $(".room-type-id3").removeClass('roomVideoChat-all-offline')
        $(".room-type-id3").addClass('roomVideoChat-somebody-online')

        $(".room-type-id3 .room_in_list__avatar-preview").removeClass('offline')
        $(".room-type-id3 .room_in_list__avatar-preview").addClass('online')

        $(".roomVideoChat-head-of-3").removeClass('offline')
        $(".roomVideoChat-head-of-3").addClass('online')
    }
    else {
        $(".type_support-offline-alert").show()
        $(".room-type-id3").addClass('roomVideoChat-all-offline')
        $(".room-type-id3").removeClass('roomVideoChat-somebody-online')

        $(".room-type-id3 .room_in_list__avatar-preview").addClass('offline')
        $(".room-type-id3 .room_in_list__avatar-preview").removeClass('online')

        $(".roomVideoChat-head-of-3").addClass('offline')
        $(".roomVideoChat-head-of-3").removeClass('online')
    }
}

tabSignal.on("imbaChat.loaded", (arg) => {

    arg.chatObj.getSupportStatus();

    if (arg.chatObj.opt.openRoomWithConcierge) {
        arg.chatObj.openRoomWithConcierge()
        return true;
    }

    if (arg.chatObj.opt.openRoomWithSupport) {
        arg.chatObj.openRoomWithSupport()
        return true;
    }
})


roomChat.openRoomForce = function (roomId, trys = 10) {
    if (!this.getRoomInfoById(roomId)) {
        if (trys < 0) {
            //    window.imbaLog.log("Try openRoomForce fail")
            return false;
        }

        setTimeout(() => {
            //    window.imbaLog.log("Try openRoomForce", trys)
            this.openRoomForce(roomId, trys - 1)
        }, 1000)
        return false;
    }

    //   window.imbaLog.log("Now openRoomForce")
    this.openRoom(roomId)
    this.openChat();
    if(window.preloader)
        window.preloader.close();
}

guiToast = {
    options: {
        title: "Head default",
        message: "Text default",
        buttons: [],
    },
    show: function (opt) {
        let local_options = {};
        for (var i in this.options) {
            local_options[i] = this.options[i]
        }
        if (opt !== undefined) {
            for (var i in opt) {
                local_options[i] = opt[i]
            }
        }

        let modal = $('.roomVideoChat-modal-standart');
        modal.show();
        modal.find('.roomVideoChat-modal__title').text(local_options.title);
        modal.find('.roomVideoChat-modal__text').text(local_options.message);
        let tegButton = '';
        $.each(local_options.buttons, function (key, data) {
            tegButton = '<button data-btntype="close" class="roomVideoChat-btn-blue-circle" onclick="guiToast.setAction(' + data["action"] + ')">' + data["name"] + '</button>'
            modal.find('.roomVideoChat-modal__btn-group').append(tegButton);
        });
    },
    setAction: function (action) {
        action;
        guiToast.hide();

    },
    hide: function () {
        let modal = $('.roomVideoChat-modal-standart');
        modal.find('.roomVideoChat-modal__btn-group').html('');
        modal.hide();
    }
};

cometApi.subscription("imbasupportWorkers.count", function (event) {
    imbaChat.updateSupportStatus(event.data)
})

tabSignal.on('imbaChat.onlineSupportStatus', () => {
    imbaChat.getSupportStatus()
})

tabSignal.on('imbaChat.offlineSupportStatus', (status) => {
    imbaChat.updateSupportStatus(status)
})






//--------
 // /ImbaSynergy.ImbaChat.remoteWidget.js
//--------



}; _ImbaChatAPIinit()
//getWidgetData loaded from backend cache