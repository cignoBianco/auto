define(["jquery"],function(e){function t(t,a){t=t||0,a=a||!1,e.ajax({url:Routing.generate("set_web_current_location_ajax",{location:t}),type:"POST",dataType:"json",data:{locationId:t,autoDetectLocation:a},timeout:1e4,success:function(e){location.reload()}})}function a(){var t=e(".modal-select-regions__item.active").data("targetPane"),a=e(".modal-select-countries__item_active").data("targetCountry");e(".tab-content-cities").hide().filter('[data-country-id="'+a+'"]').show().find(".tab-pane").removeClass("active").filter('[data-pane="'+t+'"]').addClass("active")}function i(a){var i=a.data("id"),o=a.data("regionId");a.data("countryId"),i===o?t(i,!1):e(".modal-select-regions__row_city").filter('[data-target-city="'+i+'"]').length?t(i,!1):e.ajax({url:Routing.generate("find_nearby_cities"),dataType:"json",type:"POST",timeout:1e4,data:{cityId:i},success:function(t){if(!t.success)return!1;e("#nearbyCities").empty(),e.each(t.data.cities,function(){e("#nearbyCities").append(e("<a href='#' class='aqualink' data-city-id='"+this.id+"'>"+this.name+"</a><br>")).closest(".hint-white").show()})}})}function o(t){var a,i=e(".modal-select-regions__row_city").filter('[data-target-city="'+t+'"]'),o=e(".modal-select-regions__row_region").filter('[data-target-region="'+t+'"]'),s=e(".modal-select-countries__item").filter('[data-target-country="'+t+'"]');0===t?(e("#select-all-countries").addClass("selected"),e(".all-countries-cities").show(),e(".modal-select-countries__item").addClass("modal-select-countries__item_active")):i.length?(a=i.closest(".tab-content-cities").data("countryId"),e(".modal-select-countries__block").find('[data-target-country="'+a+'"]').click(),i.addClass("modal-select-regions__row_active")):o.length?(a=o.closest(".tab-content-cities").data("countryId"),e(".modal-select-countries__block").find('[data-target-country="'+a+'"]').click(),e('[data-target-pane="regions"]').click(),o.parent().find(".modal-select-regions__row_city, .modal-select-regions__row_region").addClass("modal-select-regions__row_active")):s.length&&(e(".modal-select-countries__item").filter('[data-target-country="'+t+'"]').click(),e(".modal-select-regions__checkbox").find(".btn-checkbox").addClass("selected"),e(".tab-content-cities").filter('[data-country-id="'+t+'"]').find('[data-pane="cities"]').find(".modal-select-regions__row_city").addClass("modal-select-regions__row_active"))}function s(e,t,a,i){return e=Math.abs(e),(e%=100)>=5&&e<=20?i:1==(e%=10)?t:e>=2&&e<=4?a:i}function c(){setTimeout(function(){e(".gm-style-iw").prev().find("div").last().addClass("gm-popup").prev().find("div").find("div").addClass("gm-popup-pointer")},10)}function n(e){return function(){t(e,!1)}}var l;e(function(){e("#modalSelectCity").on("show.bs.modal",function(t){e(".modal-select-regions__content").perfectScrollbar({suppressScrollX:!0})}),e("#modalSelectCity .fast-search-anim").on("click",function(){e("#formSetCity .search-input").addClass("animated").delay(500).queue(function(){e(this).removeClass("animated").dequeue()})}),e("#modalSelectCity .fast-search-anim").on("click",function(){e("#formSetCity .ico-search").addClass("animated").delay(500).queue(function(){e(this).removeClass("animated").dequeue()})}),e("#modalSelectCity").on("click",".auto-define-selection",function(){parseInt(e(this).data("select"))&&t(parseInt(e("#auto-define-city").data("id")),!0),e("#auto-define-modal-block").hide(),e("#allowGeo").prop("checked",!1).trigger("refresh")}),e(document).on("click",".nearest-cities a",function(){t(e(this).data("id"),!1)}),e(document).on("click","#search-relevant-city-result li",function(){i(e(this)),e("#search-relevant-city-result").hide()}),e(document).on("change","#allowGeo",function(){if(!e(this).is(".selected"))return e.cookie("autoDetectLocation",0),void e("#auto-define-modal-block").hide();e.cookie("autoDetectLocation",1);var t=e.cookie("cityNameByIp"),a=e.grep(l,function(e){return e.has_items&&e.name.toLowerCase().match("^"+t.toLowerCase())}),i=e.grep(l,function(e){return e.name.toLowerCase().match("^"+t.toLowerCase())});if(void 0!==a&&a.length){var o=a[0];e("#auto-define-city").attr("data-id",o.id).html(o.name),e("#auto-define-modal-block").show()}else if(void 0!==i&&i.length){var s=i[0].near_cities;$lis="";for(var c in s)$lis+='<li><a href="#" data-id="'+s[c].id+'">'+s[c].name+"</a></li>";e(".nearest-cities").html($lis),e(".city-not-found").addClass("with-nearest").show()}else e(".autodetect-city-not-found").show()}),e("#set-autodetected-city").on("click",function(){t(e(this).attr("data-content"),!0)}),e(document).on("click","#city-tabs-block .setCity",function(){var a=e(this).data("id"),i=e(this);e("#city-tabs-block .setCity").removeClass("bold"),e('.select-all-cities input[type="checkbox"]').removeAttr("checked"),t(a,!1),i.addClass("bold")}),e(document).on("click",".btnOpenCity",function(){"undefined"!=typeof yaCounter45455697&&yaCounter45455697.reachGoal("search_sity"),e.ajax({url:Routing.generate("get_cities_data"),dataType:"json",success:function(e){l=e}}),e("#modalSelectCity .city_lst .bold").popover("show"),void 0===e.cookie("cityNameByIp")&&e.ajax({type:"POST",url:Routing.generate("detect_city_name_by_ip")}),e.ajax({url:Routing.generate("get_modal_city"),type:"POST",dataType:"json",timeout:1e4,success:function(t){if(!t.success)return!1;e("#modalSelectCity").empty().append(t.data.html).modal("show"),e("#mapPane div").length||(require("GoogleMapApi"),require("GoogleMapClusterer"),e("#mapPane").empty(),e.ajax({url:Routing.generate("get_web_city_list_for_map_ajax"),dataType:"json",type:"POST",timeout:1e4,success:function(t){if(!t.success)return!1;var a=t.data.cities,i=t.data.currentLocationParams,l={lat:61.52401,lng:105.318756},r=4;if(i)switch(o(i.id),l={lat:i.coord_lat,lng:i.coord_lng},i.level){case 0:r=390===i.id?2:4;break;case 1:r=6;break;default:r=10}else{var d=e("#currentCountryName");d.length&&(l={lat:d.data("coordLat"),lng:d.data("coordLng")},r=390==d.data("countryId")?2:4),o(0)}var u=new google.maps.Map(document.getElementById("mapPane"),{zoom:r,center:l,mapTypeControl:!1});u.addListener("tilesloaded",c);var m={};for(var h in a){var g=a[h],_="/bundles/gisautoweb/images/city.png",y="/bundles/gisautoweb/images/city_hover.png";m.hasOwnProperty(g.country_id)||(m[g.country_id]=[]);var v='<div class="map-city-card-marker"><div class="city-name">г.&nbsp;'+g.name+'</div><div class="sellers-count">'+g.shop_count+"&nbsp;"+s(g.shop_count,"продавец","продавца","продавцов")+"</div></div>",f=new google.maps.InfoWindow({content:v}),p=new google.maps.Marker({position:{lat:parseFloat(g.coord_lat),lng:parseFloat(g.coord_lng)},icon:_,map:u});i&&g.id===i.id?(p.setOptions({icon:"/bundles/gisautoweb/images/mark-active.png",label:""}),f.open(u,p),setTimeout(function(){e(".info-bubble").parent().css({width:"auto",height:"auto",overflow:"hidden"})},10),_="/bundles/gisautoweb/images/mark-active.png",y="/bundles/gisautoweb/images/mark-active.png"):(google.maps.event.addListener(p,"mouseover",function(t,a,i,o,s){return function(){t.setOptions({icon:{url:o,anchor:void 0}}),c(),a.open(i,t),setTimeout(function(){e(".info-bubble").parent().css({width:"auto",height:"auto",overflow:"hidden"})},10)}}(p,f,u,y)),google.maps.event.addListener(p,"mouseout",function(e,t,a){return function(){e.setOptions({icon:a}),t.close()}}(p,f,_))),google.maps.event.addListener(p,"click",n(a[h].id)),m[g.country_id].push(p)}for(var C in m)m.hasOwnProperty(C)&&new MarkerClusterer(u,m[C],{styles:[{height:21,width:21,url:"/bundles/gisautoweb/images/1_city.png",textColor:"white",textSize:14},{height:26,width:26,url:"/bundles/gisautoweb/images/3_city.png",textColor:"white",textSize:14},{height:36,width:36,url:"/bundles/gisautoweb/images/4_city.png",textColor:"white",textSize:14}],gridSize:150,maxZoom:15,averageCenter:!0})}}))}})}),e("#modalSelectCity").on("click",".modal-select-countries__item",function(){e(".modal-select-countries__item").removeClass("modal-select-countries__item_active"),e(this).addClass("modal-select-countries__item_active"),e("#select-all-countries").removeClass("selected"),e(".all-countries-cities").hide(),e(".all-countries-regions").hide(),e(".modal-select-regions__checkbox").find(".btn-checkbox").removeClass("selected"),a()}),e("#modalSelectCity").on("change","#select-all-countries",function(){e(".modal-select-countries__item").toggleClass("modal-select-countries__item_active",e(this).hasClass("selected")),e(this).hasClass("selected")?t(0,!1):e(".all-countries-block").find(".modal-select-regions__row").removeClass("modal-select-regions__row_active").end().find(".select-all-countries").removeClass("selected")}),e("#modalSelectCity").on("click",".modal-select-regions__row_city",function(){t(e(this).data("targetCity"),!1)}),e("#modalSelectCity").on("change","#select-all-cities",function(){e(".modal-select-regions__row_city").toggleClass("modal-select-regions__row_active",e(this).hasClass("selected"))}),e("#modalSelectCity").on("click",".modal-select-regions__item",function(){e(".modal-select-regions__item").removeClass("active"),e(this).addClass("active"),e(".all-countries-block").hide(),e(".modal-select-countries__item.modal-select-countries__item_active").length&&!e("#select-all-countries").hasClass("selected")?a():e(".all-countries-"+e(this).data("targetPane")).show()}),e("#modalSelectCity").on("click",".modal-select-regions__row_region",function(){t(e(this).data("targetRegion"),!1)}),e("#modalSelectCity").on("change",".modal-select-regions__checkbox .select-all-countries, .modal-select-regions__checkbox .select-all-cities",function(){e(this).hasClass("selected")?e(".modal-select-countries__item.modal-select-countries__item_active").length&&!e("#select-all-countries").hasClass("selected")?t(e(".modal-select-countries__item_active").data("targetCountry"),!1):t(0,!1):e(".modal-select-regions__row").removeClass("modal-select-regions__row_active")}),e("#modalSelectCity").on("click","#nearbyCities a",function(){t(e(this).data("city-id"),!1)}),e(document).on("mouseover","#modalSelectCity .results ul li",function(){e("#modalSelectCity .results ul li").removeClass("active-choise"),e(this).addClass("active-choise")}),e(document).on("mouseout","#modalSelectCity .results ul li",function(){e(this).removeClass("active-choise")}),e(document).on("click",".modal-select__magnifier",function(){i(e("#search-relevant-city-result .active-choise")),e("#search-relevant-city-result").hide()}),e(document).on("keydown","#search-relevant-city",function(t){if(38===t.which||40===t.which||13===t.which){var a=e("#search-relevant-city-result .active-choise");if(a.length){var o=a.prev().length?a.prev():e("#search-relevant-city-result li").last(),s=a.next().length?a.next():e("#search-relevant-city-result li").first();switch(t.which){case 38:t.preventDefault(),a.removeClass("active-choise"),o.addClass("active-choise");break;case 40:t.preventDefault(),a.removeClass("active-choise"),s.addClass("active-choise");break;case 13:t.preventDefault(),i(e("#search-relevant-city-result .active-choise")),e("#search-relevant-city-result").hide()}}else(a=e("#search-relevant-city-result li").first()).addClass("active-choise")}}),e(document).on("input","#search-relevant-city",function(){var t=e(this).val();if(new RegExp("("+t+")","ig"),e(".city-not-found,.autodetect-city-not-found").removeClass("with-nearest").hide(),""==t)return e("#search-relevant-city-result").hide(),e("#search-relevant-city-result ul").empty(),!1;var a=e.grep(l,function(e){return e.has_items&&e.name.toLowerCase().match("^"+t.toLowerCase())}),i=e.grep(l,function(e){return e.name.toLowerCase().match("^"+t.toLowerCase())});if(void 0!==a&&a.length){e("#search-relevant-city-result").show();var o="";for(var s in a)o+='<li data-id="'+a[s].id+'">'+a[s].name+"</li>";e("#search-relevant-city-result ul").empty().append(o),e("#search-relevant-city-result ul li").first().addClass("active-choise"),e(".nearby-city-list").hide()}else if(void 0!==i&&i.length){e("#search-relevant-city-result").hide(),$lis="";var c=i[0].near_cities;for(var s in c)$lis+='<li><a href="#" data-city-id="'+c[s].id+'">'+c[s].name+"</a></li>";e("#nearbyCities").html($lis),e(".nearby-city-list").show()}else e(".city-not-found").removeClass("with-nearest").show(),e("#search-relevant-city-result").hide()}),e(document).on("focus","#search-relevant-city",function(){e("#search-relevant-city-result ul li").length&&e("#search-relevant-city-result").show()})})});